{% extends "base.html" %}

{% block title %}QR Kod Oluşturucu{% endblock title %}

{% block content %}
<main class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8 py-10">
    <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-white">QR Kod Oluşturucu</h1>
        <p class="mt-2 text-gray-400">Metin gir → renk seç → oluştur → indir.</p>
    </div>

    <div id="status-bar" class="glass rounded-2xl p-4 mb-6 flex items-center justify-between border border-white/5">
        <div class="flex items-center gap-3">
            <span id="status-icon" class="h-2 w-2 rounded-full bg-gray-500 animate-pulse"></span>
            <div id="limit-info" class="text-sm text-gray-300">Limitler kontrol ediliyor...</div>
        </div>
        <div class="text-xs text-gray-500">QR</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <section class="glass rounded-2xl p-6">
            <label class="block text-sm text-gray-400 mb-2">URL veya Metin</label>
            <input id="qrText" class="w-full bg-[#02040a] border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-amber-500/60 transition" placeholder="https://ornek.com" />

            <div class="mt-5">
                <div class="text-sm font-bold text-white mb-3">Renk</div>
                <div class="flex gap-3">
                    <button class="clr h-10 w-10 rounded-full bg-black border-2 border-amber-500" data-color="black" aria-label="Siyah"></button>
                    <button class="clr h-10 w-10 rounded-full bg-blue-600 border-2 border-white/10 hover:border-blue-400 transition" data-color="blue" aria-label="Mavi"></button>
                    <button class="clr h-10 w-10 rounded-full bg-red-600 border-2 border-white/10 hover:border-red-400 transition" data-color="red" aria-label="Kırmızı"></button>
                </div>
            </div>

            <button id="genBtn" class="mt-6 w-full py-3 rounded-xl bg-amber-500 hover:bg-amber-600 text-black font-bold transition">
                Oluştur
            </button>
        </section>

        <section class="glass rounded-2xl p-6 flex flex-col items-center justify-center">
            <div class="w-64 h-64 bg-white rounded-2xl overflow-hidden flex items-center justify-center border border-white/10">
                <img id="qrImage" src="https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=BotlabTools" alt="QR Önizleme" class="max-w-full" />
            </div>
            <a id="downloadBtn" href="#" download="qrcode.png" class="mt-4 text-xs font-bold text-amber-300 hover:text-amber-200 underline hidden">İndir (PNG)</a>
        </section>
    </div>
</main>

<script>
    let selectedColor = 'black';
    let userAllowed = false;

    async function checkLimit() {
        try {
            const res = await fetch('/api/check_tool_status/generator/qr');
            const data = await res.json();
            userAllowed = data.allowed;
            const limitInfo = document.getElementById('limit-info');
            const statusIcon = document.getElementById('status-icon');

            if(data.allowed) {
                statusIcon.className = "h-2 w-2 rounded-full bg-green-500";
                limitInfo.innerHTML = `Kalan Hakkınız: <span class="text-green-400 font-bold">${data.premium ? 'Sınırsız' : data.left}</span>`;
            } else {
                statusIcon.className = "h-2 w-2 rounded-full bg-red-500";
                limitInfo.innerHTML = `⛔ Limit Doldu. <a onclick="openModal('premiumModal')" class="text-blue-400 cursor-pointer">Premium Al</a>`;
            }
        } catch(e) {}
    }

    // renk seçimi (prototip görünümü)
    document.querySelectorAll('.clr').forEach(b => b.addEventListener('click', () => {
        selectedColor = b.dataset.color;
        document.querySelectorAll('.clr').forEach(x => x.classList.remove('border-amber-500'));
        b.classList.add('border-amber-500');
    }));

    async function generateQR() {
        const text = document.getElementById('qrText').value;
        if(!text) return alert("Lütfen metin girin.");
        if(!userAllowed) return openModal('premiumModal');

        try {
            const res = await fetch('/api/qr_generator', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ text, color: selectedColor })
            });
            const data = await res.json();

            if(data.success) {
                const src = "data:image/png;base64," + data.file;
                document.getElementById('qrImage').src = src;
                const dl = document.getElementById('downloadBtn');
                dl.href = src;
                dl.classList.remove('hidden');
                checkLimit();
            } else {
                alert("Hata: " + data.reason);
                if(data.reason === 'limit') openModal('premiumModal');
            }
        } catch(e) { alert("Hata oluştu."); }
    }

    document.getElementById('genBtn').addEventListener('click', generateQR);
    document.addEventListener('DOMContentLoaded', checkLimit);
</script>
{% endblock content %}
