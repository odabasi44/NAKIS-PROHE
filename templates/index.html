<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Vektörleştirici</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #f5f5f5;
        }

        /* ÜST BAR */
        #topBar {
            background: #222;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #topBar button {
            background: #4caf50;
            color: white;
            padding: 7px 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #premiumLabel {
            background: #f39c12;
            padding: 5px 10px;
            border-radius: 5px;
            margin-left: 10px;
        }

        /* LOGIN MODAL */
        #loginModal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            background: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }

        #loginBox {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
        }

        #loginBox input {
            width: 90%;
            padding: 8px;
            margin-bottom: 15px;
        }

        /* Ana uygulama container */
        #appContainer {
            padding: 30px;
            text-align: center;
        }

        #whatsappBox {
            margin-top: 20px;
        }

        #whatsappBox a {
            background: #25d366;
            color: white;
            padding: 10px 18px;
            display: inline-block;
            border-radius: 6px;
            font-size: 18px;
            text-decoration: none;
        }
    </style>
</head>

<body>

<!-- ÜST BAR -->
<div id="topBar">
    <div id="userStatus">Yükleniyor...</div>

    <div>
        <button id="loginBtn" onclick="openLogin()">Giriş Yap</button>
        <button id="logoutBtn" onclick="logout()" style="display:none; background:#e74c3c;">Çıkış Yap</button>
    </div>
</div>

<!-- LOGIN MODAL -->
<div id="loginModal">
    <div id="loginBox">
        <h2>Giriş Yap</h2>
        <input id="loginEmail" type="email" placeholder="Mail adresiniz">
        <button onclick="login()">Giriş Yap</button>
        <br><br>
        <button onclick="closeLogin()" style="background:#555;">Kapat</button>
    </div>
</div>

<!-- ANA UYGULAMA ALANI -->
<div id="appContainer">

    <h1>Vektörleştirici</h1>

    <p>Kalan ücretsiz hak: <span id="freeRemaining">-</span></p>
    <p id="premiumCountdown" style="color:#e67e22; font-weight:bold;"></p>

    <input type="file" id="uploadInput"><br><br>

    <button onclick="processImage()">Vektörleştir</button>

    <div id="whatsappBox" style="display:none;">
        <h3>Ücretsiz hakkınız doldu.</h3>
        <a target="_blank"
           id="waBtn"
           href="https://wa.me/905555555555?text=Aylık+vektör+üyeliği+satın+almak+istiyorum">
            WhatsApp ile Aylık Üyelik Satın Al
        </a>
    </div>

    <br><br>
    <img id="resultImage" style="max-width: 600px;">
</div>

<script>
/* ----------------------------------------------------
   LOGIN AÇ / KAPAT
---------------------------------------------------- */
function openLogin() { document.getElementById("loginModal").style.display = "flex"; }
function closeLogin() { document.getElementById("loginModal").style.display = "none"; }

/* ----------------------------------------------------
   API: GİRİŞ YAP
---------------------------------------------------- */
async function login() {
    const email = document.getElementById("loginEmail").value;

    const res = await fetch("/login", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({email})
    });

    const data = await res.json();

    if (data.success) {
        closeLogin();
        loadUserStatus();
    } else {
        alert(data.message);
    }
}

/* ----------------------------------------------------
   API: ÇIKIŞ
---------------------------------------------------- */
async function logout() {
    await fetch("/logout", {method: "POST"});
    loadUserStatus();
}

/* ----------------------------------------------------
   KULLANICI DURUMUNU YÜKLE
---------------------------------------------------- */
async function loadUserStatus() {
    const res = await fetch("/user_status");
    const data = await res.json();

    const statusDiv = document.getElementById("userStatus");
    const freeSpan = document.getElementById("freeRemaining");
    const premiumCountdown = document.getElementById("premiumCountdown");

    // HER ŞEYİ SIFIRLA
    premiumCountdown.innerHTML = "";
    document.getElementById("whatsappBox").style.display = "none";
    document.getElementById("loginBtn").style.display = "inline-block";
    document.getElementById("logoutBtn").style.display = "none";

    /* ------------------------------
       PREMIUM KULLANICI
    ------------------------------ */
    if (data.logged_in && data.premium) {
        statusDiv.innerHTML = "Premium Üye: " + data.email;
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("logoutBtn").style.display = "inline-block";

        // Geri sayım
        startPremiumCountdown(data.end_date);

        freeSpan.innerHTML = "Sınırsız";
        return;
    }

    /* ------------------------------
       PREMIUM DEĞİL → GUEST veya EXPIRED
    ------------------------------ */
    if (!data.logged_in) {
        statusDiv.innerHTML = "Misafir Kullanıcı";
        freeSpan.innerHTML = data.remaining;
    } else {
        statusDiv.innerHTML = "Premium Süresi Doldu: " + data.email;
        freeSpan.innerHTML = data.remaining;
    }
}

/* ----------------------------------------------------
   PREMIUM GERİ SAYIM
---------------------------------------------------- */
function startPremiumCountdown(endDateStr) {
    let end = new Date(endDateStr).getTime();

    setInterval(() => {
        const now = Date.now();
        const diff = end - now;

        if (diff <= 0) {
            document.getElementById("premiumCountdown").innerHTML = "Premium süresi doldu";
            return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const minutes = Math.floor((diff / (1000 * 60)) % 60);

        document.getElementById("premiumCountdown").innerHTML =
            `Premium süreniz: ${days} gün ${hours} saat ${minutes} dakika`;

    }, 60000);

}

/* ----------------------------------------------------
   Vektörleştirme İŞLEMİ
---------------------------------------------------- */
async function processImage() {
    const file = document.getElementById("uploadInput").files[0];
    if (!file) {
        alert("Bir görsel seçmelisiniz.");
        return;
    }

    const formData = new FormData();
    formData.append("image", file);
    formData.append("style", "cartoon");
    formData.append("colors", 4);
    formData.append("format", "png");

    const res = await fetch("/vectorize_style", {
        method: "POST",
        body: formData
    });

    const data = await res.json();

    if (!data.success && data.error === "limit_reached") {
        // HAK BİTTİ
        document.getElementById("whatsappBox").style.display = "block";
        alert("Ücretsiz hakkınız doldu. Aylık üyelik satın alabilirsiniz.");
        return;
    }

    document.getElementById("resultImage").src = data.image_data;

    // Kullanıcı durumunu yenile
    loadUserStatus();
}

/* ----------------------------------------------------
   SAYFA YÜKLENİNCE
---------------------------------------------------- */
loadUserStatus();
</script>

</body>
</html>
