<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Akıllı Vektörleştirici</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
            color: #e5e7eb;
            min-height: 100vh;
        }
        a { color: inherit; text-decoration: none; }

        .app-shell {
            max-width: 1200px;
            margin: 24px auto 32px;
            padding: 0 16px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
        }
        .logo span {
            color: #38bdf8;
        }

        .status-text {
            font-size: 13px;
            color: #9ca3af;
        }

        .top-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            border: none;
            border-radius: 999px;
            padding: 7px 16px;
            font-size: 13px;
            cursor: pointer;
            background: #1d4ed8;
            color: #e5e7eb;
        }
        .btn-secondary {
            background: #4b5563;
        }
        .btn-danger {
            background: #b91c1c;
        }
        .btn:disabled {
            opacity: .6;
            cursor: default;
        }

        .card {
            background: #020617;
            border-radius: 20px;
            padding: 24px 26px 26px;
            box-shadow: 0 24px 80px rgba(15,23,42,0.8);
            border: 1px solid #1f2937;
        }

        .card-header {
            margin-bottom: 18px;
        }
        .card-header h1 {
            font-size: 22px;
            margin-bottom: 4px;
        }
        .card-header p {
            font-size: 13px;
            color: #9ca3af;
        }

        .grid {
            display: grid;
            grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
            gap: 20px;
        }

        .panel {
            border-radius: 16px;
            border: 1px dashed #374151;
            background: #020617;
            padding: 18px;
        }

        .panel-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: .03em;
            text-transform: uppercase;
            color: #9ca3af;
        }

        .upload-box {
            border-radius: 14px;
            border: 1px dashed #4b5563;
            background: #020617;
            height: 330px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .upload-box p {
            font-size: 13px;
            color: #6b7280;
        }

        .upload-btn {
            cursor: pointer;
            border-radius: 999px;
            background: #111827;
            padding: 6px 14px;
            font-size: 13px;
            border: 1px solid #1f2937;
        }
        .upload-btn:hover {
            border-color: #2563eb;
            color: #e5e7eb;
        }

        .preview-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }

        .preview-wrapper {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            background: #020617;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .settings-group {
            margin-bottom: 16px;
        }
        .settings-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: .08em;
            color: #9ca3af;
            margin-bottom: 6px;
        }

        .style-toggle {
            display: flex;
            gap: 6px;
            background: #020617;
            padding: 4px;
            border-radius: 999px;
            border: 1px solid #1f2937;
        }
        .style-toggle button {
            flex: 1;
            border-radius: 999px;
            border: none;
            padding: 6px 8px;
            font-size: 12px;
            cursor: pointer;
            background: transparent;
            color: #9ca3af;
        }
        .style-toggle button.active {
            background: #1d4ed8;
            color: #e5e7eb;
        }

        .mode-toggle {
            display: inline-flex;
            gap: 6px;
            background: #020617;
            padding: 4px;
            border-radius: 999px;
            border: 1px solid #1f2937;
        }
        .mode-toggle button {
            border: none;
            border-radius: 999px;
            padding: 4px 9px;
            font-size: 12px;
            cursor: pointer;
            background: transparent;
            color: #9ca3af;
        }
        .mode-toggle button.active {
            background: #1d4ed8;
            color: #e5e7eb;
        }

        .range-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            width: 100%;
        }

        .primary-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-top: 12px;
            margin-bottom: 8px;
        }

        .note-text {
            font-size: 11px;
            color: #9ca3af;
        }

        .footer {
            margin-top: 14px;
            text-align: center;
            font-size: 11px;
            color: #6b7280;
        }

        .premium-info {
            font-size: 12px;
            color: #facc15;
            margin-top: 6px;
        }

        .error-text {
            font-size: 12px;
            color: #f97373;
            margin-top: 6px;
        }

        /* Basit login modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-backdrop.show {
            display: flex;
        }
        .modal-box {
            background: #020617;
            border-radius: 16px;
            border: 1px solid #1f2937;
            padding: 20px 22px 18px;
            width: 320px;
            max-width: calc(100% - 40px);
        }
        .modal-box h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }
        .modal-box p {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 10px;
        }
        .modal-input {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            padding: 7px 9px;
            font-size: 13px;
            margin-bottom: 12px;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 4px;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }
    </style>
</head>
<body>

<div class="app-shell">
    <!-- Üst bar -->
    <div class="top-bar">
        <div>
            <div class="logo">Botlab <span>Vector</span></div>
            <div class="status-text" id="userStatusText">Durum yükleniyor...</div>
        </div>
        <div class="top-buttons">
            <button class="btn-secondary btn" id="buyBtn">Aylık Satın Al</button>
            <button class="btn btn-secondary" id="loginBtn" onclick="openLoginModal()">Giriş Yap</button>
            <button class="btn btn-danger" id="logoutBtn" style="display:none;" onclick="logout()">Çıkış Yap</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h1>Akıllı Vektörleştirici</h1>
            <p>Fotoğrafını yükle, stil ve renk sayısını seç, anında cartoon / vektör avatarını oluştur.</p>
            <div id="premiumInfo" class="premium-info" style="display:none;"></div>
        </div>

        <div class="grid">
            <!-- Sol: Orijinal Görsel -->
            <div class="panel">
                <div class="panel-title">Orijinal Görsel</div>

                <div class="upload-box" id="uploadBox">
                    <div id="originalEmpty">
                        <button class="upload-btn" onclick="document.getElementById('imageInput').click()">Dosya Seç</button>
                        <p>PNG / JPG / JPEG desteklenir.</p>
                    </div>
                    <div id="originalPreviewWrapper" class="preview-wrapper" style="display:none;">
                        <img id="originalPreview" class="preview-img" alt="Orijinal önizleme">
                    </div>
                </div>

                <input type="file" id="imageInput" accept="image/png,image/jpeg" style="display:none;">
            </div>

            <!-- Sağ: Ayarlar & Çıktı -->
            <div class="panel">
                <div class="panel-title">Ayarlar &amp; Çıktı</div>

                <!-- Stil -->
                <div class="settings-group">
                    <div class="settings-label">Stil</div>
                    <div class="style-toggle" id="styleToggle">
                        <button type="button" data-style="normal">Normal Vektör</button>
                        <button type="button" data-style="cartoon" class="active">Çizgi Vektör</button>
                        <button type="button" data-style="lines">Sadece Çizgi</button>
                    </div>
                </div>

                <!-- Renk Sayısı -->
                <div class="settings-group">
                    <div class="settings-label">Renk Sayısı</div>
                    <div class="range-row">
                        <input type="range" id="colorRange" min="2" max="10" value="4">
                        <span id="colorCount" style="font-size:12px; color:#e5e7eb;">4</span>
                    </div>
                </div>

                <!-- Çıktı Türü -->
                <div class="settings-group">
                    <div class="settings-label">Çıktı Türü</div>
                    <div class="mode-toggle" id="modeToggle">
                        <button type="button" data-mode="color" class="active">Renkli</button>
                        <button type="button" data-mode="bw">Siyah-Beyaz</button>
                    </div>
                </div>

                <div class="primary-actions">
                    <button class="btn" onclick="handleVectorize()" id="vectorizeBtn">Önizle (Vektörleştir)</button>
                    <a id="downloadBtn" class="btn btn-secondary" href="#" download="vektor.png" style="opacity:0.4; pointer-events:none;">İndir</a>
                </div>
                <div class="note-text" id="freeInfoText">Ücretsiz hak: yükleniyor...</div>
                <div class="error-text" id="errorText" style="display:none;"></div>

                <div style="margin-top:12px; border-radius:12px; border:1px dashed #374151; padding:10px;">
                    <div class="settings-label" style="margin-bottom:4px;">Vektör Önizleme</div>
                    <div class="preview-wrapper" style="height:210px;">
                        <span id="resultPlaceholder" style="font-size:12px; color:#6b7280;">Henüz çıktı yok.</span>
                        <img id="resultPreview" class="preview-img" alt="Vektör önizleme" style="display:none;">
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            Botlab Teknoloji – Yapay Zeka Destekli Vektörleştirme Uygulaması
        </div>
    </div>
</div>

<!-- Basit Login Modal -->
<div class="modal-backdrop" id="loginModal">
    <div class="modal-box">
        <h3>Giriş Yap</h3>
        <p>WhatsApp'tan bize ilettiğiniz mail adresini girerek premium sürüme erişebilirsiniz.</p>
        <input type="email" id="loginEmail" class="modal-input" placeholder="ornek@mail.com">
        <div class="modal-actions">
            <button class="btn-secondary btn" onclick="closeLoginModal()">Kapat</button>
            <button class="btn" onclick="submitLogin()">Giriş Yap</button>
        </div>
    </div>
</div>

<script>
    let currentStyle = "cartoon"; // default: Çizgi Vektör
    let currentMode = "color";
    let currentFile = null;
    let lastResultData = null;

    // ===== Kullanıcı Durumu =====
    async function loadUserStatus() {
        try {
            const res = await fetch("/user_status");
            const data = await res.json();

            const statusEl = document.getElementById("userStatusText");
            const premiumEl = document.getElementById("premiumInfo");
            const freeInfoEl = document.getElementById("freeInfoText");
            const loginBtn = document.getElementById("loginBtn");
            const logoutBtn = document.getElementById("logoutBtn");

            premiumEl.style.display = "none";

            if (data.logged_in) {
                loginBtn.style.display = "none";
                logoutBtn.style.display = "inline-flex";

                if (data.premium) {
                    statusEl.textContent = `Premium Üye: ${data.email} (Aktif)`;
                    const d = new Date(data.end_date);
                    premiumEl.textContent = `Premium üyelik bitiş tarihi: ${d.toLocaleDateString()} ${d.toLocaleTimeString()}`;
                    premiumEl.style.display = "block";
                    freeInfoEl.textContent = "Ücretsiz hak: Sınırsız";
                } else {
                    statusEl.textContent = `Üye: ${data.email} (Premium süreniz dolmuş, şu an misafir hakları ile devam ediyorsunuz.)`;
                    freeInfoEl.textContent = "Ücretsiz hak: Sınırlı (görsel dönüşümlerinizde limit uygulanır)";
                }
            } else {
                loginBtn.style.display = "inline-flex";
                logoutBtn.style.display = "none";
                statusEl.textContent = "Misafir Kullanıcı";
                freeInfoEl.textContent = `Kalan ücretsiz hak: ${data.remaining}`;
            }
        } catch (e) {
            console.error(e);
            document.getElementById("userStatusText").textContent = "Durum alınamadı.";
            document.getElementById("freeInfoText").textContent = "";
        }
    }

    // ===== Stil & mod butonları =====
    function setupToggles() {
        const styleButtons = document.querySelectorAll("#styleToggle button");
        styleButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                styleButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                currentStyle = btn.getAttribute("data-style");
            });
        });

        const modeButtons = document.querySelectorAll("#modeToggle button");
        modeButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                modeButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                currentMode = btn.getAttribute("data-mode");
            });
        });

        const range = document.getElementById("colorRange");
        const countEl = document.getElementById("colorCount");
        range.addEventListener("input", () => {
            countEl.textContent = range.value;
        });
    }

    // ===== Dosya yükleme & önizleme =====
    document.getElementById("imageInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        currentFile = file;
        const url = URL.createObjectURL(file);

        document.getElementById("originalEmpty").style.display = "none";
        document.getElementById("originalPreviewWrapper").style.display = "flex";
        document.getElementById("originalPreview").src = url;
    });

    // ===== Vektörleştirme =====
    async function handleVectorize() {
        const errorEl = document.getElementById("errorText");
        errorEl.style.display = "none";
        errorEl.textContent = "";

        if (!currentFile) {
            errorEl.textContent = "Lütfen önce bir görsel seçin.";
            errorEl.style.display = "block";
            return;
        }

        const btn = document.getElementById("vectorizeBtn");
        const resultImg = document.getElementById("resultPreview");
        const placeholder = document.getElementById("resultPlaceholder");
        const downloadBtn = document.getElementById("downloadBtn");

        btn.disabled = true;
        btn.textContent = "Vektörleştiriliyor...";
        placeholder.style.display = "block";
        placeholder.textContent = "İşleniyor...";
        resultImg.style.display = "none";
        downloadBtn.style.opacity = 0.4;
        downloadBtn.style.pointerEvents = "none";

        try {
            const formData = new FormData();
            formData.append("image", currentFile);
            formData.append("style", currentStyle);
            formData.append("colors", document.getElementById("colorRange").value);
            formData.append("mode", currentMode);

            const res = await fetch("/vectorize_style", {
                method: "POST",
                body: formData
            });

            if (res.status === 403) {
                const data = await res.json();
                errorEl.textContent = data.message || "Ücretsiz hakkınız dolmuş.";
                errorEl.style.display = "block";
                if (data.whatsapp) {
                    // Aylık Satın Al butonuna link verelim
                    document.getElementById("buyBtn").onclick = () => {
                        window.open(data.whatsapp, "_blank");
                    };
                }
                placeholder.style.display = "block";
                placeholder.textContent = "Limit nedeniyle çıktı üretilemedi.";
                btn.disabled = false;
                btn.textContent = "Önizle (Vektörleştir)";
                return;
            }

            const data = await res.json();
            if (!data.success) {
                errorEl.textContent = data.message || "Beklenmeyen bir hata oluştu.";
                errorEl.style.display = "block";
                placeholder.style.display = "block";
                placeholder.textContent = "Çıktı üretilemedi.";
                btn.disabled = false;
                btn.textContent = "Önizle (Vektörleştir)";
                return;
            }

            lastResultData = data.image_data;
            resultImg.src = lastResultData;
            resultImg.style.display = "block";
            placeholder.style.display = "none";

            downloadBtn.href = lastResultData;
            downloadBtn.style.opacity = 1;
            downloadBtn.style.pointerEvents = "auto";
        } catch (e) {
            console.error(e);
            errorEl.textContent = "İşleme sırasında bir hata oluştu.";
            errorEl.style.display = "block";
            placeholder.style.display = "block";
            placeholder.textContent = "Çıktı üretilemedi.";
        } finally {
            btn.disabled = false;
            btn.textContent = "Önizle (Vektörleştir)";
            loadUserStatus(); // kullanım haklarını güncelle
        }
    }

    // ===== Login Modal =====
    function openLoginModal() {
        document.getElementById("loginModal").classList.add("show");
        document.getElementById("loginEmail").focus();
    }
    function closeLoginModal() {
        document.getElementById("loginModal").classList.remove("show");
    }

    async function submitLogin() {
        const email = document.getElementById("loginEmail").value.trim();
        if (!email) return;

        try {
            const res = await fetch("/login", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({email})
            });
            const data = await res.json();
            if (!data.success) {
                alert(data.message || "Giriş yapılamadı.");
                return;
            }
            closeLoginModal();
            await loadUserStatus();
        } catch (e) {
            console.error(e);
            alert("Giriş sırasında hata oluştu.");
        }
    }

    async function logout() {
        try {
            await fetch("/logout", {method: "POST"});
        } catch (e) {
            console.error(e);
        }
        // Tam reset
        window.location.reload();
    }

    // Aylık Satın Al butonu (default - istersen linki değiştir)
    document.getElementById("buyBtn").onclick = () => {
        // Buradaki numarayı istersen kendi WhatsApp numaranla değiştir.
        window.open("https://wa.me/905555555555?text=Aylık+üyelik+istiyorum", "_blank");
    };

    // Init
    document.addEventListener("DOMContentLoaded", () => {
        setupToggles();
        loadUserStatus();
    });
</script>

</body>
</html>
