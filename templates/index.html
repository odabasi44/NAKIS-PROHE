<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>AkÄ±llÄ± VektÃ¶rleÅŸtirici</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
            color: #e5e7eb;
            min-height: 100vh;
        }
        a { color: inherit; text-decoration: none; }

        .app-shell {
            max-width: 1200px;
            margin: 24px auto 32px;
            padding: 0 16px;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .logo {
            font-size: 22px;
            font-weight: 700;
        }
        .logo span {
            color: #38bdf8;
        }

        .status-text {
            font-size: 13px;
            color: #9ca3af;
        }

        .top-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            border: none;
            border-radius: 999px;
            padding: 7px 16px;
            font-size: 13px;
            cursor: pointer;
            background: #1d4ed8;
            color: #e5e7eb;
        }
        .btn-secondary {
            background: #4b5563;
        }
        .btn-danger {
            background: #b91c1c;
        }
        .btn:disabled {
            opacity: .6;
            cursor: default;
        }

        .card {
            background: #020617;
            border-radius: 20px;
            padding: 24px 26px 26px;
            box-shadow: 0 24px 80px rgba(15,23,42,0.8);
            border: 1px solid #1f2937;
        }

        .card-header {
            margin-bottom: 18px;
        }
        .card-header h1 {
            font-size: 22px;
            margin-bottom: 4px;
        }
        .card-header p {
            font-size: 13px;
            color: #9ca3af;
        }

        .grid {
            display: grid;
            grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
            gap: 20px;
        }

        .panel {
            border-radius: 16px;
            border: 1px dashed #374151;
            background: #020617;
            padding: 18px;
        }

        .panel-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: .03em;
            text-transform: uppercase;
            color: #9ca3af;
        }

        .panel-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .mini-btn {
            border-radius: 999px;
            border: 1px solid #374151;
            background: #020617;
            color: #9ca3af;
            font-size: 11px;
            padding: 4px 8px;
            cursor: pointer;
        }
        .mini-btn:hover {
            border-color: #2563eb;
            color: #e5e7eb;
        }

        .upload-box {
            border-radius: 14px;
            border: 1px dashed #4b5563;
            background: #020617;
            height: 330px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .upload-box p {
            font-size: 13px;
            color: #6b7280;
        }

        .upload-btn {
            cursor: pointer;
            border-radius: 999px;
            background: #111827;
            padding: 6px 14px;
            font-size: 13px;
            border: 1px solid #1f2937;
        }
        .upload-btn:hover {
            border-color: #2563eb;
            color: #e5e7eb;
        }

        .preview-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }

        .preview-wrapper {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            background: #020617;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .settings-group {
            margin-bottom: 16px;
        }
        .settings-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: .08em;
            color: #9ca3af;
            margin-bottom: 6px;
        }

        .style-toggle {
            display: flex;
            gap: 6px;
            background: #020617;
            padding: 4px;
            border-radius: 999px;
            border: 1px solid #1f2937;
        }
        .style-toggle button {
            flex: 1;
            border-radius: 999px;
            border: none;
            padding: 6px 8px;
            font-size: 12px;
            cursor: pointer;
            background: transparent;
            color: #9ca3af;
        }
        .style-toggle button.active {
            background: #1d4ed8;
            color: #e5e7eb;
        }

        .mode-toggle {
            display: inline-flex;
            gap: 6px;
            background: #020617;
            padding: 4px;
            border-radius: 999px;
            border: 1px solid #1f2937;
        }
        .mode-toggle button {
            border: none;
            border-radius: 999px;
            padding: 4px 9px;
            font-size: 12px;
            cursor: pointer;
            background: transparent;
            color: #9ca3af;
        }
        .mode-toggle button.active {
            background: #1d4ed8;
            color: #e5e7eb;
        }

        .range-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="range"] {
            width: 100%;
        }

        .primary-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-top: 12px;
            margin-bottom: 8px;
        }

        .note-text {
            font-size: 11px;
            color: #9ca3af;
        }

        .footer {
            margin-top: 14px;
            text-align: center;
            font-size: 11px;
            color: #6b7280;
        }

        .premium-info {
            font-size: 12px;
            color: #facc15;
            margin-top: 6px;
        }

        .error-text {
            font-size: 12px;
            color: #f97373;
            margin-top: 6px;
        }

        /* Progress bar */
        .progress-wrap {
            margin-top: 8px;
        }
        .progress-bar-bg {
            width: 100%;
            height: 6px;
            border-radius: 999px;
            background: #111827;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 999px;
            background: #22c55e;
            width: 0%;
            transition: width 0.25s ease-out;
        }
        .progress-label {
            margin-top: 4px;
            font-size: 11px;
            color: #9ca3af;
        }

        /* Basit modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-backdrop.show {
            display: flex;
        }
        .modal-box {
            background: #020617;
            border-radius: 16px;
            border: 1px solid #1f2937;
            padding: 20px 22px 18px;
            width: 320px;
            max-width: calc(100% - 40px);
        }
        .modal-box h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }
        .modal-box p {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 10px;
        }
        .modal-input {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            padding: 7px 9px;
            font-size: 13px;
            margin-bottom: 12px;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 4px;
        }

        /* Paket kartlarÄ± */
        .package-card {
            border-radius: 12px;
            border: 1px solid #1f2937;
            padding: 10px 12px;
            margin-bottom: 8px;
            background: #020617;
        }
        .package-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .package-desc {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 6px;
        }
        .package-prices {
            font-size: 12px;
            color: #e5e7eb;
            margin-bottom: 6px;
        }
        .package-prices span {
            font-size: 11px;
            color: #9ca3af;
        }
        .package-select-btn {
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 999px;
            border: none;
            background: #1d4ed8;
            color: #e5e7eb;
            cursor: pointer;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }
    </style>
</head>
<body>

<div class="app-shell">
    <!-- Ãœst bar -->
    <div class="top-bar">
        <div>
            <div class="logo">Botlab <span>Vector</span></div>
            <div class="status-text" id="userStatusText">Durum yÃ¼kleniyor...</div>
        </div>
        <div class="top-buttons">
            <button class="btn-secondary btn" id="buyBtn">AylÄ±k SatÄ±n Al</button>
            <button class="btn btn-secondary" id="loginBtn" onclick="openLoginModal()">GiriÅŸ Yap</button>
            <button class="btn btn-danger" id="logoutBtn" style="display:none;" onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h1>AkÄ±llÄ± VektÃ¶rleÅŸtirici</h1>
            <p>FotoÄŸrafÄ±nÄ± yÃ¼kle, stil ve renk sayÄ±sÄ±nÄ± seÃ§; anÄ±nda cartoon / vektÃ¶r avatarÄ±nÄ± oluÅŸtur.</p>
            <div id="premiumInfo" class="premium-info" style="display:none;"></div>
        </div>

        <div class="grid">
            <!-- Sol: Orijinal GÃ¶rsel -->
            <div class="panel">
                <div class="panel-title-row">
                    <div class="panel-title">Orijinal GÃ¶rsel</div>
                    <button class="mini-btn" type="button" onclick="resetImage()">Yeni gÃ¶rsel</button>
                </div>

                <div class="upload-box" id="uploadBox">
                    <div id="originalEmpty">
                        <button class="upload-btn" onclick="document.getElementById('imageInput').click()">Dosya SeÃ§</button>
                        <p>PNG / JPG / JPEG desteklenir.</p>
                    </div>
                    <div id="originalPreviewWrapper" class="preview-wrapper" style="display:none;">
                        <img id="originalPreview" class="preview-img" alt="Orijinal Ã¶nizleme">
                    </div>
                </div>

                <input type="file" id="imageInput" accept="image/png,image/jpeg" style="display:none;">
            </div>

            <!-- SaÄŸ: Ayarlar & Ã‡Ä±ktÄ± -->
            <div class="panel">
                <div class="panel-title">Ayarlar &amp; Ã‡Ä±ktÄ±</div>

                <!-- Stil -->
                <div class="settings-group">
                    <div class="settings-label">Stil</div>
                    <div class="style-toggle" id="styleToggle">
                        <button type="button" data-style="normal">Normal VektÃ¶r</button>
                        <button type="button" data-style="cartoon" class="active">Ã‡izgi VektÃ¶r</button>
                        <button type="button" data-style="lines">Sadece Ã‡izgi</button>
                    </div>
                </div>

                <!-- Renk SayÄ±sÄ± -->
                <div class="settings-group">
                    <div class="settings-label">Renk SayÄ±sÄ±</div>
                    <div class="range-row">
                        <input type="range" id="colorRange" min="2" max="10" value="4">
                        <span id="colorCount" style="font-size:12px; color:#e5e7eb;">4</span>
                    </div>
                    <!-- YENÄ°: NakÄ±ÅŸ preset butonlarÄ± -->
                    <div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:6px;">
                        <button type="button" class="mini-btn color-preset" data-value="4">NakÄ±ÅŸ Basic (4)</button>
                        <button type="button" class="mini-btn color-preset" data-value="6">NakÄ±ÅŸ Orta (6)</button>
                        <button type="button" class="mini-btn color-preset" data-value="8">NakÄ±ÅŸ Detay (8)</button>
                        <button type="button" class="mini-btn color-preset" data-value="10">Max Detay (10)</button>
                    </div>
                    <div class="note-text" style="margin-top:4px;">
                        Not: NakÄ±ÅŸ makineleri iÃ§in genelde 4â€“10 arasÄ± renk Ã¶nerilir. Preset tuÅŸlarÄ± ile hÄ±zlÄ± seÃ§im yapabilirsiniz.
                    </div>
                </div>

                <!-- Ã‡Ä±ktÄ± TÃ¼rÃ¼ -->
                <div class="settings-group">
                    <div class="settings-label">Ã‡Ä±ktÄ± TÃ¼rÃ¼</div>
                    <div class="mode-toggle" id="modeToggle">
                        <button type="button" data-mode="color" class="active">Renkli</button>
                        <button type="button" data-mode="bw">Siyah-Beyaz</button>
                    </div>
                </div>

                <div class="primary-actions">
                    <button class="btn" onclick="handleVectorize()" id="vectorizeBtn">Ã–nizle (VektÃ¶rleÅŸtir)</button>
                    <a id="downloadBtn" class="btn btn-secondary" href="#" download="vektor.png" style="opacity:0.4; pointer-events:none;">Ä°ndir</a>
                </div>
                <div class="note-text" id="freeInfoText">Ãœcretsiz hak: yÃ¼kleniyor...</div>

                <div class="progress-wrap" id="progressWrap" style="display:none;">
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-label" id="progressLabel">HazÄ±rlanÄ±yor...</div>
                </div>

                <div class="error-text" id="errorText" style="display:none;"></div>

                <div style="margin-top:12px; border-radius:12px; border:1px dashed #374151; padding:10px;">
                    <div class="settings-label" style="margin-bottom:4px;">VektÃ¶r Ã–nizleme</div>
                    <div class="preview-wrapper" style="height:210px;">
                        <span id="resultPlaceholder" style="font-size:12px; color:#6b7280;">HenÃ¼z Ã§Ä±ktÄ± yok.</span>
                        <img id="resultPreview" class="preview-img" alt="VektÃ¶r Ã¶nizleme" style="display:none;">
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            Botlab Teknoloji â€“ Yapay Zeka Destekli VektÃ¶rleÅŸtirme UygulamasÄ±
        </div>
    </div>
</div>

<!-- Login Modal -->
<div class="modal-backdrop" id="loginModal">
    <div class="modal-box">
        <h3>GiriÅŸ Yap</h3>
        <p>WhatsApp'tan bize ilettiÄŸiniz mail adresini girerek premium sÃ¼rÃ¼me eriÅŸebilirsiniz.</p>
        <input type="email" id="loginEmail" class="modal-input" placeholder="ornek@mail.com">
        <div class="modal-actions">
            <button class="btn-secondary btn" onclick="closeLoginModal()">Kapat</button>
            <button class="btn" onclick="submitLogin()">GiriÅŸ Yap</button>
        </div>
    </div>
</div>

<!-- Paket SeÃ§im Modal -->
<div class="modal-backdrop" id="packagesModal">
    <div class="modal-box" style="max-width:600px;">
        <h3>Paket SeÃ§imi</h3>
        <p>Ä°htiyacÄ±nÄ±za uygun paketi ve sÃ¼reyi seÃ§in; WhatsApp Ã¼zerinden bize iletin.</p>

        <div class="settings-group">
            <div class="settings-label">SÃ¼re</div>
            <div class="mode-toggle" id="durationToggle">
                <button type="button" data-duration="monthly" class="active">AylÄ±k</button>
                <button type="button" data-duration="quarterly">3 AylÄ±k</button>
                <button type="button" data-duration="yearly">1 YÄ±llÄ±k</button>
            </div>
        </div>

        <div id="packagesContainer" style="margin-top:10px; max-height:260px; overflow-y:auto;"></div>

        <div class="modal-actions" style="margin-top:12px;">
            <button class="btn-secondary btn" onclick="closePackagesModal()">Kapat</button>
        </div>
    </div>
</div>

<script>
    let currentStyle = "cartoon"; // default: Ã‡izgi VektÃ¶r
    let currentMode = "color";
    let currentFile = null;
    let lastResultData = null;

    let progressTimer = null;

    let packagesData = [];
    let packagesLoaded = false;
    let currentDuration = "monthly";
    let globalWhatsapp = null;

    // ===== KullanÄ±cÄ± Durumu =====
    async function loadUserStatus() {
        try {
            const res = await fetch("/user_status");
            const data = await res.json();

            const statusEl = document.getElementById("userStatusText");
            const premiumEl = document.getElementById("premiumInfo");
            const freeInfoEl = document.getElementById("freeInfoText");
            const loginBtn = document.getElementById("loginBtn");
            const logoutBtn = document.getElementById("logoutBtn");

            premiumEl.style.display = "none";

            if (data.logged_in) {
                loginBtn.style.display = "none";
                logoutBtn.style.display = "inline-flex";

                const total = data.total_usage || 0;

                if (data.premium) {
                    statusEl.textContent = `Premium Ãœye: ${data.email} (Aktif, bugÃ¼ne kadar ${total} gÃ¶rsel vektÃ¶rleÅŸtirdiniz.)`;
                    const d = new Date(data.end_date);
                    premiumEl.textContent = `Premium Ã¼yelik bitiÅŸ tarihi: ${d.toLocaleDateString()} ${d.toLocaleTimeString()}`;
                    premiumEl.style.display = "block";
                    freeInfoEl.textContent = "Ãœcretsiz hak: SÄ±nÄ±rsÄ±z (Premium hesap)";
                } else {
                    statusEl.textContent = `Ãœye: ${data.email} (Premium sÃ¼reniz dolmuÅŸ, ÅŸu an misafir haklarÄ± ile devam ediyorsunuz. Toplam ${total} gÃ¶rsel iÅŸlediniz.)`;
                    freeInfoEl.textContent = "Ãœcretsiz hak: SÄ±nÄ±rlÄ± (gÃ¶rsel dÃ¶nÃ¼ÅŸÃ¼mlerinizde limit uygulanÄ±r)";
                }
            } else {
                loginBtn.style.display = "inline-flex";
                logoutBtn.style.display = "none";
                statusEl.textContent = "Misafir KullanÄ±cÄ±";
                freeInfoEl.textContent = `Kalan Ã¼cretsiz hak: ${data.remaining}`;
            }
        } catch (e) {
            console.error(e);
            document.getElementById("userStatusText").textContent = "Durum alÄ±namadÄ±.";
            document.getElementById("freeInfoText").textContent = "";
        }
    }

    // ===== Stil & mod butonlarÄ± =====
    function setupToggles() {
        const styleButtons = document.querySelectorAll("#styleToggle button");
        styleButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                styleButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                currentStyle = btn.getAttribute("data-style");
            });
        });

        const modeButtons = document.querySelectorAll("#modeToggle button");
        modeButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                modeButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                currentMode = btn.getAttribute("data-mode");
            });
        });

        const range = document.getElementById("colorRange");
        const countEl = document.getElementById("colorCount");
        range.addEventListener("input", () => {
            countEl.textContent = range.value;
        });

        // YENÄ°: Renk preset butonlarÄ±
        const presetButtons = document.querySelectorAll(".color-preset");
        presetButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const val = btn.getAttribute("data-value");
                range.value = val;
                countEl.textContent = val;
            });
        });
    }

    // ===== Dosya yÃ¼kleme & Ã¶nizleme =====
    document.getElementById("imageInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        currentFile = file;
        const url = URL.createObjectURL(file);

        document.getElementById("originalEmpty").style.display = "none";
        document.getElementById("originalPreviewWrapper").style.display = "flex";
        document.getElementById("originalPreview").src = url;

        // Yeni gÃ¶rsel seÃ§ildiÄŸinde Ã¶nceki Ã§Ä±ktÄ±larÄ± temizle
        resetResultPreview();
    });

    function resetImage() {
        currentFile = null;
        lastResultData = null;

        const input = document.getElementById("imageInput");
        input.value = "";

        document.getElementById("originalEmpty").style.display = "block";
        document.getElementById("originalPreviewWrapper").style.display = "none";
        document.getElementById("originalPreview").src = "";

        resetResultPreview();
    }

    function resetResultPreview() {
        const resultImg = document.getElementById("resultPreview");
        const placeholder = document.getElementById("resultPlaceholder");
        const downloadBtn = document.getElementById("downloadBtn");
        const errorEl = document.getElementById("errorText");

        lastResultData = null;
        resultImg.style.display = "none";
        resultImg.src = "";
        placeholder.style.display = "block";
        placeholder.textContent = "HenÃ¼z Ã§Ä±ktÄ± yok.";
        downloadBtn.href = "#";
        downloadBtn.style.opacity = 0.4;
        downloadBtn.style.pointerEvents = "none";

        errorEl.style.display = "none";
        errorEl.textContent = "";

        stopProgressPolling(0);
        document.getElementById("progressWrap").style.display = "none";
    }

    // ===== Progress bar =====
    function startProgressPolling() {
        const wrap = document.getElementById("progressWrap");
        wrap.style.display = "block";
        updateProgressBar(0);

        if (progressTimer) clearInterval(progressTimer);

        progressTimer = setInterval(async () => {
            try {
                const res = await fetch("/vectorize_progress");
                const data = await res.json();
                const p = data.progress ?? 0;
                updateProgressBar(p);
            } catch (e) {
                console.error(e);
            }
        }, 500);
    }

    function stopProgressPolling(finalValue = null) {
        if (progressTimer) {
            clearInterval(progressTimer);
            progressTimer = null;
        }
        if (finalValue !== null) {
            updateProgressBar(finalValue);
        }
    }

    function updateProgressBar(p) {
        const fill = document.getElementById("progressFill");
        const label = document.getElementById("progressLabel");
        p = Math.max(0, Math.min(100, p));
        fill.style.width = p + "%";

        if (p === 0) {
            label.textContent = "HazÄ±rlanÄ±yor...";
        } else if (p < 30) {
            label.textContent = `Ä°ÅŸleme baÅŸlatÄ±lÄ±yor... %${p}`;
        } else if (p < 70) {
            label.textContent = `VektÃ¶r stilleri uygulanÄ±yor... %${p}`;
        } else if (p < 100) {
            label.textContent = `Son dokunuÅŸlar yapÄ±lÄ±yor... %${p}`;
        } else {
            label.textContent = "TamamlandÄ± ðŸŽ‰";
        }
    }

    // ===== VektÃ¶rleÅŸtirme =====
    async function handleVectorize() {
        const errorEl = document.getElementById("errorText");
        errorEl.style.display = "none";
        errorEl.textContent = "";

        if (!currentFile) {
            errorEl.textContent = "LÃ¼tfen Ã¶nce bir gÃ¶rsel seÃ§in.";
            errorEl.style.display = "block";
            return;
        }

        const btn = document.getElementById("vectorizeBtn");
        const resultImg = document.getElementById("resultPreview");
        const placeholder = document.getElementById("resultPlaceholder");
        const downloadBtn = document.getElementById("downloadBtn");

        btn.disabled = true;
        btn.textContent = "VektÃ¶rleÅŸtiriliyor...";
        placeholder.style.display = "block";
        placeholder.textContent = "Ä°ÅŸleniyor...";
        resultImg.style.display = "none";
        downloadBtn.style.opacity = 0.4;
        downloadBtn.style.pointerEvents = "none";

        startProgressPolling();

        try {
            const formData = new FormData();
            formData.append("image", currentFile);
            formData.append("style", currentStyle);
            formData.append("colors", document.getElementById("colorRange").value);
            formData.append("mode", currentMode);

            const res = await fetch("/vectorize_style", {
                method: "POST",
                body: formData
            });

            if (res.status === 403) {
                const data = await res.json();
                errorEl.textContent = data.message || "Ãœcretsiz hakkÄ±nÄ±z doldu.";
                errorEl.style.display = "block";
                if (data.whatsapp) {
                    document.getElementById("buyBtn").onclick = () => {
                        window.open(data.whatsapp, "_blank");
                    };
                }
                placeholder.style.display = "block";
                placeholder.textContent = "Limit nedeniyle Ã§Ä±ktÄ± Ã¼retilemedi.";
                stopProgressPolling(0);
                btn.disabled = false;
                btn.textContent = "Ã–nizle (VektÃ¶rleÅŸtir)";
                return;
            }

            const data = await res.json();
            if (!data.success) {
                errorEl.textContent = data.message || "Beklenmeyen bir hata oluÅŸtu.";
                errorEl.style.display = "block";
                placeholder.style.display = "block";
                placeholder.textContent = "Ã‡Ä±ktÄ± Ã¼retilemedi.";
                stopProgressPolling(0);
                btn.disabled = false;
                btn.textContent = "Ã–nizle (VektÃ¶rleÅŸtir)";
                return;
            }

            lastResultData = data.image_data;
            resultImg.src = lastResultData;
            resultImg.style.display = "block";
            placeholder.style.display = "none";

            downloadBtn.href = lastResultData;
            downloadBtn.style.opacity = 1;
            downloadBtn.style.pointerEvents = "auto";

            stopProgressPolling(100);
        } catch (e) {
            console.error(e);
            errorEl.textContent = "Ä°ÅŸleme sÄ±rasÄ±nda bir hata oluÅŸtu.";
            errorEl.style.display = "block";
            placeholder.style.display = "block";
            placeholder.textContent = "Ã‡Ä±ktÄ± Ã¼retilemedi.";
            stopProgressPolling(0);
        } finally {
            btn.disabled = false;
            btn.textContent = "Ã–nizle (VektÃ¶rleÅŸtir)";
            loadUserStatus(); // kullanÄ±m haklarÄ±nÄ± gÃ¼ncelle
        }
    }

    // ===== Login Modal =====
    function openLoginModal() {
        document.getElementById("loginModal").classList.add("show");
        document.getElementById("loginEmail").focus();
    }
    function closeLoginModal() {
        document.getElementById("loginModal").classList.remove("show");
    }

    async function submitLogin() {
        const email = document.getElementById("loginEmail").value.trim();
        if (!email) return;

        try {
            const res = await fetch("/login", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({email})
            });
            const data = await res.json();
            if (!data.success) {
                alert(data.message || "GiriÅŸ yapÄ±lamadÄ±.");
                return;
            }
            closeLoginModal();
            await loadUserStatus();
        } catch (e) {
            console.error(e);
            alert("GiriÅŸ sÄ±rasÄ±nda hata oluÅŸtu.");
        }
    }

    async function logout() {
        try {
            await fetch("/logout", {method: "POST"});
        } catch (e) {
            console.error(e);
        }
        window.location.reload();
    }

    // ===== Paket Modal & API =====
    async function openPackagesModal() {
        document.getElementById("packagesModal").classList.add("show");
        if (!packagesLoaded) {
            await loadPackages();
        } else {
            renderPackages();
        }
    }

    function closePackagesModal() {
        document.getElementById("packagesModal").classList.remove("show");
    }

    async function loadPackages() {
        try {
            const res = await fetch("/packages");
            const data = await res.json();
            if (!data.success) {
                alert("Paket bilgileri alÄ±namadÄ±.");
                return;
            }
            packagesData = data.packages || [];
            globalWhatsapp = data.whatsapp || null;
            packagesLoaded = true;
            setupDurationToggle();
            renderPackages();
        } catch (e) {
            console.error(e);
            alert("Paket bilgileri alÄ±nÄ±rken hata oluÅŸtu.");
        }
    }

    function setupDurationToggle() {
        const durationButtons = document.querySelectorAll("#durationToggle button");
        durationButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                durationButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                currentDuration = btn.getAttribute("data-duration"); // monthly, quarterly, yearly
                renderPackages();
            });
        });
    }

    function renderPackages() {
        const container = document.getElementById("packagesContainer");
        container.innerHTML = "";
        if (!packagesData || packagesData.length === 0) {
            container.innerHTML = '<div class="note-text">HenÃ¼z tanÄ±mlÄ± paket yok.</div>';
            return;
        }

        packagesData.forEach(pkg => {
            const priceKey = currentDuration === "monthly"
                ? "price_monthly"
                : currentDuration === "quarterly"
                    ? "price_quarterly"
                    : "price_yearly";

            const priceLabel = currentDuration === "monthly"
                ? "AylÄ±k"
                : currentDuration === "quarterly"
                    ? "3 AylÄ±k"
                    : "1 YÄ±llÄ±k";

            const price = pkg[priceKey] || "-";

            const html = `
                <div class="package-card">
                    <div class="package-title">${pkg.display_name}</div>
                    <div class="package-desc">${pkg.description || ""}</div>
                    <div class="package-prices">
                        <div><span>${priceLabel} Fiyat:</span> ${price}</div>
                    </div>
                    <button class="package-select-btn" onclick="selectPackage('${pkg.slug}')">
                        Bu paketi seÃ§
                    </button>
                </div>
            `;
            container.insertAdjacentHTML("beforeend", html);
        });
    }

    function selectPackage(slug) {
        const pkg = packagesData.find(p => p.slug === slug);
        if (!pkg) return;

        const priceLabel = currentDuration === "monthly"
            ? "AylÄ±k"
            : currentDuration === "quarterly"
                ? "3 AylÄ±k"
                : "1 YÄ±llÄ±k";

        const priceKey = currentDuration === "monthly"
            ? "price_monthly"
            : currentDuration === "quarterly"
                ? "price_quarterly"
                : "price_yearly";

        const price = pkg[priceKey] || "";

        let text = `Merhaba, ${priceLabel} ${pkg.display_name} paketini satÄ±n almak istiyorum.`;
        if (price) {
            text += ` Fiyat bilgisinde ${price} olarak gÃ¶rÃ¼nÃ¼yor.`;
        }

        const encoded = encodeURIComponent(text);
        const number = globalWhatsapp || "905555555555";
        const url = `https://wa.me/${number}?text=${encoded}`;
        window.open(url, "_blank");
    }

    // Init
    document.addEventListener("DOMContentLoaded", () => {
        setupToggles();
        loadUserStatus();
        document.getElementById("buyBtn").onclick = openPackagesModal;
    });
</script>

</body>
</html>
