<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Vektörleştirici</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #111827;
            --accent: #3b82f6;
            --accent-soft: rgba(59,130,246,0.15);
            --text: #e5e7eb;
            --text-soft: #9ca3af;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #1f2933, #020617);
            color: var(--text);
        }
        #topBar {
            background: rgba(15,23,42,0.9);
            backdrop-filter: blur(12px);
            color: var(--text);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(148,163,184,0.2);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #topBar button {
            background: var(--accent);
            color: white;
            padding: 7px 14px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 14px;
        }
        #topBar button#logoutBtn {
            background: #ef4444;
        }
        #userStatus {
            font-size: 14px;
        }
        #userStatus span {
            padding: 3px 8px;
            border-radius: 999px;
            background: var(--accent-soft);
            margin-left: 8px;
            font-size: 12px;
        }
        /* Login Modal */
        #loginModal {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        #loginBox {
            background: var(--card);
            padding: 24px;
            border-radius: 16px;
            width: 320px;
            box-shadow: 0 18px 40px rgba(0,0,0,0.6);
            border: 1px solid rgba(148,163,184,0.3);
        }
        #loginBox h2 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 20px;
        }
        #loginBox input {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(148,163,184,0.4);
            margin-bottom: 14px;
            background: #020617;
            color: var(--text);
        }
        #loginBox button {
            width: 100%;
            padding: 10px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            margin-bottom: 8px;
        }
        #loginBox button.primary {
            background: var(--accent);
            color: white;
        }
        #loginBox button.secondary {
            background: transparent;
            color: var(--text-soft);
            border: 1px solid rgba(148,163,184,0.4);
        }
        /* App container */
        #appWrapper {
            max-width: 1100px;
            margin: 30px auto;
            padding: 0 16px 40px;
        }
        #appHeader {
            text-align: center;
            margin-bottom: 24px;
        }
        #appHeader h1 {
            margin: 0;
            font-size: 28px;
        }
        #appHeader p {
            margin: 6px 0 0;
            color: var(--text-soft);
            font-size: 14px;
        }
        /* Main card */
        #appCard {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr;
            gap: 20px;
            background: radial-gradient(circle at top left, #1f2937, #020617);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(148,163,184,0.35);
            box-shadow: 0 24px 60px rgba(0,0,0,0.7);
        }
        @media (max-width: 900px) {
            #appCard { grid-template-columns: 1fr; }
        }
        .panelTitle {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-soft);
            margin-bottom: 12px;
        }
        #leftPanel, #rightPanel { position: relative; }
        /* Upload area */
        #uploadArea {
            border: 1px dashed rgba(148,163,184,0.5);
            border-radius: 16px;
            padding: 18px;
            text-align: center;
            background: rgba(15,23,42,0.8);
        }
        #uploadArea h3 {
            margin: 0 0 4px;
            font-size: 16px;
        }
        #uploadArea p {
            margin: 0;
            font-size: 12px;
            color: var(--text-soft);
        }
        #uploadArea input[type=file] {
            margin-top: 12px;
        }
        .previewBox {
            margin-top: 16px;
            background: #020617;
            border-radius: 14px;
            padding: 10px;
            height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(31,41,55,0.9);
            overflow: hidden;
        }
        .previewBox img {
            max-width: 100%;
            max-height: 260px;
            object-fit: contain;
        }
        /* Controls */
        #controls {
            background: rgba(15,23,42,0.9);
            border-radius: 16px;
            padding: 14px 16px;
            border: 1px solid rgba(148,163,184,0.4);
            margin-bottom: 16px;
            font-size: 13px;
        }
        .controlRow { display: flex; align-items: center; margin-bottom: 10px; }
        .controlRow label { flex: 0 0 120px; color: var(--text-soft); }
        .controlRow input[type=range] { flex: 1; }
        .controlRow span.value {
            display: inline-block;
            width: 30px;
            text-align: right;
            margin-left: 8px;
        }
        .pillGroup {
            display: inline-flex;
            background: #020617;
            border-radius: 999px;
            padding: 3px;
        }
        .pillGroup button {
            border: none;
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 999px;
            background: transparent;
            color: var(--text-soft);
            cursor: pointer;
        }
        .pillGroup button.active {
            background: var(--accent);
            color: white;
        }
        #actionButtons {
            display: flex;
            gap: 10px;
            margin-bottom: 6px;
        }
        #actionButtons button {
            flex: 1;
            border-radius: 999px;
            padding: 10px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        #btnPreview { background: var(--accent); color: white; }
        #btnDownload { background: transparent; color: var(--text); border: 1px solid rgba(148,163,184,0.5); }
        #infoBar {
            font-size: 12px;
            color: var(--text-soft);
        }
        #infoBar strong { color: #fbbf24; }
        /* WhatsApp box */
        #whatsappBox {
            margin-top: 14px;
            background: rgba(30,64,175,0.3);
            border-radius: 12px;
            padding: 12px;
            border: 1px dashed #3b82f6;
            display: none;
        }
        #whatsappBox a {
            display: inline-block;
            margin-top: 6px;
            background: #25d366;
            color: white;
            text-decoration: none;
            padding: 8px 14px;
            border-radius: 999px;
            font-size: 13px;
        }
    </style>
</head>
<body>

<!-- TOP BAR -->
<div id="topBar">
    <div id="userStatus">Yükleniyor...</div>
    <div>
        <button id="loginBtn" onclick="openLogin()">Giriş Yap</button>
        <button id="logoutBtn" onclick="logout()" style="display:none;">Çıkış Yap</button>
    </div>
</div>

<!-- LOGIN MODAL -->
<div id="loginModal">
    <div id="loginBox">
        <h2>Giriş Yap</h2>
        <input id="loginEmail" type="email" placeholder="Mail adresiniz">
        <button class="primary" onclick="login()">Giriş Yap</button>
        <button class="secondary" onclick="closeLogin()">Kapat</button>
    </div>
</div>

<!-- APP -->
<div id="appWrapper">
    <div id="appHeader">
        <h1>Akıllı Vektörleştirici</h1>
        <p>Fotoğrafını yükle, renk sayısını seç, cartoon vektör avatarını anında önizle.</p>
    </div>

    <div id="appCard">
        <!-- Sol panel: Orijinal -->
        <div id="leftPanel">
            <div class="panelTitle">Orijinal Görsel</div>
            <div id="uploadArea">
                <h3>Görsel Yükle</h3>
                <p>PNG / JPG / JPEG desteklenir.</p>
                <input type="file" id="uploadInput" accept="image/*" onchange="onFileChange(event)">
                <div class="previewBox">
                    <img id="originalPreview" alt="Orijinal önizleme">
                </div>
            </div>
        </div>

        <!-- Sağ panel: Ayarlar + Çıktı -->
        <div id="rightPanel">
            <div class="panelTitle">Ayarlar & Çıktı</div>

            <div id="controls">
                <div class="controlRow">
                    <label>Stil</label>
                    <div class="pillGroup">
                        <button id="styleCartoon" class="active" onclick="setStyle('cartoon')">Cartoon</button>
                        <!-- İleride başka stiller de ekleriz -->
                    </div>
                </div>

                <div class="controlRow">
                    <label>Renk Sayısı</label>
                    <input id="colorRange" type="range" min="2" max="8" value="4" oninput="updateColorValue(this.value)">
                    <span class="value" id="colorValue">4</span>
                </div>

                <div class="controlRow">
                    <label>Çıktı Türü</label>
                    <div class="pillGroup">
                        <button id="modeColor" class="active" onclick="setMode('color')">Renkli</button>
                        <button id="modeBW" onclick="setMode('bw')">Siyah-Beyaz</button>
                    </div>
                </div>
            </div>

            <div id="actionButtons">
                <button id="btnPreview" onclick="processImage()">Önizle (Vektörleştir)</button>
                <button id="btnDownload" onclick="downloadResult()">İndir</button>
            </div>

            <div id="infoBar">
                Ücretsiz hak: <strong><span id="freeRemaining">-</span></strong>
                <span id="premiumCountdown"></span>
            </div>

            <div id="whatsappBox">
                <div>Ücretsiz hakkınız doldu. Aylık sınırsız erişim için WhatsApp’tan bize yazabilirsiniz.</div>
                <a id="waBtn" target="_blank"
                   href="https://wa.me/905555555555?text=Aylık+vektör+üyeliği+satın+almak+istiyorum">
                    WhatsApp ile İletişime Geç
                </a>
            </div>

            <div class="previewBox" style="margin-top:12px;">
                <img id="resultImage" alt="Vektör önizleme">
            </div>
        </div>
    </div>
</div>

<script>
let currentStyle = 'cartoon';
let currentMode = 'color';
let lastResultData = null;

/* ------- LOGIN MODAL ------- */
function openLogin(){ document.getElementById("loginModal").style.display="flex"; }
function closeLogin(){ document.getElementById("loginModal").style.display="none"; }

/* ------- AUTH ------- */
async function login(){
    const email = document.getElementById("loginEmail").value.trim();
    if(!email) return alert("Mail adresi girin.");
    const res = await fetch("/login", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({email})
    });
    const data = await res.json();
    if(data.success){
        closeLogin();
        loadUserStatus();
    }else{
        alert(data.message || "Üyelik bulunamadı.");
    }
}
async function logout(){
    await fetch("/logout", {method:"POST"});
    loadUserStatus();
}

/* ------- USER STATUS ------- */
async function loadUserStatus(){
    const res = await fetch("/user_status");
    const data = await res.json();
    const statusDiv = document.getElementById("userStatus");
    const freeSpan = document.getElementById("freeRemaining");
    const premiumCountdown = document.getElementById("premiumCountdown");
    premiumCountdown.innerHTML = "";

    document.getElementById("whatsappBox").style.display="none";
    document.getElementById("loginBtn").style.display="inline-block";
    document.getElementById("logoutBtn").style.display="none";

    if(data.logged_in && data.premium){
        statusDiv.innerHTML = `Premium Üye: ${data.email} <span>Aktif</span>`;
        document.getElementById("loginBtn").style.display="none";
        document.getElementById("logoutBtn").style.display="inline-block";
        freeSpan.innerHTML = "Sınırsız";
        startPremiumCountdown(data.end_date);
    } else if(data.logged_in && !data.premium){
        statusDiv.innerHTML = `Premium Süresi Doldu: ${data.email}`;
        freeSpan.innerHTML = data.remaining;
    } else {
        statusDiv.innerHTML = "Misafir Kullanıcı";
        freeSpan.innerHTML = data.remaining;
    }
}

function startPremiumCountdown(endDateStr){
    const el = document.getElementById("premiumCountdown");
    function tick(){
        const end = new Date(endDateStr).getTime();
        const now = Date.now();
        const diff = end - now;
        if(diff <= 0){
            el.innerHTML = " • Premium süresi doldu";
            return;
        }
        const d = Math.floor(diff/(1000*60*60*24));
        const h = Math.floor((diff/(1000*60*60))%24);
        const m = Math.floor((diff/(1000*60))%60);
        el.innerHTML = ` • Premium süreniz: ${d}g ${h}s ${m}dk`;
    }
    tick();
    setInterval(tick, 60000);
}

/* ------- UI CONTROLS ------- */
function updateColorValue(v){
    document.getElementById("colorValue").innerText = v;
}
function setStyle(style){
    currentStyle = style;
    document.getElementById("styleCartoon").classList.toggle("active", style==='cartoon');
}
function setMode(mode){
    currentMode = mode;
    document.getElementById("modeColor").classList.toggle("active", mode==='color');
    document.getElementById("modeBW").classList.toggle("active", mode==='bw');
}

/* ------- FILE PREVIEW ------- */
function onFileChange(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        document.getElementById("originalPreview").src = ev.target.result;
    };
    reader.readAsDataURL(file);
}

/* ------- VECTORIZATION ------- */
async function processImage(){
    const file = document.getElementById("uploadInput").files[0];
    if(!file){
        alert("Önce bir görsel seçmelisiniz.");
        return;
    }
    const formData = new FormData();
    formData.append("image", file);
    formData.append("style", currentStyle);
    formData.append("colors", document.getElementById("colorRange").value);
    formData.append("mode", currentMode);
    formData.append("format", "png");

    const res = await fetch("/vectorize_style", {
        method:"POST",
        body: formData
    });

    const data = await res.json();

    if(!data.success && data.error==="limit_reached"){
        document.getElementById("whatsappBox").style.display="block";
        alert("Ücretsiz hakkınız doldu. Aylık üyelik için WhatsApp’tan bize yazabilirsiniz.");
        return;
    }

    lastResultData = data.image_data;
    document.getElementById("resultImage").src = data.image_data;
    loadUserStatus();
}

/* ------- DOWNLOAD ------- */
function downloadResult(){
    if(!lastResultData){
        alert("Önce bir görseli vektörleştirip önizleyin.");
        return;
    }
    const a = document.createElement("a");
    a.href = lastResultData;
    a.download = "vektor_avatar.png";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

/* ------- INIT ------- */
loadUserStatus();
</script>

</body>
</html>
