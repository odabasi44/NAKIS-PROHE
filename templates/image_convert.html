{% extends "base.html" %}

{% block title %}Format Çevirici{% endblock title %}

{% block head_extra %}
<style>
    .upload-area:hover, .upload-area.dragover { border-color:#22d3ee; background: rgba(34,211,238,.06); }
    .fmt { border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); color: #9ca3af; }
    .fmt:hover { background: rgba(255,255,255,.10); color: #fff; }
    .fmt.active { background: #06b6d4; border-color:#06b6d4; color: #001018; font-weight: 800; }
    .checkerboard {
      background-image: linear-gradient(45deg, #1f2937 25%, transparent 25%),
                        linear-gradient(-45deg, #1f2937 25%, transparent 25%),
                        linear-gradient(45deg, transparent 75%, #1f2937 75%),
                        linear-gradient(-45deg, transparent 75%, #1f2937 75%);
      background-size: 20px 20px;
      background-color: #111827;
    }
</style>
{% endblock head_extra %}

{% block content %}
<main class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 py-10">
    <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-white">Format Çevirici</h1>
        <p class="mt-2 text-gray-400">Yükle → format seç → dönüştür → indir.</p>
    </div>

    <div id="status-bar" class="glass rounded-2xl p-4 mb-6 flex items-center justify-between border border-white/5">
        <div class="flex items-center gap-3">
            <span id="status-icon" class="h-2 w-2 rounded-full bg-gray-500 animate-pulse"></span>
            <div id="limit-info" class="text-sm text-gray-300">Limitler kontrol ediliyor...</div>
        </div>
        <div class="text-xs text-gray-500">Max: 10MB</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <section class="glass rounded-2xl p-6">
            <div id="dropZone" class="upload-area rounded-xl p-8 text-center cursor-pointer">
                <input type="file" id="fileInput" accept="image/*" class="hidden" />
                <div class="mx-auto mb-3 h-14 w-14 rounded-2xl bg-cyan-500/10 text-cyan-300 flex items-center justify-center">
                    <svg class="h-7 w-7" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
                </div>
                <div class="text-white font-bold">Resim seç / sürükle</div>
                <div id="fileName" class="mt-2 text-xs text-gray-500">Henüz dosya yok</div>
                <button type="button" class="mt-4 inline-flex items-center justify-center rounded-xl bg-cyan-600 hover:bg-cyan-700 transition px-6 py-2.5 font-bold text-white">Seç</button>
            </div>

            <div class="mt-6 rounded-2xl border border-white/10 bg-white/5 p-5">
                <div class="text-sm font-bold text-white mb-3">Hedef Format</div>
                <div class="grid grid-cols-4 gap-2">
                    <button type="button" class="fmt active rounded-xl py-2 text-xs" data-fmt="jpeg">JPG</button>
                    <button type="button" class="fmt rounded-xl py-2 text-xs" data-fmt="png">PNG</button>
                    <button type="button" class="fmt rounded-xl py-2 text-xs" data-fmt="webp">WEBP</button>
                    <button type="button" class="fmt rounded-xl py-2 text-xs" data-fmt="pdf">PDF</button>
                </div>
            </div>

            <button id="processBtn" type="button" class="mt-5 w-full rounded-xl bg-white text-black font-bold py-3 hover:bg-gray-200 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Dönüştür
            </button>
        </section>

        <section class="glass rounded-2xl p-6 relative overflow-hidden min-h-[420px]">
            <div id="placeholder" class="h-full flex flex-col items-center justify-center text-center text-gray-500">
                <svg class="h-14 w-14 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="1.5" stroke-linecap="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14"/></svg>
                <div class="mt-3 text-white font-bold">Sonuç</div>
                <div class="mt-1 text-sm text-gray-400">Dönüştürülen çıktı burada görünür</div>
            </div>

            <div id="loading" class="hidden absolute inset-0 bg-[#0c1120]/90 z-20 flex flex-col items-center justify-center backdrop-blur-sm">
                <div class="w-14 h-14 border-4 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin mb-3"></div>
                <div class="text-white font-semibold">Dönüştürülüyor...</div>
            </div>

            <div id="result" class="hidden h-full flex flex-col">
                <div id="previewBox" class="flex-1 rounded-xl bg-black/30 overflow-hidden flex items-center justify-center checkerboard">
                    <img id="resultImg" class="max-h-[320px] object-contain" alt="Çıktı" />
                </div>
                <div class="mt-4 text-center text-xs text-gray-400">Yeni format: <span id="fmtText" class="text-white font-bold uppercase">JPG</span></div>
                <a id="downloadBtn" class="mt-4 w-full rounded-xl bg-green-600 hover:bg-green-700 transition py-3 font-bold text-white text-center" href="#" download>
                    İndir
                </a>
            </div>
        </section>
    </div>
</main>

<script>
    const els = {
        drop: document.getElementById('dropZone'),
        input: document.getElementById('fileInput'),
        name: document.getElementById('fileName'),
        btn: document.getElementById('processBtn'),
        loading: document.getElementById('loading'),
        placeholder: document.getElementById('placeholder'),
        result: document.getElementById('result'),
        img: document.getElementById('resultImg'),
        dl: document.getElementById('downloadBtn'),
        fmtText: document.getElementById('fmtText'),
        previewBox: document.getElementById('previewBox'),
        fmtButtons: Array.from(document.querySelectorAll('.fmt')),
        statusIcon: document.getElementById('status-icon'),
        limitInfo: document.getElementById('limit-info'),
    };

    let file = null;
    let fmt = 'jpeg';
    let userAllowed = false;

    function setBusy(b) {
        els.loading.classList.toggle('hidden', !b);
        els.btn.disabled = b || !file || !userAllowed;
        els.btn.textContent = b ? 'Dönüştürülüyor...' : 'Dönüştür';
    }

    function setFmt(next) {
        fmt = next;
        els.fmtText.textContent = (next === 'jpeg' ? 'jpg' : next).toUpperCase();
        els.fmtButtons.forEach(b => b.classList.toggle('active', b.dataset.fmt === next));
    }

    function handleFile(f) {
        if (!f) return;
        if (!f.type.startsWith('image/')) return;
        file = f;
        els.name.textContent = `${f.name} • ${(f.size / 1024 / 1024).toFixed(2)}MB`;
        els.btn.disabled = !userAllowed;
    }

    async function checkLimit() {
        try {
            const res = await fetch('/api/check_tool_status/image/convert');
            const data = await res.json();
            userAllowed = !!data.allowed;
            if (data.allowed) {
                els.statusIcon.className = "h-2 w-2 rounded-full bg-green-500";
                els.limitInfo.innerHTML = data.premium
                    ? `<span class="text-green-400">Premium Aktif</span>`
                    : `Kalan Hakkınız: <span class="text-green-400 font-bold">${data.left}</span>`;
                els.btn.disabled = !file;
            } else {
                els.statusIcon.className = "h-2 w-2 rounded-full bg-red-500";
                els.limitInfo.innerHTML = `⛔ Limit Doldu. <a onclick="openModal('premiumModal')" class="text-blue-400 cursor-pointer">Premium Al</a>`;
                els.btn.disabled = true;
            }
        } catch (e) {
            console.error(e);
        }
    }

    async function processConvert() {
        if (!file) return alert('Lütfen resim seçin.');
        if (!userAllowed) return openModal('premiumModal');

        setBusy(true);
        const formData = new FormData();
        formData.append('image', file);
        formData.append('format', fmt);

        try {
            const res = await fetch('/api/img/convert', { method: 'POST', body: formData });
            const data = await res.json();
            setBusy(false);

            if (!data.success) {
                alert(data.message || "Hata oluştu.");
                if (data.reason === 'limit') openModal('premiumModal');
                return;
            }

            els.placeholder.classList.add('hidden');
            els.result.classList.remove('hidden');

            // mime
            let mime = 'image/jpeg';
            if (fmt === 'png') mime = 'image/png';
            if (fmt === 'webp') mime = 'image/webp';
            if (fmt === 'pdf') mime = 'application/pdf';

            const src = `data:${mime};base64,` + data.file;

            if (fmt === 'pdf') {
                els.previewBox.innerHTML = `
                    <div class="text-center p-10">
                        <svg class="w-16 h-16 text-red-400 mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" stroke-linecap="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                        <div class="text-white font-bold">PDF Hazır</div>
                        <div class="text-sm text-gray-400 mt-1">İndirmek için butona bas</div>
                    </div>`;
            } else {
                if (!els.previewBox.querySelector('img')) {
                    els.previewBox.innerHTML = '<img id="resultImg" class="max-h-[320px] object-contain" alt="Çıktı" />';
                    els.img = document.getElementById('resultImg');
                }
                els.img.src = src;
            }

            const ext = fmt === 'jpeg' ? 'jpg' : fmt;
            els.dl.href = src;
            els.dl.download = (file.name.split('.')[0] || 'converted') + '.' + ext;

            await checkLimit();
        } catch (e) {
            console.error(e);
            setBusy(false);
            alert('Sunucu hatası.');
        }
    }

    // wiring
    els.fmtButtons.forEach(b => b.addEventListener('click', () => setFmt(b.dataset.fmt)));
    els.drop.addEventListener('click', () => userAllowed ? els.input.click() : openModal('premiumModal'));
    els.input.addEventListener('change', (e) => handleFile(e.target.files?.[0]));
    els.drop.addEventListener('dragover', (e) => { e.preventDefault(); els.drop.classList.add('dragover'); });
    els.drop.addEventListener('dragleave', () => els.drop.classList.remove('dragover'));
    els.drop.addEventListener('drop', (e) => { e.preventDefault(); els.drop.classList.remove('dragover'); if (userAllowed) handleFile(e.dataTransfer.files?.[0]); else openModal('premiumModal'); });
    els.btn.addEventListener('click', processConvert);

    document.addEventListener('DOMContentLoaded', () => {
        setFmt('jpeg');
        checkLimit();
    });
</script>
{% endblock content %}
