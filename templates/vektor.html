{% extends "base.html" %}

{% block title %}AI Nakƒ±≈ü & Vekt√∂r St√ºdyosu{% endblock title %}

{% block head_extra %}
<style>
    /* MOD KARTLARI */
    .mode-card { transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden; }
    .mode-card:hover { transform: translateY(-5px); border-color: #8b5cf6; }
    .mode-card.selected { background: linear-gradient(145deg, rgba(139,92,246,0.15), rgba(17,24,39,0.9)); border-color: #8b5cf6; box-shadow: 0 0 0 2px rgba(139,92,246,0.5); }
    
    /* RADYO & CHECKBOX */
    input[type="radio"]:checked + div { border-color: #8b5cf6; background-color: rgba(139, 92, 246, 0.1); }
    input[type="radio"]:checked + div span { color: white; }
    
    /* KALƒ∞TE BUTONLARI */
    .quality-btn.active { background: rgba(139,92,246,0.2); border-color: #8b5cf6; color: white; }
    
    /* LOADING ANIMASYONU */
    .scan-line { position: absolute; width: 100%; height: 2px; background: #8b5cf6; box-shadow: 0 0 15px #8b5cf6; animation: scan 2s linear infinite; }
    @keyframes scan { 0% {top: 0%} 50% {top: 100%} 100% {top: 0%} }
</style>
{% endblock head_extra %}

{% block content %}
<div class="w-full max-w-6xl mx-auto space-y-12 pb-20">

    <div class="text-center animate-fade-in">
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">AI <span class="text-transparent bg-clip-text bg-gradient-to-r from-violet-400 to-fuchsia-400">Nakƒ±≈ü St√ºdyosu</span></h1>
        <p class="text-gray-400">G√∂rselinizi y√ºkleyin, ERC v4 motoru ile nakƒ±≈üa uygun vekt√∂r √ßizimini hazƒ±rlayƒ±n.</p>
    </div>

    <div id="step-1" class="animate-fade-in">
        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 ml-1">1. Ne D√∂n√º≈üt√ºreceksiniz?</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div onclick="selectMode('logo')" id="card-logo" class="mode-card bg-[#0c1120] border border-white/10 rounded-2xl p-6 flex items-start gap-5">
                <div class="w-14 h-14 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400 shrink-0">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </div>
                <div><h4 class="text-lg font-bold text-white">Logo & Grafik</h4><p class="text-sm text-gray-400">Keskin hatlar, net renk ayrƒ±mƒ±.</p></div>
            </div>
            <div onclick="selectMode('photo')" id="card-photo" class="mode-card bg-[#0c1120] border border-white/10 rounded-2xl p-6 flex items-start gap-5">
                <div class="w-14 h-14 rounded-xl bg-fuchsia-500/10 flex items-center justify-center text-fuchsia-400 shrink-0">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                </div>
                <div><h4 class="text-lg font-bold text-white">Fotoƒüraf & Resim</h4><p class="text-sm text-gray-400">ERC v4 Cartoon motoru ile nakƒ±≈ü stili.</p></div>
            </div>
        </div>
    </div>

    <div id="step-upload" class="hidden animate-fade-in">
        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 ml-1">2. G√∂rseli Y√ºkle</h3>
        <div class="glass-panel rounded-2xl p-8 border border-white/10 bg-gray-900/50">
            <div id="dropZone" class="border-2 border-dashed border-white/10 rounded-xl p-12 text-center hover:border-violet-500/50 hover:bg-white/5 transition cursor-pointer" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFile(this.files[0])">
                <p class="text-gray-400 font-medium">G√∂rseli buraya bƒ±rakƒ±n veya tƒ±klayƒ±n</p>
                <p class="text-xs text-gray-600 mt-2">JPG, PNG, WEBP (Max 15MB)</p>
            </div>

            <div id="preview-area" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1">
                    <img id="img-preview" class="rounded-xl w-full border border-white/10">
                    <button onclick="resetUpload()" class="mt-2 text-xs text-red-400 hover:text-red-300">G√∂rseli Deƒüi≈ütir</button>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white/5 p-5 rounded-xl border border-white/5">
                        <label class="text-xs font-bold text-gray-400 mb-3 block">Detay Seviyesi</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="setQuality('medium')" id="q-medium" class="quality-btn py-3 rounded-lg border border-white/10 text-xs hover:bg-white/5">Basit</button>
                            <button onclick="setQuality('high')" id="q-high" class="quality-btn active py-3 rounded-lg border border-white/10 text-xs hover:bg-white/5">Dengeli</button>
                            <button onclick="setQuality('ultra')" id="q-ultra" class="quality-btn py-3 rounded-lg border border-white/10 text-xs hover:bg-white/5">Y√ºksek</button>
                        </div>
                    </div>
                    <button onclick="startProcessing()" class="w-full py-4 rounded-xl bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white font-bold shadow-lg shadow-violet-900/30 hover:opacity-90 transition">Vekt√∂rle≈ütirmeyi Ba≈ülat</button>
                </div>
            </div>
        </div>
    </div>

    <div id="result-screen" class="hidden animate-fade-in">
        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 ml-1">3. Sonu√ß ve Nakƒ±≈ü Dosyasƒ±</h3>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="glass-panel rounded-2xl p-2 bg-[#111827] flex items-center justify-center min-h-[500px] border border-white/10">
                    <img id="final-result-img" class="max-w-full max-h-[600px] object-contain">
                </div>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <button onclick="downloadVector()" class="py-3 bg-white/5 text-white rounded-lg hover:bg-white/10 border border-white/10">SVG ƒ∞ndir</button>
                    <button onclick="downloadPNG()" class="py-3 bg-white/5 text-white rounded-lg hover:bg-white/10 border border-white/10">PNG ƒ∞ndir</button>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="glass-panel rounded-2xl p-5 border border-violet-500/30 bg-gradient-to-b from-violet-900/10 to-[#0c1120] h-full flex flex-col">
                    <div class="flex items-center gap-3 mb-6 pb-4 border-b border-white/5">
                        <div class="w-10 h-10 rounded-lg bg-violet-600 flex items-center justify-center text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg></div>
                        <div><h4 class="text-sm font-bold text-white">Nakƒ±≈ü D√∂n√º≈üt√ºr√ºc√º</h4><span class="text-[10px] text-violet-300">Auto-Digitize v4</span></div>
                    </div>

                    <div class="flex bg-black/40 p-1 rounded-lg mb-4">
                        <button onclick="switchTab('drawing')" id="tab-drawing" class="flex-1 py-2 text-xs font-bold bg-violet-600 text-white rounded-md transition">√áizim</button>
                        <button onclick="switchTab('machine')" id="tab-machine" class="flex-1 py-2 text-xs font-bold text-gray-400 hover:text-white rounded-md transition">Makine</button>
                    </div>

                    <div id="content-drawing" class="space-y-3 flex-grow">
                        <label class="block p-3 border border-white/10 rounded-lg bg-white/5 cursor-pointer hover:bg-white/10 transition">
                            <input type="radio" name="emb_format" value="emb" checked class="hidden">
                            <div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-300">.EMB</span><span class="text-[9px] text-gray-500 bg-white/5 px-2 py-1 rounded">Wilcom</span></div>
                        </label>
                        <label class="block p-3 border border-white/10 rounded-lg bg-white/5 cursor-pointer hover:bg-white/10 transition">
                            <input type="radio" name="emb_format" value="dst" class="hidden">
                            <div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-300">.SVG</span><span class="text-[9px] text-gray-500 bg-white/5 px-2 py-1 rounded">Vekt√∂r</span></div>
                        </label>
                    </div>

                    <div id="content-machine" class="hidden space-y-4 flex-grow">
                        <select id="machine-format-select" class="w-full bg-[#02040a] border border-white/10 text-gray-300 text-sm rounded-lg p-3 focus:border-violet-500 outline-none">
                            <option value="dst">DST - Tajima</option>
                            <option value="pes">PES - Brother</option>
                            <option value="jef">JEF - Janome</option>
                        </select>
                        <p class="text-[10px] text-yellow-200 bg-yellow-500/10 p-2 rounded border border-yellow-500/20">‚ö†Ô∏è Makine dosyalarƒ±nda renk bilgisi kaybolabilir.</p>
                    </div>

                    <button onclick="convertEmbroidery()" class="w-full py-3 mt-auto bg-white text-black font-bold rounded-xl hover:bg-gray-200 transition">D√∂n√º≈üt√ºr ve ƒ∞ndir</button>
                </div>
            </div>
        </div>
    </div>

    <div id="processing-overlay" class="hidden fixed inset-0 bg-[#02040a]/95 z-[60] flex flex-col items-center justify-center backdrop-blur-md">
        <div class="w-64 h-64 relative rounded-2xl overflow-hidden mb-6 border border-white/10 bg-black">
            <img id="process-preview-img" class="w-full h-full object-cover opacity-40">
            <div class="scan-line"></div>
        </div>
        <h3 class="text-xl font-bold text-white animate-pulse">ƒ∞≈üleniyor...</h3>
        <p class="text-sm text-gray-400 mt-2">ERC v4 motoru √ßalƒ±≈üƒ±yor</p>
    </div>

</div>

<script>
    let currentMode = null, currentQuality = 'high', selectedFile = null, vectorData = null, pngData = null;

    function selectMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-card').forEach(el => el.classList.remove('selected'));
        document.getElementById('card-' + mode).classList.add('selected');
        document.getElementById('step-upload').classList.remove('hidden');
        setTimeout(() => document.getElementById('step-upload').scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
    }

    function setQuality(q) {
        currentQuality = q;
        document.querySelectorAll('.quality-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('q-' + q).classList.add('active');
    }

    function handleFile(file) {
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('img-preview').src = e.target.result;
            document.getElementById('process-preview-img').src = e.target.result;
            document.getElementById('dropZone').classList.add('hidden');
            document.getElementById('preview-area').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    function resetUpload() {
        selectedFile = null;
        document.getElementById('preview-area').classList.add('hidden');
        document.getElementById('dropZone').classList.remove('hidden');
        document.getElementById('fileInput').value = '';
    }

    async function startProcessing() {
        if (!selectedFile) return alert("Dosya se√ßin!");
        document.getElementById('processing-overlay').classList.remove('hidden');

        const formData = new FormData();
        formData.append('image', selectedFile);
        formData.append('method', currentMode === 'logo' ? 'outline' : 'cartoon');
        
        let thickness = 2, count = 16;
        if (currentQuality === 'medium') { thickness = 3; count = 8; }
        else if (currentQuality === 'ultra') { thickness = 1; count = 32; }
        
        formData.append('edge_thickness', thickness);
        formData.append('color_count', count);
        formData.append('style', 'cartoon');

        try {
            const res = await fetch('/api/vectorize', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) {
                vectorData = data.file;
                pngData = data.preview_img;
                document.getElementById('final-result-img').src = "data:image/png;base64," + pngData;
                document.getElementById('processing-overlay').classList.add('hidden');
                document.getElementById('result-screen').classList.remove('hidden');
            } else {
                alert("Hata: " + data.message);
                document.getElementById('processing-overlay').classList.add('hidden');
            }
        } catch (e) {
            console.error(e);
            alert("Sunucu hatasƒ±!");
            document.getElementById('processing-overlay').classList.add('hidden');
        }
    }

    function switchTab(tab) {
        const draw = document.getElementById('content-drawing');
        const mach = document.getElementById('content-machine');
        const btnDraw = document.getElementById('tab-drawing');
        const btnMach = document.getElementById('tab-machine');

        if (tab === 'drawing') {
            draw.classList.remove('hidden'); mach.classList.add('hidden');
            btnDraw.className = "flex-1 py-2 text-xs font-bold bg-violet-600 text-white rounded-md shadow-md";
            btnMach.className = "flex-1 py-2 text-xs font-bold text-gray-400 hover:text-white rounded-md";
        } else {
            draw.classList.add('hidden'); mach.classList.remove('hidden');
            btnMach.className = "flex-1 py-2 text-xs font-bold bg-blue-600 text-white rounded-md shadow-md";
            btnDraw.className = "flex-1 py-2 text-xs font-bold text-gray-400 hover:text-white rounded-md";
        }
    }

    function convertEmbroidery() {
        if (!vectorData) return alert("Vekt√∂r yok!");
        alert("üöß Nakƒ±≈ü mod√ºl√º (pyembroidery) bir sonraki a≈üamada backend'e eklenecek.");
    }

    function downloadVector() { if(vectorData) { const a = document.createElement('a'); a.href = "data:image/svg+xml;base64," + vectorData; a.download = "vektor.svg"; a.click(); } }
    function downloadPNG() { if(pngData) { const a = document.createElement('a'); a.href = "data:image/png;base64," + pngData; a.download = "preview.png"; a.click(); } }
</script>
{% endblock content %}
