{% extends "base.html" %}

{% block title %}AI NakÄ±ÅŸ & VektÃ¶r StÃ¼dyosu{% endblock title %}

{% block head_extra %}
<style>
    /* MOD KARTLARI */
    .mode-card { transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden; }
    .mode-card:hover { transform: translateY(-5px); border-color: #8b5cf6; }
    .mode-card.selected { background: linear-gradient(145deg, rgba(139,92,246,0.15), rgba(17,24,39,0.9)); border-color: #8b5cf6; box-shadow: 0 0 0 2px rgba(139,92,246,0.5); }
    
    /* RADYO & CHECKBOX */
    input[type="radio"]:checked + div { border-color: #8b5cf6; background-color: rgba(139, 92, 246, 0.1); }
    input[type="radio"]:checked + div span { color: white; }
    
    /* KALÄ°TE BUTONLARI */
    .quality-btn.active { background: rgba(139,92,246,0.2); border-color: #8b5cf6; color: white; }
    
    /* LOADING ANIMASYONU */
    .scan-line { position: absolute; width: 100%; height: 2px; background: #8b5cf6; box-shadow: 0 0 15px #8b5cf6; animation: scan 2s linear infinite; }
    @keyframes scan { 0% {top: 0%} 50% {top: 100%} 100% {top: 0%} }
</style>
{% endblock head_extra %}

{% block content %}
<div class="w-full max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 space-y-12 pb-20">

    <div class="text-center animate-fade-in">
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">AI <span class="text-transparent bg-clip-text bg-gradient-to-r from-violet-400 to-fuchsia-400">NakÄ±ÅŸ StÃ¼dyosu</span></h1>
        <p class="text-gray-400">GÃ¶rselinizi yÃ¼kleyin, ERC v4 motoru ile nakÄ±ÅŸa uygun vektÃ¶r Ã§izimini hazÄ±rlayÄ±n.</p>
    </div>

    <!-- LÄ°MÄ°T / PAKET BÄ°LGÄ°SÄ° -->
    <div id="limitBox" class="hidden max-w-3xl mx-auto p-4 rounded-xl border border-white/10 bg-gray-900/40 text-sm text-gray-200"></div>

    <div id="step-1" class="animate-fade-in">
        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 ml-1">1. Ne DÃ¶nÃ¼ÅŸtÃ¼receksiniz?</h3>
        <!-- Desteklenen GÃ¶rsel Tipleri Bildirimi -->
        <div class="mb-6 p-4 rounded-xl bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-500/20">
            <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-blue-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
                <div class="text-sm">
                    <p class="text-gray-300 font-medium mb-1">En Ä°yi SonuÃ§ AlabileceÄŸiniz GÃ¶rsel Tipleri:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-gray-400">
                        <div>
                            <span class="text-blue-400 font-semibold">Logo & Grafik iÃ§in:</span>
                            <ul class="ml-4 mt-1 space-y-1">
                                <li>â€¢ Net hatlÄ± logolar ve amblemler</li>
                                <li>â€¢ Az renkli (2-5 renk) tasarÄ±mlar</li>
                                <li>â€¢ VektÃ¶r formatlarÄ± (SVG, AI, EPS)</li>
                                <li>â€¢ YÃ¼ksek Ã§Ã¶zÃ¼nÃ¼rlÃ¼klÃ¼ PNG'ler</li>
                            </ul>
                        </div>
                        <div>
                            <span class="text-purple-400 font-semibold">FotoÄŸraf & Resim iÃ§in:</span>
                            <ul class="ml-4 mt-1 space-y-1">
                                <li>â€¢ Portre fotoÄŸraflarÄ± (yÃ¼z net)</li>
                                <li>â€¢ KarikatÃ¼r ve Ã§izimler</li>
                                <li>â€¢ Basit arka planlÄ± resimler</li>
                                <li>â€¢ 300+ DPI Ã§Ã¶zÃ¼nÃ¼rlÃ¼k</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div onclick="selectMode('logo')" id="card-logo" class="mode-card bg-[#0c1120] border border-white/10 rounded-2xl p-6 flex items-start gap-5">
                <div class="w-14 h-14 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400 shrink-0">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </div>
                <div><h4 class="text-lg font-bold text-white">Logo & Grafik</h4><p class="text-sm text-gray-400">Keskin hatlar, net renk ayrÄ±mÄ±.</p></div>
            </div>
            <div onclick="selectMode('photo')" id="card-photo" class="mode-card bg-[#0c1120] border border-white/10 rounded-2xl p-6 flex items-start gap-5">
                <div class="w-14 h-14 rounded-xl bg-fuchsia-500/10 flex items-center justify-center text-fuchsia-400 shrink-0">
                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                </div>
                <div><h4 class="text-lg font-bold text-white">FotoÄŸraf & Resim</h4><p class="text-sm text-gray-400">ERC v4 Cartoon motoru ile nakÄ±ÅŸ stili.</p></div>
            </div>
        </div>
    </div>

    <div id="step-upload" class="hidden animate-fade-in">
        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 ml-1">2. GÃ¶rseli YÃ¼kle</h3>
        <div class="glass-panel rounded-2xl p-8 border border-white/10 bg-gray-900/50">
            <div id="dropZone" class="border-2 border-dashed border-white/10 rounded-xl p-12 text-center hover:border-violet-500/50 hover:bg-white/5 transition cursor-pointer" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFile(this.files[0])">
                <p class="text-gray-400 font-medium">GÃ¶rseli buraya bÄ±rakÄ±n veya tÄ±klayÄ±n</p>
                <p class="text-xs text-gray-600 mt-2">JPG, PNG, WEBP (Max 15MB)</p>
            </div>

            <div id="preview-area" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1">
                    <img id="img-preview" class="rounded-xl w-full border border-white/10">
                    <button onclick="resetUpload()" class="mt-2 text-xs text-red-400 hover:text-red-300">GÃ¶rseli DeÄŸiÅŸtir</button>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white/5 p-5 rounded-xl border border-white/5">
                        <label class="text-xs font-bold text-gray-400 mb-3 block">Detay Seviyesi</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="setQuality('medium')" id="q-medium" class="quality-btn py-3 rounded-lg border border-white/10 text-xs hover:bg-white/5">Basit</button>
                            <button onclick="setQuality('high')" id="q-high" class="quality-btn active py-3 rounded-lg border border-white/10 text-xs hover:bg-white/5">Dengeli</button>
                            <button onclick="setQuality('ultra')" id="q-ultra" class="quality-btn py-3 rounded-lg border border-white/10 text-xs hover:bg-white/5">YÃ¼ksek</button>
                        </div>
                        <div id="quality-info" class="mt-3 text-[11px] text-gray-400 bg-black/20 border border-white/10 rounded-lg px-3 py-2"></div>
                    </div>
                    <button onclick="startProcessing()" class="w-full py-4 rounded-xl bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white font-bold shadow-lg shadow-violet-900/30 hover:opacity-90 transition">VektÃ¶rleÅŸtirmeyi BaÅŸlat</button>
                </div>
            </div>
        </div>
    </div>

    <div id="result-screen" class="hidden animate-fade-in">
        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 ml-1">3. SonuÃ§ ve NakÄ±ÅŸ DosyasÄ±</h3>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="glass-panel rounded-2xl p-2 bg-[#111827] flex items-center justify-center min-h-[500px] border border-white/10">
                    <img id="final-result-img" class="max-w-full max-h-[600px] object-contain">
                </div>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <button onclick="downloadEPS()" class="py-3 bg-white/5 text-white rounded-lg hover:bg-white/10 border border-white/10">EPS Ä°ndir</button>
                    <button onclick="downloadPNG()" class="py-3 bg-white/5 text-white rounded-lg hover:bg-white/10 border border-white/10">PNG Ä°ndir</button>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="glass-panel rounded-2xl p-5 border border-violet-500/30 bg-gradient-to-b from-violet-900/10 to-[#0c1120] h-full flex flex-col">
                    <div class="flex items-center gap-3 mb-6 pb-4 border-b border-white/5">
                        <div class="w-10 h-10 rounded-lg bg-violet-600 flex items-center justify-center text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg></div>
                        <div><h4 class="text-sm font-bold text-white">NakÄ±ÅŸ DÃ¶nÃ¼ÅŸtÃ¼rÃ¼cÃ¼</h4><span class="text-[10px] text-violet-300">Auto-Digitize v4</span></div>
                    </div>

                    <div class="flex bg-black/40 p-1 rounded-lg mb-4">
                        <button onclick="switchTab('drawing')" id="tab-drawing" class="flex-1 py-2 text-xs font-bold bg-violet-600 text-white rounded-md transition">Ã‡izim</button>
                        <button onclick="switchTab('machine')" id="tab-machine" class="flex-1 py-2 text-xs font-bold text-gray-400 hover:text-white rounded-md transition">Makine</button>
                    </div>

                    <div id="content-drawing" class="space-y-3 flex-grow">
                        <label class="block p-3 border border-white/10 rounded-lg bg-white/5 cursor-pointer hover:bg-white/10 transition">
                            <input type="radio" name="emb_format" value="bot" checked class="hidden">
                            <div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-300">.BOT</span><span class="text-[9px] text-gray-500 bg-white/5 px-2 py-1 rounded">Editable</span></div>
                        </label>
                        <p class="text-[10px] text-gray-400 bg-white/5 p-2 rounded border border-white/10">BOT dosyasÄ± Wilcomâ€™da direkt aÃ§Ä±lmaz. Botlab iÃ§inde dÃ¼zenlemek iÃ§indir.</p>
                    </div>

                    <div id="content-machine" class="hidden space-y-4 flex-grow">
                        <select id="machine-format-select" class="w-full bg-[#02040a] border border-white/10 text-gray-300 text-sm rounded-lg p-3 focus:border-violet-500 outline-none">
                            <option value="dst">DST - Tajima</option>
                            <option value="pes">PES - Brother</option>
                            <option value="jef">JEF - Janome</option>
                            <option value="exp">EXP - Melco</option>
                            <option value="xxx">XXX - Singer</option>
                            <option value="vp3">VP3 - Husqvarna</option>
                        </select>
                        <p class="text-[10px] text-yellow-200 bg-yellow-500/10 p-2 rounded border border-yellow-500/20">âš ï¸ Makine dosyalarÄ±nda renk bilgisi kaybolabilir.</p>
                        <p class="text-[10px] text-orange-200 bg-orange-500/10 p-2 rounded border border-orange-500/20 mt-2">
                            ğŸ§ª Bu Ã¶zellik test aÅŸamasÄ±ndadÄ±r. Stabil nakÄ±ÅŸ formatlarÄ±nda (DST, PES, JEF vb.) Ã§Ä±ktÄ± vermeyebilir. LÃ¼tfen sonuÃ§larÄ± kontrol edin.
                        </p>
                    </div>

                    <button onclick="convertEmbroidery()" class="w-full py-3 mt-auto bg-white text-black font-bold rounded-xl hover:bg-gray-200 transition">DÃ¶nÃ¼ÅŸtÃ¼r ve Ä°ndir</button>
                </div>
            </div>
        </div>
    </div>

    <div id="processing-overlay" class="hidden fixed inset-0 bg-[#02040a]/95 z-[60] flex flex-col items-center justify-center backdrop-blur-md">
        <div class="w-64 h-64 relative rounded-2xl overflow-hidden mb-6 border border-white/10 bg-black">
            <img id="process-preview-img" class="w-full h-full object-cover opacity-40">
            <div class="scan-line"></div>
        </div>
        <h3 class="text-xl font-bold text-white animate-pulse">Ä°ÅŸleniyor...</h3>
        <p class="text-sm text-gray-400 mt-2">ERC v4 motoru Ã§alÄ±ÅŸÄ±yor</p>
    </div>

</div>

<script>
    let currentMode = null, currentQuality = 'high', selectedFile = null, vectorData = null, epsData = null, botData = null, pngData = null, engineId = null;
    let vectorAllowed = true;

    function getQualityPreset(mode, quality) {
        // Not: mode'a gÃ¶re preset deÄŸiÅŸir. Logo'da renk sayÄ±sÄ± belirleyici; fotoÄŸrafta hem renk hem kontur.
        if (mode === 'logo') {
            // Logo/Grafik: node azaltma iÃ§in daha agresif simplify + kÃ¼Ã§Ã¼k parÃ§alarÄ± atma (min_area) iÅŸe yarar.
            if (quality === 'medium') return {
                name: 'Basit', color_count: 2, edge_thickness: 2, border_sensitivity: 14, style: 'flat',
                simplify_factor: 0.010, min_area: 40, cleanup_kernel: 5,
                desc: 'En az renk â€¢ En temiz, tek parÃ§a alanlar â€¢ Daha az node.'
            };
            if (quality === 'ultra')  return {
                name: 'YÃ¼ksek', color_count: 5, edge_thickness: 2, border_sensitivity: 12, style: 'flat',
                simplify_factor: 0.004, min_area: 15, cleanup_kernel: 3,
                desc: 'Daha Ã§ok renk â€¢ Daha fazla detay/katman â€¢ Daha Ã§ok node.'
            };
            return {
                name: 'Dengeli', color_count: 3, edge_thickness: 2, border_sensitivity: 13, style: 'flat',
                simplify_factor: 0.006, min_area: 25, cleanup_kernel: 3,
                desc: 'Orta seviye renk â€¢ Logo iÃ§in ideal denge â€¢ Dengeli node.'
            };
        }

        // photo
        if (quality === 'medium') return { name: 'Basit', color_count: 2, edge_thickness: 3, border_sensitivity: 16, style: 'flat', simplify_factor: 0.006, min_area: 35, cleanup_kernel: 5, desc: '2 renk â€¢ Daha kalÄ±n kontur â€¢ Daha sade.' };
        if (quality === 'ultra')  return { name: 'YÃ¼ksek', color_count: 8, edge_thickness: 1, border_sensitivity: 10, style: 'flat', simplify_factor: 0.004, min_area: 18, cleanup_kernel: 3, desc: '8 renk â€¢ Ä°nce kontur â€¢ Daha fazla yÃ¼z/giysi detayÄ±.' };
        return { name: 'Dengeli', color_count: 3, edge_thickness: 2, border_sensitivity: 12, style: 'flat', simplify_factor: 0.005, min_area: 25, cleanup_kernel: 3, desc: '3 renk â€¢ Dengeli kontur â€¢ Genel kullanÄ±m.' };
    }

    function updateQualityInfo() {
        const box = document.getElementById('quality-info');
        if (!box) return;
        if (!currentMode) {
            box.textContent = 'Ã–nce mod seÃ§in (Logo & Grafik / FotoÄŸraf & Resim).';
            return;
        }
        const p = getQualityPreset(currentMode, currentQuality);
        box.innerHTML = `<span class="font-bold text-white">${p.name}</span> â€¢ <span class="font-bold text-violet-300">${p.color_count} renk</span> â€¢ ${p.desc}`;
    }

    function selectMode(mode) {
        currentMode = mode;
        document.querySelectorAll('.mode-card').forEach(el => el.classList.remove('selected'));
        document.getElementById('card-' + mode).classList.add('selected');
        document.getElementById('step-upload').classList.remove('hidden');
        updateQualityInfo();
        setTimeout(() => document.getElementById('step-upload').scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
    }

    function setQuality(q) {
        currentQuality = q;
        document.querySelectorAll('.quality-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('q-' + q).classList.add('active');
        updateQualityInfo();
    }

    function handleFile(file) {
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('img-preview').src = e.target.result;
            document.getElementById('process-preview-img').src = e.target.result;
            document.getElementById('dropZone').classList.add('hidden');
            document.getElementById('preview-area').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    function resetUpload() {
        selectedFile = null;
        document.getElementById('preview-area').classList.add('hidden');
        document.getElementById('dropZone').classList.remove('hidden');
        document.getElementById('fileInput').value = '';
    }

    async function startProcessing() {
        if (!selectedFile) return alert("Dosya seÃ§in!");
        if (!currentMode) return alert("LÃ¼tfen Ã¶nce mod seÃ§in (Logo & Grafik / FotoÄŸraf & Resim).");
        if (!vectorAllowed) {
            alert("Bu araÃ§ iÃ§in limitiniz doldu veya paketiniz yeterli deÄŸil. Paket yÃ¼kseltmeyi deneyin.");
            return;
        }
        document.getElementById('processing-overlay').classList.remove('hidden');

        const formData = new FormData();
        formData.append('image', selectedFile);
        formData.append('method', currentMode === 'logo' ? 'outline' : 'cartoon');

        const preset = getQualityPreset(currentMode, currentQuality);
        formData.append('edge_thickness', preset.edge_thickness);
        formData.append('color_count', preset.color_count);
        formData.append('border_sensitivity', preset.border_sensitivity);
        formData.append('simplify_factor', preset.simplify_factor);
        formData.append('min_area', preset.min_area);
        formData.append('cleanup_kernel', preset.cleanup_kernel);
        // FotoÄŸrafta flat stil; logo'da method=outline zaten kendi akÄ±ÅŸÄ±nÄ± kullanÄ±r.
        formData.append('style', preset.style);

        try {
            const res = await fetch('/api/vectorize', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) {
                engineId = data.id || null;
                vectorData = data.file || null;
                epsData = data.eps || null;
                botData = data.bot || null;
                pngData = data.preview_img || null;
                document.getElementById('final-result-img').src = "data:image/png;base64," + pngData;
                document.getElementById('processing-overlay').classList.add('hidden');
                document.getElementById('result-screen').classList.remove('hidden');
                // Limit kutusunu anlÄ±k gÃ¼ncelle (sayfa yenilemeden)
                if (data.status) {
                    vectorAllowed = !!data.status.allowed;
                    renderLimitBox(data.status);
                } else {
                    await fetchVectorStatus();
                }
            } else {
                if (data.reason === "limit") {
                    vectorAllowed = false;
                    if (data.status) renderLimitBox(data.status);
                    else renderLimitBox({ allowed: false, left: 0 });
                    alert("Limitiniz doldu. Paket yÃ¼kseltmeyi deneyin.");
                } else {
                    alert("Hata: " + (data.message || "Ä°ÅŸlem baÅŸarÄ±sÄ±z"));
                }
                document.getElementById('processing-overlay').classList.add('hidden');
            }
        } catch (e) {
            console.error(e);
            alert("Sunucu hatasÄ±!");
            document.getElementById('processing-overlay').classList.add('hidden');
        }
    }

    function renderLimitBox(status) {
        const box = document.getElementById('limitBox');
        if (!box) return;
        box.classList.remove('hidden');
        if (status.allowed) {
            const left = (typeof status.left === 'number') ? status.left : 0;
            const leftText = left > 9000 ? "SÄ±nÄ±rsÄ±z" : `${left} iÅŸlem hakkÄ±`;
            const tier = (status.tier || '').toString().toUpperCase();
            box.innerHTML = `<span class="font-bold text-green-400">Aktif</span> â€¢ Paket: <span class="font-bold">${tier || '-'}</span> â€¢ Kalan: <span class="font-bold">${leftText}</span>`;
        } else {
            const tier = (status.tier || '').toString().toUpperCase();
            box.innerHTML = `<span class="font-bold text-red-400">KÄ±sÄ±tlÄ±</span> â€¢ Paket: <span class="font-bold">${tier || '-'}</span> â€¢ Bu araÃ§ iÃ§in hakkÄ±nÄ±z yok veya limit bitti. <button onclick="openModal('premiumModal')" class="underline font-bold text-blue-300">Paketleri Ä°ncele</button>`;
        }
    }

    async function fetchVectorStatus() {
        try {
            const res = await fetch('/api/check_tool_status/vector/default');
            const st = await res.json();
            vectorAllowed = !!st.allowed;
            renderLimitBox({ allowed: st.allowed, left: st.left, tier: st.tier, limit: st.limit });
        } catch (e) {
            console.error(e);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchVectorStatus();
        updateQualityInfo();
    });

    function switchTab(tab) {
        const draw = document.getElementById('content-drawing');
        const mach = document.getElementById('content-machine');
        const btnDraw = document.getElementById('tab-drawing');
        const btnMach = document.getElementById('tab-machine');

        if (tab === 'drawing') {
            draw.classList.remove('hidden'); mach.classList.add('hidden');
            btnDraw.className = "flex-1 py-2 text-xs font-bold bg-violet-600 text-white rounded-md shadow-md";
            btnMach.className = "flex-1 py-2 text-xs font-bold text-gray-400 hover:text-white rounded-md";
        } else {
            draw.classList.add('hidden'); mach.classList.remove('hidden');
            btnMach.className = "flex-1 py-2 text-xs font-bold bg-blue-600 text-white rounded-md shadow-md";
            btnDraw.className = "flex-1 py-2 text-xs font-bold text-gray-400 hover:text-white rounded-md";
        }
    }

    // NAKIÅ DÃ–NÃœÅTÃœRME (CANLI)
    async function convertEmbroidery() {
        if (!selectedFile) return alert("LÃ¼tfen Ã¶nce bir dosya yÃ¼kleyin!");
        
        // Format SeÃ§imi
        const isMachine = document.getElementById('content-drawing').classList.contains('hidden');
        let format = '';
        if (isMachine) {
            format = document.getElementById('machine-format-select').value; // dst, pes
        } else {
            const radio = document.querySelector('input[name="emb_format"]:checked');
            format = radio ? radio.value : 'bot';
        }

        // BOT indir
        if (format === 'bot') {
            if (!botData) return alert("BOT henÃ¼z hazÄ±r deÄŸil. Ã–nce vektÃ¶rleÅŸtirin.");
            const link = document.createElement('a');
            link.href = "data:application/json;base64," + botData;
            link.download = "design.bot";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            return;
        }

        // Butonu Kilitle
        const btn = document.querySelector("button[onclick='convertEmbroidery()']");
        const oldText = btn.innerHTML;
        btn.innerHTML = "â³ DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼yor...";
        btn.disabled = true;

        const formData = new FormData();
        // Yeni akÄ±ÅŸ: BOT -> makine formatÄ±
        if (botData) {
            formData.append('bot', botData);
            formData.append('format', format);
        } else {
            // Fallback: eski sistem (image -> format)
            formData.append('image', selectedFile);
            formData.append('format', format);
        }

        try {
            const url = botData ? '/api/bot_to_embroidery' : '/api/convert_embroidery';
            const res = await fetch(url, {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                // Ä°ndirme Ä°ÅŸlemi
                const link = document.createElement('a');
                link.href = "data:application/octet-stream;base64," + data.file;
                link.download = "nakis_tasarim." + format;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert("âœ… BaÅŸarÄ±lÄ±! NakÄ±ÅŸ dosyanÄ±z indirildi.");
            } else {
                alert("Hata: " + data.message);
            }
        } catch (e) {
            console.error(e);
            alert("Sunucu baÄŸlantÄ± hatasÄ±!");
        } finally {
            btn.innerHTML = oldText;
            btn.disabled = false;
        }
    }

    function downloadEPS() { if(epsData) { const a = document.createElement('a'); a.href = "data:application/postscript;base64," + epsData; a.download = "vektor.eps"; a.click(); } else { alert("EPS henÃ¼z hazÄ±r deÄŸil."); } }
    function downloadVector() { if(vectorData) { const a = document.createElement('a'); a.href = "data:image/svg+xml;base64," + vectorData; a.download = "vektor.svg"; a.click(); } }
    function downloadPNG() { if(pngData) { const a = document.createElement('a'); a.href = "data:image/png;base64," + pngData; a.download = "preview.png"; a.click(); } }
</script>
{% endblock content %}
