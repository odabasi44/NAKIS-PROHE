{% extends "base.html" %}

{% block title %}AI VektÃ¶r DÃ¶nÃ¼ÅŸtÃ¼rÃ¼cÃ¼{% endblock title %}

{% block head_extra %}
<style>
    /* SeÃ§im KartlarÄ± Ä°Ã§in Ã–zel Stil */
    .option-card {
        background: rgba(17, 24, 39, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .option-card:hover {
        background: rgba(59, 130, 246, 0.05);
        border-color: rgba(59, 130, 246, 0.3);
    }
    .option-card.selected {
        background: rgba(59, 130, 246, 0.1);
        border-color: #3b82f6;
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.15);
    }
    
    /* Kalite ButonlarÄ± */
    .quality-btn {
        background: #02040a;
        border: 1px solid rgba(255,255,255,0.1);
        color: #9ca3af;
        transition: all 0.2s;
    }
    .quality-btn:hover { color: white; border-color: rgba(255,255,255,0.2); }
    .quality-btn.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
        font-weight: 600;
    }

    .glass-panel {
        background: rgba(17, 24, 39, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }
</style>
{% endblock head_extra %}

{% block content %}
<div class="max-w-6xl mx-auto py-10 px-4">

    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-white mb-4 bg-gradient-to-r from-violet-400 to-fuchsia-400 text-transparent bg-clip-text">
            AI NakÄ±ÅŸ VektÃ¶rleÅŸtirici
        </h1>
        <p class="text-gray-400 max-w-lg mx-auto">
            GÃ¶rsellerinizi Wilcom ve nakÄ±ÅŸ makineleriyle uyumlu temiz vektÃ¶rlere (SVG/DXF) dÃ¶nÃ¼ÅŸtÃ¼rÃ¼n.
        </p>
    </div>

    <div id="status-bar" class="glass-panel rounded-xl p-4 mb-8 flex justify-between items-center animate-fade-in border border-white/5">
        <div class="flex items-center gap-3">
            <div id="status-icon" class="w-2 h-2 rounded-full bg-gray-500 animate-pulse"></div>
            <span id="limit-info" class="text-sm font-medium text-gray-300">Limitler kontrol ediliyor...</span>
        </div>
        <div id="login-prompt" class="hidden">
            <a onclick="openModal('premiumModal')" class="text-xs text-fuchsia-400 hover:text-fuchsia-300 transition cursor-pointer">YÃ¼kselt</a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-1 space-y-6">
            
            <div class="glass-panel rounded-2xl p-6 relative">
                <div id="dropZone" class="border-2 border-dashed border-white/10 rounded-xl p-6 text-center hover:border-violet-500/50 transition cursor-pointer">
                    <input type="file" id="fileInput" accept="image/png, image/jpeg, image/webp" class="hidden">
                    <div class="w-12 h-12 bg-violet-500/10 rounded-lg flex items-center justify-center mx-auto mb-3 text-violet-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </div>
                    <p class="text-sm text-gray-300 font-medium">GÃ¶rsel YÃ¼kle</p>
                    <p class="text-xs text-gray-500 mt-1">JPG, PNG (Max 10MB)</p>
                </div>
                
                <div id="mini-preview" class="hidden mt-4 p-2 bg-black/40 rounded-lg flex items-center gap-3">
                    <img id="mini-img" class="w-12 h-12 object-cover rounded bg-white/5">
                    <div class="flex-1 min-w-0">
                        <p id="filename" class="text-xs text-white truncate">dosya_adi.png</p>
                        <p class="text-[10px] text-gray-500">YÃ¼klendi</p>
                    </div>
                    <button onclick="clearFile()" class="text-red-400 hover:text-red-300">âœ•</button>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                    <span class="w-1 h-4 bg-violet-500 rounded-full"></span> VektÃ¶r Metodu
                </h3>
                
                <div class="space-y-3">
                    <div onclick="selectMethod('normal')" id="opt-normal" class="option-card selected p-3 rounded-xl flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-blue-500/20 text-blue-400 flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-white">Normal VektÃ¶r</p>
                            <p class="text-[10px] text-gray-400">Standart renkli Ã§izimler iÃ§in.</p>
                        </div>
                    </div>

                    <div onclick="selectMethod('cartoon')" id="opt-cartoon" class="option-card p-3 rounded-xl flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-orange-500/20 text-orange-400 flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-white">Cartoon (Ã‡izgi Film)</p>
                            <p class="text-[10px] text-gray-400">DÃ¼z renkler, az detay (Tatami dolgu uygun).</p>
                        </div>
                    </div>

                    <div onclick="selectMethod('outline')" id="opt-outline" class="option-card p-3 rounded-xl flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-green-500/20 text-green-400 flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-white">DÄ±ÅŸ Hat (Outline)</p>
                            <p class="text-[10px] text-gray-400">Sadece Ã§izgiler (SargÄ± dikiÅŸ uygun).</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6">
                <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                    <span class="w-1 h-4 bg-fuchsia-500 rounded-full"></span> Detay & Kalite
                </h3>
                <div class="flex gap-2">
                    <button onclick="setQuality('medium')" id="q-medium" class="quality-btn flex-1 py-2 rounded-lg text-xs">Orta</button>
                    <button onclick="setQuality('high')" id="q-high" class="quality-btn active flex-1 py-2 rounded-lg text-xs">Normal</button>
                    <button onclick="setQuality('ultra')" id="q-ultra" class="quality-btn flex-1 py-2 rounded-lg text-xs">YÃ¼ksek</button>
                </div>
                <p class="text-[10px] text-gray-500 mt-2 text-center">YÃ¼ksek kalite iÅŸlem sÃ¼resini uzatabilir.</p>
            </div>

            <button id="processBtn" onclick="processVector()" class="w-full py-4 rounded-xl bg-gradient-to-r from-violet-600 to-fuchsia-600 hover:from-violet-500 hover:to-fuchsia-500 text-white font-bold shadow-lg shadow-violet-900/40 transition disabled:opacity-50 disabled:cursor-not-allowed">
                VektÃ¶re DÃ¶nÃ¼ÅŸtÃ¼r
            </button>

        </div>

        <div class="lg:col-span-2">
            <div class="glass-panel rounded-2xl p-6 h-full min-h-[500px] flex flex-col relative">
                
                <div id="preview-placeholder" class="flex-1 flex flex-col items-center justify-center text-gray-500 border-2 border-dashed border-white/5 rounded-xl">
                    <svg class="w-16 h-16 mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <p>Ã–nizleme alanÄ±</p>
                </div>

                <div id="loading-overlay" class="hidden absolute inset-0 bg-[#0c1120]/90 z-20 flex flex-col items-center justify-center backdrop-blur-sm rounded-2xl">
                    <div class="w-16 h-16 border-4 border-violet-500/30 border-t-violet-500 rounded-full animate-spin mb-4"></div>
                    <p class="text-white font-bold animate-pulse">Yapay Zeka Ã‡iziyor...</p>
                    <p class="text-xs text-gray-400 mt-2">Wilcom optimizasyonu yapÄ±lÄ±yor</p>
                </div>

                <div id="result-view" class="hidden flex-1 flex flex-col gap-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-white">SonuÃ§ Ã–nizleme</h3>
                        <span class="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded">VektÃ¶r HazÄ±r</span>
                    </div>

                    <div class="flex-1 bg-white/5 rounded-xl overflow-hidden relative checkerboard-bg flex items-center justify-center">
                        <img id="result-img" class="max-w-full max-h-[500px] object-contain shadow-2xl">
                    </div>

                   <div class="grid grid-cols-2 gap-4 mt-4">
                        <button onclick="downloadResult('svg')" class="py-3 rounded-lg bg-gray-800 hover:bg-gray-700 text-white font-medium border border-white/10 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Ä°ndir (SVG VektÃ¶r)
                        </button>
                        <button onclick="downloadResult('png')" class="py-3 rounded-lg bg-violet-600 hover:bg-violet-700 text-white font-bold shadow-lg shadow-violet-900/30 flex items-center justify-center gap-2">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            Ä°ndir (Temiz PNG)
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>

<style>
    .checkerboard-bg {
        background-image: linear-gradient(45deg, #1f2937 25%, transparent 25%), linear-gradient(-45deg, #1f2937 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #1f2937 75%), linear-gradient(-45deg, transparent 75%, #1f2937 75%);
        background-size: 20px 20px;
        background-color: #111827;
    }
</style>

<script>
    // DURUM DEÄžÄ°ÅžKENLERÄ°
    let selectedMethod = 'normal';
    let selectedQuality = 'high';
    let selectedFile = null;
    let userAllowed = false;

    // Ä°ndirme verilerini saklamak iÃ§in global deÄŸiÅŸkenler
    window.vectorData = null; // SVG verisi
    window.pngData = null;    // TemizlenmiÅŸ PNG verisi

    // 1. LÄ°MÄ°T KONTROLÃœ (Sayfa YÃ¼klendiÄŸinde)
    async function checkLimit() {
        const infoEl = document.getElementById('limit-info');
        const iconEl = document.getElementById('status-icon');
        const loginPrompt = document.getElementById('login-prompt');
        const btn = document.getElementById('processBtn');

        try {
            const res = await fetch('/api/check_tool_status/vector/default');
            const data = await res.json();
            userAllowed = data.allowed;

            if (data.allowed) {
                iconEl.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]";
                infoEl.innerHTML = data.premium 
                    ? `ðŸ’Ž Premium Aktif - <span class="text-green-400">SÄ±nÄ±rsÄ±z</span>` 
                    : `Kalan HakkÄ±nÄ±z: <span class="text-green-400 font-bold">${data.left}</span>`;
                btn.disabled = false;
                btn.innerText = "VektÃ¶re DÃ¶nÃ¼ÅŸtÃ¼r";
            } else {
                iconEl.className = "w-2 h-2 rounded-full bg-red-500";
                infoEl.innerHTML = `â›” Limit Doldu.`;
                loginPrompt.classList.remove('hidden');
                btn.disabled = true;
                btn.innerText = "Pro Paket Gerekir";
                openModal('premiumModal'); 
            }
        } catch (e) {
            console.error("Limit hatasÄ±:", e);
            infoEl.innerText = "Sunucu hatasÄ±";
        }
    }

    // 2. UI SEÃ‡Ä°M FONKSÄ°YONLARI
    function selectMethod(method) {
        selectedMethod = method;
        ['normal', 'cartoon', 'outline'].forEach(m => {
            const el = document.getElementById('opt-' + m);
            if (m === method) el.classList.add('selected');
            else el.classList.remove('selected');
        });
    }

    function setQuality(q) {
        selectedQuality = q;
        ['medium', 'high', 'ultra'].forEach(qv => {
            const el = document.getElementById('q-' + qv);
            if (qv === q) el.classList.add('active');
            else el.classList.remove('active');
        });
    }

    // 3. DOSYA YÃœKLEME
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => handleFile(e.target.files[0]));
    
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('border-violet-500'); });
    dropZone.addEventListener('dragleave', e => { dropZone.classList.remove('border-violet-500'); });
    dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('border-violet-500');
        handleFile(e.dataTransfer.files[0]);
    });

    function handleFile(file) {
        if (!file || !file.type.startsWith('image/')) return alert("GeÃ§ersiz dosya!");
        
        selectedFile = file;
        
        const reader = new FileReader();
        reader.onload = e => {
            document.getElementById('mini-img').src = e.target.result;
            document.getElementById('filename').innerText = file.name;
            document.getElementById('dropZone').classList.add('hidden');
            document.getElementById('mini-preview').classList.remove('hidden');
            document.getElementById('mini-preview').classList.add('flex');
            
            // Ä°lk Ã¶nizleme (soluk)
            const resultImg = document.getElementById('result-img');
            resultImg.src = e.target.result;
            resultImg.style.opacity = "0.3"; 
            document.getElementById('preview-placeholder').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    function clearFile() {
        selectedFile = null;
        fileInput.value = '';
        window.vectorData = null;
        window.pngData = null;
        
        document.getElementById('dropZone').classList.remove('hidden');
        document.getElementById('mini-preview').classList.add('hidden');
        document.getElementById('mini-preview').classList.remove('flex');
        
        document.getElementById('preview-placeholder').classList.remove('hidden');
        document.getElementById('result-view').classList.add('hidden');
    }

   // 4. Ä°ÅžLEM BAÅžLATMA (GÃœNCELLENMÄ°Åž & PARAMETRE EÅžLEÅžTÄ°RMELÄ°)
    async function processVector() {
        if (!selectedFile) return alert("LÃ¼tfen Ã¶nce bir resim seÃ§in.");
        if (!userAllowed) return openModal('premiumModal');

        const loading = document.getElementById('loading-overlay');
        loading.classList.remove('hidden');

        const formData = new FormData();
        formData.append('image', selectedFile);
        formData.append('method', selectedMethod);

        // --- YENÄ° EÅžLEÅžTÄ°RME MANTIÄžI ---
        // KullanÄ±cÄ±nÄ±n seÃ§tiÄŸi "Kalite" ve "Metot" ayarlarÄ±nÄ±
        // Backend'in beklediÄŸi sayÄ±sal deÄŸerlere (renk, kalÄ±nlÄ±k) Ã§eviriyoruz.
        
        let edgeThickness = 2; // VarsayÄ±lan
        let colorCount = 16;   // VarsayÄ±lan
        let style = 'cartoon'; // VarsayÄ±lan stil

        // 1. Kalite AyarlarÄ± (Detay & Kalite ButonlarÄ±)
        if (selectedQuality === 'medium') {      // "Orta" -> Az renk, kalÄ±n Ã§izgi (Basit)
            edgeThickness = 3;
            colorCount = 8;
        } else if (selectedQuality === 'high') { // "Normal" -> Dengeli
            edgeThickness = 2;
            colorCount = 16;
        } else if (selectedQuality === 'ultra') {// "YÃ¼ksek" -> Ã‡ok renk, ince Ã§izgi (DetaylÄ±)
            edgeThickness = 1;
            colorCount = 32;
        }

        // 2. Metot AyarlarÄ± (VektÃ¶r Metodu ButonlarÄ±)
        if (selectedMethod === 'cartoon') {
            style = 'cartoon'; // Hibrit motor Ã§alÄ±ÅŸÄ±r
        } else if (selectedMethod === 'normal') {
            style = 'painting'; // Daha yumuÅŸak, resimsel stil
            colorCount += 8;    // Normal modda biraz daha fazla renk olsun
        } else if (selectedMethod === 'outline') {
            // Outline modu backend'de ayrÄ± iÅŸleniyor, parametreler Ã¶nemsiz
            style = 'sketch'; 
        }

        // Parametreleri ekle
        formData.append('style', style);
        formData.append('edge_thickness', edgeThickness);
        formData.append('color_count', colorCount);
        // ----------------------------------

        try {
            const res = await fetch('/api/vectorize', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            loading.classList.add('hidden');

            if (data.success) {
                window.vectorData = data.file;       
                window.pngData = data.preview_img;   

                const resultImg = document.getElementById('result-img');
                resultImg.src = "data:image/png;base64," + data.preview_img; 
                resultImg.style.opacity = "1";
                
                checkLimit(); 
            } else {
                alert("Hata: " + (data.message || "Ä°ÅŸlem baÅŸarÄ±sÄ±z."));
                if (data.reason === 'limit') openModal('premiumModal');
            }

        } catch (e) {
            loading.classList.add('hidden');
            console.error(e);
            alert("Sunucu ile iletiÅŸim hatasÄ±!");
        }
    }

    // 5. Ä°NDÄ°RME FONKSÄ°YONU (GÃœNCELLENMÄ°Åž)
    function downloadResult(type) {
        const link = document.createElement('a');
        
        if (type === 'svg') {
            if (!window.vectorData) return alert("VektÃ¶r verisi bulunamadÄ±.");
            link.href = "data:image/svg+xml;base64," + window.vectorData;
            link.download = `vektor_${selectedMethod}.svg`;
        } 
        else if (type === 'png') {
            if (!window.pngData) return alert("PNG verisi bulunamadÄ±.");
            link.href = "data:image/png;base64," + window.pngData;
            link.download = `temiz_referans_${selectedMethod}.png`;
        }
        
        link.click();
    }

    document.addEventListener('DOMContentLoaded', checkLimit);
</script>
  
{% endblock content %}
