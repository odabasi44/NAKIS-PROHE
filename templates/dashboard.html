{% extends "base.html" %}

{% block title %}Kullanıcı Paneli{% endblock title %}

{% block content %}
<div class="max-w-4xl mx-auto py-10 px-4 sm:px-6 lg:px-8">

    <!-- HOŞ GELDİN KARTI -->
    <div class="p-6 rounded-2xl bg-gradient-to-br from-blue-700/50 to-purple-700/50 border border-white/10 shadow-2xl mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">
            Hoş geldin, {{ user.email or "Kullanıcı" }}
        </h1>
        <p class="text-gray-200">
            Sunucularımız emrinde. Limitsiz erişimin keyfini çıkar.
        </p>

        <div class="mt-5 flex gap-3">
            <a href="/remove-bg" class="px-5 py-2.5 rounded-full bg-white/20 hover:bg-white/30 text-white font-semibold transition">
                Arka Plan Sil
            </a>
            <a href="/" class="px-5 py-2.5 rounded-full bg-white/10 hover:bg-white/20 text-white font-semibold transition">
                Tüm Araçlar
            </a>
        </div>
    </div>

    <!-- İSTATİSTİK KARTLARI -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        
        <!-- Kalan Limit -->
        <div class="p-4 rounded-xl bg-gray-900/50 border border-white/10">
            <p class="text-xs font-semibold text-amber-400 mb-1">KALAN LİMİT</p>
            <p class="text-2xl font-bold text-white">{{ user.tier | upper }}</p>
            <p class="text-xs text-gray-400">Bitiş: {{ user.end_date or '-' }}</p>
        </div>
        
        <!-- Toplam Kullanım (BG Remove) -->
        <div class="p-4 rounded-xl bg-gray-900/50 border border-white/10">
            <p class="text-xs font-semibold text-cyan-400 mb-1">TOPLAM GÖRSEL İŞLEM</p>
            <p class="text-2xl font-bold text-white">{{ user.image_total | default(0) }}</p>
            <p class="text-xs text-gray-400">BG Silme + Sıkıştır + Çevir</p>
        </div>

        <!-- Hesap Durumu -->
        <div class="p-4 rounded-xl bg-gray-900/50 border border-white/10">
            <p class="text-xs font-semibold text-green-400 mb-1">HESAP DURUMU</p>
            <p class="text-2xl font-bold text-white">Aktif</p>
            <a href="/logout" class="text-xs text-red-400 hover:text-red-300 transition">Çıkış Yap</a>
        </div>
    </div>
    
    <!-- SON İŞLEMLER TABLOSU -->
    <div class="p-6 rounded-2xl bg-gray-900/50 border border-white/10">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-white">Son İşlemlerin</h2>
            <span id="unreadBadge" class="hidden text-[10px] font-bold px-2 py-1 rounded-full bg-red-500/20 text-red-300 border border-red-500/30">Yeni destek yanıtı</span>
        </div>
        <ul id="recentOps" class="mt-2 space-y-2 text-sm text-gray-300">
            <li class="text-gray-500">Yükleniyor...</li>
        </ul>
    </div>

    <!-- DESTEK TALEBİ -->
    <div class="p-6 rounded-2xl bg-gray-900/50 border border-white/10 mt-8">
        <h2 class="text-xl font-bold text-white mb-4">Destek Talebi (Ticket)</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
            <input id="ticketSubject" class="bg-[#02040a] border border-white/10 rounded-lg px-4 py-3 text-white text-sm" placeholder="Konu (örn: Limit sorunu)">
            <button onclick="createTicket()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg text-sm transition">Talep Oluştur</button>
        </div>
        <textarea id="ticketMessage" class="w-full bg-[#02040a] border border-white/10 rounded-lg px-4 py-3 text-white text-sm h-28" placeholder="Mesajınız..."></textarea>

        <div class="mt-6">
            <h3 class="text-sm font-bold text-white mb-2">Taleplerim</h3>
            <div id="ticketsList" class="space-y-2 text-sm text-gray-300">
                <div class="text-gray-500">Yükleniyor...</div>
            </div>
        </div>
    </div>

</div>

<!-- Ticket Modal (Profesyonel Görünüm) -->
<div id="ticketModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[120] p-4">
    <div class="w-full max-w-2xl bg-[#0c1120] border border-white/10 rounded-2xl shadow-2xl overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b border-white/10">
            <div>
                <div class="text-xs text-gray-400">Destek Talebi</div>
                <div id="ticketModalTitle" class="text-white font-bold">-</div>
            </div>
            <button onclick="closeTicketModal()" class="text-gray-400 hover:text-white">✕</button>
        </div>
        <div id="ticketModalBody" class="p-4 max-h-[420px] overflow-auto space-y-2 bg-black/20"></div>
        <div class="p-4 border-t border-white/10">
            <textarea id="ticketReplyMsg" class="w-full bg-[#02040a] border border-white/10 rounded-lg px-4 py-3 text-white text-sm h-24" placeholder="Mesaj yaz..."></textarea>
            <div class="flex justify-end mt-2 gap-2">
                <button onclick="sendTicketReply()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-lg text-xs">Gönder</button>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedTicketId = null;
    let selectedTicketSubject = '';

    function openTicketModal() {
        const modal = document.getElementById('ticketModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
    function closeTicketModal() {
        const modal = document.getElementById('ticketModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        selectedTicketId = null;
        selectedTicketSubject = '';
        document.getElementById('ticketModalBody').innerHTML = '';
        document.getElementById('ticketReplyMsg').value = '';
    }

    function renderTicketMessages(msgs) {
        const body = document.getElementById('ticketModalBody');
        if (!msgs || !msgs.length) {
            body.innerHTML = '<div class="text-gray-500">Mesaj yok.</div>';
            return;
        }
        body.innerHTML = msgs.map(m => {
            const isAdmin = m.sender === 'admin';
            return `
                <div class="flex ${isAdmin ? 'justify-start' : 'justify-end'}">
                    <div class="max-w-[85%] p-3 rounded-xl ${isAdmin ? 'bg-blue-500/10 border border-blue-500/20' : 'bg-white/5 border border-white/10'}">
                        <div class="text-[10px] text-gray-500 mb-1">${isAdmin ? 'Destek Ekibi' : 'Siz'}</div>
                        <div class="text-sm text-gray-200 whitespace-pre-wrap">${m.message}</div>
                    </div>
                </div>
            `;
        }).join('');
        body.scrollTop = body.scrollHeight;
    }

    async function loadDashboardData() {
        try {
            const res = await fetch('/api/user/dashboard');
            const data = await res.json();
            const list = document.getElementById('recentOps');
            if (!data.recent_ops || !data.recent_ops.length) {
                list.innerHTML = '<li class="text-gray-500">Henüz işlem yok.</li>';
            } else {
                list.innerHTML = data.recent_ops.map(o => `<li class="p-2 bg-gray-800/50 rounded-lg">- ${o.tool} / ${o.subtool}</li>`).join('');
            }

            const unread = (data.unread_replies || 0);
            const badge = document.getElementById('unreadBadge');
            if (unread > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden');
        } catch (e) {
            console.error(e);
        }
    }

    async function loadTickets() {
        const box = document.getElementById('ticketsList');
        try {
            const res = await fetch('/api/user/tickets');
            const items = await res.json();
            if (!items.length) {
                box.innerHTML = '<div class="text-gray-500">Henüz destek talebiniz yok.</div>';
                return;
            }
            box.innerHTML = items.map(t => `
                <div class="p-3 bg-gray-800/50 rounded-lg border border-white/5 flex items-center justify-between">
                    <div>
                        <div class="text-white font-bold text-sm">${t.subject}</div>
                        <div class="text-[10px] text-gray-500">${t.status} • ${t.unread} okunmamış</div>
                    </div>
                    <button onclick="openTicket(${t.id})" class="text-xs font-bold text-blue-300 underline">Görüntüle</button>
                </div>
            `).join('');
        } catch (e) {
            box.innerHTML = '<div class="text-red-400">Ticket listesi yüklenemedi.</div>';
        }
    }

    async function createTicket() {
        const subject = document.getElementById('ticketSubject').value;
        const message = document.getElementById('ticketMessage').value;
        if (!subject || !message) return alert('Konu ve mesaj girin.');
        const res = await fetch('/api/user/tickets', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({subject, message})
        });
        const data = await res.json();
        if (res.ok && data.status === 'ok') {
            document.getElementById('ticketSubject').value = '';
            document.getElementById('ticketMessage').value = '';
            await loadTickets();
            await loadDashboardData();
        } else {
            alert(data.message || 'Hata');
        }
    }

    async function openTicket(id) {
        selectedTicketId = id;
        // subject'i listeden bulalım
        try {
            const resList = await fetch('/api/user/tickets');
            const items = await resList.json();
            const item = (items || []).find(x => x.id === id);
            selectedTicketSubject = item ? item.subject : '';
        } catch (e) {}

        document.getElementById('ticketModalTitle').textContent = selectedTicketSubject || `#${id}`;
        openTicketModal();
        await refreshTicketModal();
    }

    async function refreshTicketModal() {
        if (!selectedTicketId) return;
        const res = await fetch(`/api/user/tickets/${selectedTicketId}/messages`);
        const msgs = await res.json();
        renderTicketMessages(msgs);
        await loadDashboardData();
        await loadTickets();
    }

    async function sendTicketReply() {
        if (!selectedTicketId) return;
        const msg = document.getElementById('ticketReplyMsg').value;
        if (!msg) return;
        const res = await fetch(`/api/user/tickets/${selectedTicketId}/reply`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({message: msg})
        });
        const data = await res.json();
        if (res.ok && data.status === 'ok') {
            document.getElementById('ticketReplyMsg').value = '';
            await refreshTicketModal();
        } else {
            alert(data.message || 'Hata');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadDashboardData();
        loadTickets();
    });
</script>
{% endblock content %}
