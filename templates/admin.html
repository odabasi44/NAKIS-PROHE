<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Botlab Vector - Admin Paneli</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #020617;
            color: #e5e7eb;
        }
        a { color: inherit; text-decoration: none; }

        .shell {
            max-width: 1200px;
            margin: 24px auto 32px;
            padding: 0 16px;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        .logo {
            font-size: 21px;
            font-weight: 700;
        }
        .logo span {
            color: #38bdf8;
        }
        .subtitle {
            font-size: 12px;
            color: #9ca3af;
        }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #9ca3af;
        }

        .btn {
            border-radius: 999px;
            border: none;
            padding: 6px 14px;
            font-size: 12px;
            cursor: pointer;
            background: #1d4ed8;
            color: #e5e7eb;
        }
        .btn-secondary {
            background: #4b5563;
        }
        .btn-danger {
            background: #b91c1c;
        }

        .layout {
            display: grid;
            grid-template-columns: 220px minmax(0, 1fr);
            gap: 18px;
        }

        .sidebar {
            background: #020617;
            border-radius: 16px;
            border: 1px solid #1f2937;
            padding: 14px 12px;
        }
        .sidebar h3 {
            font-size: 13px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: .08em;
            color: #9ca3af;
        }
        .nav-btn {
            width: 100%;
            text-align: left;
            border-radius: 10px;
            border: none;
            padding: 8px 10px;
            font-size: 13px;
            cursor: pointer;
            background: transparent;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        .nav-btn:hover {
            background: #111827;
        }

        .content {
            background: #020617;
            border-radius: 16px;
            border: 1px solid #1f2937;
            padding: 18px 18px 16px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .content-header h2 {
            font-size: 17px;
        }
        .content-header p {
            font-size: 12px;
            color: #9ca3af;
        }

        .table-wrap {
            border-radius: 12px;
            border: 1px solid #1f2937;
            overflow: hidden;
            background: #020617;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        thead {
            background: #020617;
        }
        th, td {
            padding: 8px 9px;
            border-bottom: 1px solid #111827;
        }
        th {
            text-align: left;
            font-size: 12px;
            color: #9ca3af;
        }
        tbody tr:nth-child(even) {
            background: #020617;
        }
        tbody tr:hover {
            background: #020617;
        }

        .pill {
            border-radius: 999px;
            padding: 3px 8px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .pill-active {
            background: rgba(34,197,94,0.12);
            color: #bbf7d0;
        }
        .pill-expired {
            background: rgba(248,113,113,0.12);
            color: #fecaca;
        }

        .small-text {
            font-size: 11px;
            color: #9ca3af;
        }

        .actions-cell {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .btn-xs {
            border-radius: 999px;
            border: none;
            padding: 3px 7px;
            font-size: 11px;
            cursor: pointer;
            background: #111827;
            color: #e5e7eb;
        }
        .btn-xs:hover {
            background: #1f2937;
        }

        .footer {
            margin-top: 14px;
            font-size: 11px;
            color: #6b7280;
            text-align: center;
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.86);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }
        .modal-backdrop.show {
            display: flex;
        }
        .modal-box {
            background: #020617;
            border-radius: 16px;
            border: 1px solid #1f2937;
            padding: 18px 18px 16px;
            width: 360px;
            max-width: calc(100% - 40px);
        }
        .modal-box h3 {
            font-size: 15px;
            margin-bottom: 6px;
        }
        .modal-box p {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 10px;
        }
        .modal-input, .modal-select, .modal-textarea {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #374151;
            background: #020617;
            color: #e5e7eb;
            padding: 6px 8px;
            font-size: 13px;
            margin-bottom: 10px;
        }
        .modal-textarea {
            min-height: 60px;
            resize: vertical;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Paket modalı daha geniş */
        #packagesAdminModal .modal-box {
            width: 620px;
            max-width: calc(100% - 40px);
        }

        .packages-grid {
            max-height: 260px;
            overflow-y: auto;
            border-radius: 10px;
            border: 1px solid #1f2937;
            padding: 10px;
            background: #020617;
        }
        .package-row {
            border-radius: 10px;
            border: 1px solid #111827;
            padding: 8px;
            margin-bottom: 8px;
        }
        .package-row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .package-row-header span {
            font-size: 13px;
            font-weight: 600;
        }
        .pkg-label {
            font-size: 11px;
            color: #9ca3af;
            margin-bottom: 2px;
        }

        @media (max-width: 900px) {
            .layout {
                grid-template-columns: minmax(0, 1fr);
            }
        }
    </style>
</head>
<body>

<div class="shell">
    <div class="topbar">
        <div>
            <div class="logo">Botlab <span>Vector</span> Admin</div>
            <div class="subtitle">Yapay Zeka Destekli Vektörleştirme Uygulaması - Yönetim Paneli</div>
        </div>
        <div class="top-actions">
            <span>Admin: <strong>odabasiaiteknoloji@gmail.com</strong></span>
            <button class="btn-danger btn" onclick="handleAdminLogout()">Çıkış Yap</button>
        </div>
    </div>

    <div class="layout">
        <aside class="sidebar">
            <h3>Menü</h3>
            <button class="nav-btn" onclick="openAddUserModal()">Kullanıcı Ekle</button>
            <button class="nav-btn" onclick="openPackagesAdminModal()">Paketleri Ayarla</button>
            <button class="nav-btn" onclick="handleAdminLogout()">Admin Çıkış</button>

            <div style="margin-top:14px;" class="small-text">
                Bu panelden premium kullanıcı erişimlerini yönetebilir, paket metin ve fiyatlarını güncelleyebilirsiniz.
            </div>
        </aside>

        <main class="content">
            <div class="content-header">
                <div>
                    <h2>Premium Kullanıcılar</h2>
                    <p>Mail ile tanımlanan premium kullanıcıların sürelerini ve kullanım adetlerini buradan yönetebilirsiniz.</p>
                </div>
                <button class="btn" onclick="openAddUserModal()">+ Yeni Kullanıcı</button>
            </div>

            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>E-posta</th>
                            <th>Başlangıç</th>
                            <th>Bitiş</th>
                            <th>Durum</th>
                            <th>Toplam Kullanım</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6" class="small-text" style="text-align:center; padding:14px;">
                                Yükleniyor...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="footer">
                Botlab Teknoloji – Yapay Zeka Destekli Vektörleştirme Uygulaması | Admin Paneli
            </div>
        </main>
    </div>
</div>

<!-- Kullanıcı Ekle Modal -->
<div class="modal-backdrop" id="addUserModal">
    <div class="modal-box">
        <h3>Yeni Premium Kullanıcı Ekle</h3>
        <p>Kullanıcının mail adresini ve premium süresini seçin.</p>

        <input type="email" id="newUserEmail" class="modal-input" placeholder="kullanici@mail.com">

        <label class="pkg-label">Süre Seçin</label>
        <select id="newUserDuration" class="modal-select">
            <option value="30">1 Ay</option>
            <option value="180">6 Ay</option>
            <option value="365">1 Yıl</option>
        </select>

        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeAddUserModal()">Vazgeç</button>
            <button class="btn" onclick="submitNewUser()">Kaydet</button>
        </div>
    </div>
</div>

<!-- Paketleri Ayarla Modal -->
<div class="modal-backdrop" id="packagesAdminModal">
    <div class="modal-box">
        <h3>Paketleri Ayarla</h3>
        <p>Temel / Orta / Premium paketlerin başlık, açıklama ve fiyatlarını buradan güncelleyebilirsiniz.</p>

        <div class="packages-grid" id="packagesAdminContainer">
            <!-- Dinamik doldurulacak -->
        </div>

        <div class="modal-actions" style="margin-top:10px;">
            <button class="btn btn-secondary" onclick="closePackagesAdminModal()">Kapat</button>
            <button class="btn" onclick="savePackagesAdmin()">Kaydet</button>
        </div>
    </div>
</div>

<script>
    async function loadUsers() {
        const tbody = document.getElementById("usersTableBody");
        tbody.innerHTML = '<tr><td colspan="6" class="small-text" style="text-align:center; padding:14px;">Yükleniyor...</td></tr>';

        try {
            const res = await fetch("/admin_users");
            const data = await res.json();
            if (!data.success) {
                tbody.innerHTML = '<tr><td colspan="6" class="small-text" style="text-align:center; padding:14px;">Kullanıcı listesi alınamadı.</td></tr>';
                return;
            }

            const users = data.users || [];
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="small-text" style="text-align:center; padding:14px;">Henüz premium kullanıcı tanımlı değil.</td></tr>';
                return;
            }

            tbody.innerHTML = "";
            const now = new Date();

            users.forEach(u => {
                const tr = document.createElement("tr");

                const start = u.start_date ? new Date(u.start_date) : null;
                const end = u.end_date ? new Date(u.end_date) : null;

                const active = end && end > now;
                const diffDays = end ? Math.round((end - now) / (1000*60*60*24)) : null;

                const statusHtml = active
                    ? `<span class="pill pill-active">Aktif • ${diffDays} gün kaldı</span>`
                    : `<span class="pill pill-expired">Süresi Dolmuş</span>`;

                tr.innerHTML = `
                    <td>${u.email}</td>
                    <td>${start ? start.toLocaleString() : "-"}</td>
                    <td>${end ? end.toLocaleString() : "-"}</td>
                    <td>${statusHtml}</td>
                    <td>${u.total_usage || 0}</td>
                    <td>
                        <div class="actions-cell">
                            <button class="btn-xs" onclick="extendUser('${u.email}', 30)">+ 30 gün</button>
                            <button class="btn-xs" onclick="resetUsage('${u.email}')">Kullanımı Sıfırla</button>
                            <button class="btn-xs" onclick="deleteUser('${u.email}')">Sil</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="6" class="small-text" style="text-align:center; padding:14px;">Liste alınırken hata oluştu.</td></tr>';
        }
    }

    function openAddUserModal() {
        document.getElementById("addUserModal").classList.add("show");
        document.getElementById("newUserEmail").focus();
    }
    function closeAddUserModal() {
        document.getElementById("addUserModal").classList.remove("show");
    }

    async function submitNewUser() {
        const email = document.getElementById("newUserEmail").value.trim();
        const days = parseInt(document.getElementById("newUserDuration").value, 10);

        if (!email) {
            alert("Lütfen geçerli bir e-posta girin.");
            return;
        }

        try {
            const res = await fetch("/admin_add_user", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({email, days})
            });
            const data = await res.json();
            if (!data.success) {
                alert(data.message || "Kullanıcı eklenirken hata oluştu.");
                return;
            }
            closeAddUserModal();
            loadUsers();
        } catch (e) {
            console.error(e);
            alert("Kullanıcı eklenirken hata oluştu.");
        }
    }

    async function extendUser(email, days) {
        if (!confirm(`${email} için +${days} gün eklemek istiyor musunuz?`)) return;
        try {
            const res = await fetch("/admin_extend_user", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({email, days})
            });
            const data = await res.json();
            if (!data.success) {
                alert(data.message || "Süre uzatılamadı.");
                return;
            }
            loadUsers();
        } catch (e) {
            console.error(e);
            alert("İşlem sırasında hata oluştu.");
        }
    }

    async function resetUsage(email) {
        if (!confirm(`${email} kullanıcısının toplam kullanımını sıfırlamak istiyor musunuz?`)) return;
        try {
            const res = await fetch("/admin_reset_usage", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({email})
            });
            const data = await res.json();
            if (!data.success) {
                alert(data.message || "Kullanım sıfırlanamadı.");
                return;
            }
            loadUsers();
        } catch (e) {
            console.error(e);
            alert("İşlem sırasında hata oluştu.");
        }
    }

    async function deleteUser(email) {
        if (!confirm(`${email} kullanıcısını silmek istiyor musunuz?`)) return;
        try {
            const res = await fetch("/admin_delete_user", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({email})
            });
            const data = await res.json();
            if (!data.success) {
                alert(data.message || "Kullanıcı silinemedi.");
                return;
            }
            loadUsers();
        } catch (e) {
            console.error(e);
            alert("Kullanıcı silinirken hata oluştu.");
        }
    }

    async function handleAdminLogout() {
        try {
            await fetch("/admin_logout", {method: "POST"});
        } catch (e) {
            console.error(e);
        }
        window.location.href = "/";
    }

    // Paketler - Admin
    function openPackagesAdminModal() {
        document.getElementById("packagesAdminModal").classList.add("show");
        loadPackagesAdmin();
    }
    function closePackagesAdminModal() {
        document.getElementById("packagesAdminModal").classList.remove("show");
    }

    async function loadPackagesAdmin() {
        const container = document.getElementById("packagesAdminContainer");
        container.innerHTML = '<div class="small-text">Paketler yükleniyor...</div>';

        try {
            const res = await fetch("/admin_packages");
            const data = await res.json();
            if (!data.success) {
                container.innerHTML = '<div class="small-text">Paket bilgileri alınamadı.</div>';
                return;
            }

            const pkgs = data.packages || [];
            if (pkgs.length === 0) {
                container.innerHTML = '<div class="small-text">Henüz tanımlı paket yok.</div>';
                return;
            }

            container.innerHTML = "";
            pkgs.forEach(p => {
                const div = document.createElement("div");
                div.className = "package-row";
                div.setAttribute("data-id", p.id);

                div.innerHTML = `
                    <div class="package-row-header">
                        <span>${p.display_name}</span>
                        <span class="small-text">Kod: ${p.slug}</span>
                    </div>
                    <div>
                        <div class="pkg-label">Paket Adı</div>
                        <input class="modal-input pkg-name" value="${p.display_name || ""}">
                    </div>
                    <div>
                        <div class="pkg-label">Açıklama</div>
                        <textarea class="modal-textarea pkg-desc">${p.description || ""}</textarea>
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:8px; margin-top:4px;">
                        <div>
                            <div class="pkg-label">Aylık Fiyat</div>
                            <input class="modal-input pkg-monthly" value="${p.price_monthly || ""}">
                        </div>
                        <div>
                            <div class="pkg-label">3 Aylık Fiyat</div>
                            <input class="modal-input pkg-quarterly" value="${p.price_quarterly || ""}">
                        </div>
                        <div>
                            <div class="pkg-label">1 Yıllık Fiyat</div>
                            <input class="modal-input pkg-yearly" value="${p.price_yearly || ""}">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        } catch (e) {
            console.error(e);
            container.innerHTML = '<div class="small-text">Paketler yüklenirken hata oluştu.</div>';
        }
    }

    async function savePackagesAdmin() {
        const container = document.getElementById("packagesAdminContainer");
        const rows = container.querySelectorAll(".package-row");
        const payload = [];

        rows.forEach(row => {
            const id = parseInt(row.getAttribute("data-id"), 10);
            const name = row.querySelector(".pkg-name").value.trim();
            const desc = row.querySelector(".pkg-desc").value.trim();
            const monthly = row.querySelector(".pkg-monthly").value.trim();
            const quarterly = row.querySelector(".pkg-quarterly").value.trim();
            const yearly = row.querySelector(".pkg-yearly").value.trim();

            payload.push({
                id,
                display_name: name,
                description: desc,
                price_monthly: monthly,
                price_quarterly: quarterly,
                price_yearly: yearly
            });
        });

        try {
            const res = await fetch("/admin_packages/save", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({packages: payload})
            });
            const data = await res.json();
            if (!data.success) {
                alert(data.message || "Paketler kaydedilemedi.");
                return;
            }
            alert("Paketler başarıyla güncellendi.");
            closePackagesAdminModal();
        } catch (e) {
            console.error(e);
            alert("Paketler kaydedilirken hata oluştu.");
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        loadUsers();
    });
</script>

</body>
</html>
