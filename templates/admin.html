{% extends "admin_layout.html" %}

{% block title %}Admin Dashboard{% endblock title %}

{% block admin_title %}Genel BakÄ±ÅŸ{% endblock admin_title %}
{% block admin_subtitle %}Sistem Ä°statistikleri ve Ã–zet Durum.{% endblock admin_subtitle %}

{% block admin_content %}

<div id="tab-dashboard" class="space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="card p-5 border-l-4 border-blue-500">
            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Toplam KullanÄ±cÄ±</p>
            <h3 id="stat-total-users" class="text-2xl font-bold text-white">0</h3>
        </div>
        <div class="card p-5 border-l-4 border-green-500">
            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Aktif Premium</p>
            <h3 id="stat-active-premium" class="text-2xl font-bold text-white">0</h3>
        </div>
        <div class="card p-5 border-l-4 border-amber-500">
            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Toplam GÃ¶rsel Ä°ÅŸlem</p>
            <h3 id="stat-total-images" class="text-2xl font-bold text-white">0</h3>
        </div>
        <div class="card p-5 border-l-4 border-red-500">
            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">AÃ§Ä±k Destek Talebi</p>
            <h3 id="stat-open-tickets" class="text-2xl font-bold text-white">0</h3>
        </div>
    </div>
    
    <div class="card p-5">
        <h3 class="text-lg font-bold text-white mb-4">Son Aktiviteler</h3>
        <p class="text-gray-400 text-sm">Sistem loglarÄ± ve son kullanÄ±cÄ± hareketleri burada listelenecektir.</p>
    </div>
</div>

<div id="tab-users" class="hidden space-y-6">
    <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold text-white">KullanÄ±cÄ± YÃ¶netimi</h2>
        <button onclick="openAddUserModalWithSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
            + Yeni Ãœye Ekle
        </button>
    </div>

    <div class="card p-0 overflow-hidden">
        <table class="w-full text-sm text-left text-gray-400">
            <thead class="text-xs text-gray-200 uppercase bg-[#080b16] border-b border-white/5">
                <tr>
                    <th scope="col" class="px-6 py-3">E-posta</th>
                    <th scope="col" class="px-6 py-3">Paket</th>
                    <th scope="col" class="px-6 py-3">BitiÅŸ Tarihi</th>
                    <th scope="col" class="px-6 py-3 text-right">Ä°ÅŸlem</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
                <tr><td colspan="4" class="px-6 py-4 text-center">YÃ¼kleniyor...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="tab-tools" class="hidden space-y-8">
    <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold text-white">AraÃ§ & Limit YÃ¶netimi</h2>
    </div>

    <div class="card p-6 border-t-4 border-indigo-500">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h3 class="text-lg font-bold text-white">AraÃ§ DurumlarÄ±</h3>
                <p class="text-xs text-gray-400">Pasif yapÄ±lan araÃ§lar ana sayfada "Ã‡ok YakÄ±nda" moduna geÃ§er.</p>
            </div>
            <button onclick="saveToolStatus()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-xs font-bold transition">
                DurumlarÄ± Kaydet
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="tool-toggles-container">
            </div>
    </div>
    
    <div class="flex justify-between items-center mt-8">
        <h3 class="text-lg font-bold text-white">Limit AyarlarÄ±</h3>
        <button onclick="saveLimits()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg text-sm font-bold transition shadow-lg shadow-green-900/20">
            Limitleri Kaydet
        </button>
    </div>
    
    <div class="card p-6 border border-blue-500/20 bg-blue-500/5">
        <h3 class="text-lg font-bold text-blue-400 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
            Maksimum Dosya Boyutu (MB)
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-400 block mb-1">Ãœcretsiz</label><input type="number" id="limit-size-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500 block mb-1">BaÅŸlangÄ±Ã§</label><input type="number" id="limit-size-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400 block mb-1">Pro</label><input type="number" id="limit-size-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400 block mb-1">SÄ±nÄ±rsÄ±z</label><input type="number" id="limit-size-unlimited" class="input-dark w-full"></div>
        </div>
    </div>

    <div class="card p-6">
        <h3 class="text-lg font-bold text-white mb-4">Arka Plan Silici (GÃ¼nlÃ¼k Limit)</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-400 block mb-1">Ãœcretsiz</label><input type="number" id="limit-bg-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500 block mb-1">BaÅŸlangÄ±Ã§</label><input type="number" id="limit-bg-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400 block mb-1">Pro</label><input type="number" id="limit-bg-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400 block mb-1">SÄ±nÄ±rsÄ±z</label><input type="number" id="limit-bg-unlimited" class="input-dark w-full"></div>
        </div>
    </div>

    <div class="card p-6">
        <h3 class="text-lg font-bold text-white mb-4">PDF BirleÅŸtirme (GÃ¼nlÃ¼k Limit)</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-400 block mb-1">Ãœcretsiz</label><input type="number" id="limit-pdf-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500 block mb-1">BaÅŸlangÄ±Ã§</label><input type="number" id="limit-pdf-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400 block mb-1">Pro</label><input type="number" id="limit-pdf-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400 block mb-1">SÄ±nÄ±rsÄ±z</label><input type="number" id="limit-pdf-unlimited" class="input-dark w-full"></div>
        </div>
    </div>

    <div class="card p-6">
        <h3 class="text-lg font-bold text-white mb-4">PDF BÃ¶l (GÃ¼nlÃ¼k Limit)</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-400 block mb-1">Ãœcretsiz</label><input type="number" id="limit-pdf-split-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500 block mb-1">BaÅŸlangÄ±Ã§</label><input type="number" id="limit-pdf-split-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400 block mb-1">Pro</label><input type="number" id="limit-pdf-split-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400 block mb-1">SÄ±nÄ±rsÄ±z</label><input type="number" id="limit-pdf-split-unlimited" class="input-dark w-full"></div>
        </div>
    </div>

    <div class="card p-6">
        <h3 class="text-lg font-bold text-white mb-4">PDF SÄ±kÄ±ÅŸtÄ±r (GÃ¼nlÃ¼k Limit)</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-400 block mb-1">Ãœcretsiz</label><input type="number" id="limit-pdf-compress-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500 block mb-1">BaÅŸlangÄ±Ã§</label><input type="number" id="limit-pdf-compress-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400 block mb-1">Pro</label><input type="number" id="limit-pdf-compress-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400 block mb-1">SÄ±nÄ±rsÄ±z</label><input type="number" id="limit-pdf-compress-unlimited" class="input-dark w-full"></div>
        </div>
    </div>

    <div class="card p-6">
        <h3 class="text-lg font-bold text-white mb-4">GÃ¶rsel SÄ±kÄ±ÅŸtÄ±r (GÃ¼nlÃ¼k Limit)</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-400 block mb-1">Ãœcretsiz</label><input type="number" id="limit-img-compress-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500 block mb-1">BaÅŸlangÄ±Ã§</label><input type="number" id="limit-img-compress-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400 block mb-1">Pro</label><input type="number" id="limit-img-compress-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400 block mb-1">SÄ±nÄ±rsÄ±z</label><input type="number" id="limit-img-compress-unlimited" class="input-dark w-full"></div>
        </div>
    </div>

    <div class="card p-6">
        <h3 class="text-lg font-bold text-white mb-4">Format Ã‡evirici (GÃ¼nlÃ¼k Limit)</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-400 block mb-1">Ãœcretsiz</label><input type="number" id="limit-img-convert-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500 block mb-1">BaÅŸlangÄ±Ã§</label><input type="number" id="limit-img-convert-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400 block mb-1">Pro</label><input type="number" id="limit-img-convert-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400 block mb-1">SÄ±nÄ±rsÄ±z</label><input type="number" id="limit-img-convert-unlimited" class="input-dark w-full"></div>
        </div>
    </div>

    <div class="card p-6">
        <h3 class="text-lg font-bold text-white mb-4">VektÃ¶rleÅŸtirici (GÃ¼nlÃ¼k Limit)</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-400 block mb-1">Ãœcretsiz</label><input type="number" id="limit-vector-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500 block mb-1">BaÅŸlangÄ±Ã§</label><input type="number" id="limit-vector-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400 block mb-1">Pro</label><input type="number" id="limit-vector-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400 block mb-1">SÄ±nÄ±rsÄ±z</label><input type="number" id="limit-vector-unlimited" class="input-dark w-full"></div>
        </div>
    </div>

    <div class="card p-6">
        <h3 class="text-lg font-bold text-white mb-4">QR Generator (GÃ¼nlÃ¼k Limit)</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-400 block mb-1">Ãœcretsiz</label><input type="number" id="limit-qr-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500 block mb-1">BaÅŸlangÄ±Ã§</label><input type="number" id="limit-qr-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400 block mb-1">Pro</label><input type="number" id="limit-qr-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400 block mb-1">SÄ±nÄ±rsÄ±z</label><input type="number" id="limit-qr-unlimited" class="input-dark w-full"></div>
        </div>
    </div>

    <div class="card p-6">
        <h3 class="text-lg font-bold text-white mb-4">Logo Generator (GÃ¼nlÃ¼k Limit)</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-400 block mb-1">Ãœcretsiz</label><input type="number" id="limit-logo-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500 block mb-1">BaÅŸlangÄ±Ã§</label><input type="number" id="limit-logo-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400 block mb-1">Pro</label><input type="number" id="limit-logo-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400 block mb-1">SÄ±nÄ±rsÄ±z</label><input type="number" id="limit-logo-unlimited" class="input-dark w-full"></div>
        </div>
    </div>
</div>

<div id="tab-packages" class="hidden space-y-8">
    <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold text-white">Paket Ä°sim ve AÃ§Ä±klamalarÄ±</h2>
        <button onclick="savePackages()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg text-sm font-bold transition shadow-lg shadow-green-900/20">
            Paketleri Kaydet
        </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="card p-6 border-t-4 border-yellow-500 relative">
            <span class="absolute top-4 right-4 text-xs font-bold text-yellow-500 bg-yellow-500/10 px-2 py-1 rounded">STARTER</span>
            <h3 class="font-bold text-white mb-4">BaÅŸlangÄ±Ã§ Paketi</h3>
            <label class="block text-xs text-gray-400 mb-1">GÃ¶rÃ¼nen Ä°sim</label>
            <input type="text" id="pkg-starter-name" class="input-dark w-full mb-3">
            <label class="block text-xs text-gray-400 mb-1">Fiyat (â‚º)</label>
            <input type="text" id="pkg-starter-price" class="input-dark w-full mb-3">
            <label class="block text-xs text-gray-400 mb-1">AÃ§Ä±klama</label>
            <textarea id="pkg-starter-desc" class="input-dark w-full mb-3 h-20 text-xs"></textarea>
            <label class="block text-xs text-gray-400 mb-1">GÃ¶rÃ¼nen Ã–zellikler (Metin)</label>
            <textarea id="pkg-starter-features" class="input-dark w-full h-24 text-xs"></textarea>
        </div>

        <div class="card p-6 border-t-4 border-cyan-400 relative">
            <span class="absolute top-4 right-4 text-xs font-bold text-cyan-400 bg-cyan-400/10 px-2 py-1 rounded">PRO</span>
            <h3 class="font-bold text-white mb-4">Pro Paket</h3>
            <label class="block text-xs text-gray-400 mb-1">GÃ¶rÃ¼nen Ä°sim</label>
            <input type="text" id="pkg-pro-name" class="input-dark w-full mb-3">
            <label class="block text-xs text-gray-400 mb-1">Fiyat (â‚º)</label>
            <input type="text" id="pkg-pro-price" class="input-dark w-full mb-3">
            <label class="block text-xs text-gray-400 mb-1">AÃ§Ä±klama</label>
            <textarea id="pkg-pro-desc" class="input-dark w-full mb-3 h-20 text-xs"></textarea>
            <label class="block text-xs text-gray-400 mb-1">GÃ¶rÃ¼nen Ã–zellikler (Metin)</label>
            <textarea id="pkg-pro-features" class="input-dark w-full h-24 text-xs"></textarea>
        </div>

        <div class="card p-6 border-t-4 border-purple-500 relative">
            <span class="absolute top-4 right-4 text-xs font-bold text-purple-500 bg-purple-500/10 px-2 py-1 rounded">UNLIMITED</span>
            <h3 class="font-bold text-white mb-4">SÄ±nÄ±rsÄ±z Paket</h3>
            <label class="block text-xs text-gray-400 mb-1">GÃ¶rÃ¼nen Ä°sim</label>
            <input type="text" id="pkg-unlimited-name" class="input-dark w-full mb-3">
            <label class="block text-xs text-gray-400 mb-1">Fiyat (â‚º)</label>
            <input type="text" id="pkg-unlimited-price" class="input-dark w-full mb-3">
            <label class="block text-xs text-gray-400 mb-1">AÃ§Ä±klama</label>
            <textarea id="pkg-unlimited-desc" class="input-dark w-full mb-3 h-20 text-xs"></textarea>
            <label class="block text-xs text-gray-400 mb-1">GÃ¶rÃ¼nen Ã–zellikler (Metin)</label>
            <textarea id="pkg-unlimited-features" class="input-dark w-full h-24 text-xs"></textarea>
        </div>
    </div>
</div>

<div id="tab-tickets" class="hidden space-y-6">
    <h2 class="text-xl font-bold text-white">Destek Talepleri</h2>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="card p-4 lg:col-span-1">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-bold text-white">Talepler</h3>
                <button onclick="fetchAdminTickets()" class="text-xs text-blue-300 underline">Yenile</button>
            </div>
            <div id="admin-ticket-list" class="space-y-2 text-sm text-gray-300">
                <div class="text-gray-500">YÃ¼kleniyor...</div>
            </div>
        </div>
        <div class="card p-4 lg:col-span-2">
            <h3 class="text-sm font-bold text-white mb-3">Detay & Cevap</h3>
            <div id="admin-ticket-detail" class="text-sm text-gray-400">Bir ticket seÃ§in.</div>
        </div>
    </div>
</div>
<div id="tab-reports" class="hidden space-y-6">
    <h2 class="text-xl font-bold text-white">Raporlar</h2>
    <p class="text-gray-400">DetaylÄ± analizler yakÄ±nda eklenecek.</p>
</div>
<div id="tab-settings" class="hidden space-y-6">
    <h2 class="text-xl font-bold text-white">Site AyarlarÄ±</h2>
    <p class="text-gray-400">Genel site yapÄ±landÄ±rmasÄ±.</p>
</div>

<div id="addUserModal" class="modal-overlay hidden items-center justify-center fixed inset-0 bg-black/80 z-50">
    <div class="modal-content p-8 w-full max-w-lg relative animate-fade-in shadow-2xl bg-[#0c1120] rounded-2xl border border-white/10">
        <button onclick="closeModal('addUserModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">âœ•</button>
        <h2 class="text-xl font-bold text-white mb-6">Yeni Premium Ãœye Ekle</h2>
        
        <form id="addUserForm" onsubmit="event.preventDefault(); handleAddUser();">
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-1">E-posta</label>
                    <input type="email" id="new-user-email" placeholder="kullanici@mail.com" class="input-dark w-full text-sm" required>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">BitiÅŸ Tarihi</label>
                    <input type="date" id="new-user-end-date" class="input-dark w-full text-sm" required>
                </div>
            </div>

            <input type="hidden" id="selected-tier-input" value="starter">

            <label class="block text-xs text-gray-400 mb-2">Paket SeÃ§imi</label>
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button type="button" onclick="selectPkgUI('starter')" id="btn-pkg-starter" class="pkg-btn active-starter py-3 rounded-lg text-sm font-bold flex flex-col items-center gap-1 border border-white/10 bg-white/5">
                    <span>âš¡</span> Starter
                </button>
                <button type="button" onclick="selectPkgUI('pro')" id="btn-pkg-pro" class="pkg-btn py-3 rounded-lg text-sm font-bold flex flex-col items-center gap-1 border border-white/10 bg-white/5">
                    <span>ğŸš€</span> Pro
                </button>
                <button type="button" onclick="selectPkgUI('unlimited')" id="btn-pkg-unlimited" class="pkg-btn py-3 rounded-lg text-sm font-bold flex flex-col items-center gap-1 border border-white/10 bg-white/5">
                    <span>ğŸ’</span> Unlimited
                </button>
            </div>

            <div id="pkg-summary-box" class="bg-[#02040a] border border-yellow-500/30 rounded-lg p-4 mb-6 transition-all min-h-[120px]">
                <p class="text-xs text-gray-500 text-center mt-8">Veriler yÃ¼kleniyor...</p>
            </div>

            <p id="addUserMessage" class="text-sm text-green-400 mb-3 hidden"></p>

            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-sm transition">
                TanÄ±mlamayÄ± Onayla
            </button>
        </form>
    </div>
</div>

<style>
    /* Paket SeÃ§im ButonlarÄ± Ä°Ã§in Aktif Durumlar */
    .pkg-btn.active-starter { border-color: #eab308; background: rgba(234, 179, 8, 0.1); color: #eab308; }
    .pkg-btn.active-pro { border-color: #22d3ee; background: rgba(34, 211, 238, 0.1); color: #22d3ee; }
    .pkg-btn.active-unlimited { border-color: #a855f7; background: rgba(168, 85, 247, 0.1); color: #a855f7; }
</style>

<script>
    // Global Settings DeÄŸiÅŸkeni (Modal aÃ§Ä±ldÄ±ÄŸÄ±nda dolacak)
    let globalSettings = null;

    // Tool Listesi (Settings key'leri ile aynÄ± olmalÄ±)
    const toolKeys = [
        {key: 'remove_bg', name: 'Arka Plan Silici'},
        {key: 'vektor', name: 'VektÃ¶rleÅŸtirici'},
        {key: 'image_compress', name: 'GÃ¶rsel SÄ±kÄ±ÅŸtÄ±r'},
        {key: 'image_convert', name: 'Format Ã‡evirici'},
        {key: 'pdf_merge', name: 'PDF BirleÅŸtir'},
        {key: 'pdf_split', name: 'PDF BÃ¶l'},
        {key: 'pdf_compress', name: 'PDF SÄ±kÄ±ÅŸtÄ±r'},
        {key: 'word_to_pdf', name: 'Word to PDF'},
        {key: 'qr_generator', name: 'QR Kod'},
        {key: 'logo_generator', name: 'Logo OluÅŸturucu'}
    ];

    // 1. DASHBOARD VERÄ°LERÄ°
    async function fetchDashboardData() {
        try {
            const res = await fetch("/api/admin/stats");
            if (!res.ok) {
                const txt = await res.text();
                console.error("fetchDashboardData failed", res.status, txt);
                return;
            }
            const st = await res.json();

            document.getElementById('stat-total-users').textContent = st.total_users || 0;
            document.getElementById('stat-active-premium').textContent = st.active_premium || 0;
            document.getElementById('stat-total-images').textContent = st.total_ops || 0;
            document.getElementById('stat-open-tickets').textContent = st.open_tickets || 0;
        } catch(e) { console.error(e); }
    }

    // 2. KULLANICI LÄ°STESÄ°
    async function fetchUsers() {
        const tbody = document.getElementById('user-table-body');
        try {
            const res = await fetch("/api/admin/users");
            if (!res.ok) {
                const txt = await res.text();
                tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-400">Yetki yok / API hata (${res.status}).</td></tr>`;
                console.error("fetchUsers failed", res.status, txt);
                return;
            }
            const users = await res.json();
            
            if (!users.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4">KayÄ±t yok.</td></tr>'; return; }

            tbody.innerHTML = users.map(user => {
                const isActive = new Date(user.end_date) >= new Date();
                let tierColor = 'bg-gray-700 text-gray-300';
                if (user.tier === 'starter') tierColor = 'bg-yellow-500/20 text-yellow-500';
                if (user.tier === 'pro') tierColor = 'bg-cyan-500/20 text-cyan-400';
                if (user.tier === 'unlimited') tierColor = 'bg-purple-500/20 text-purple-400';

                const totalUsage = user.usage_total || 0;
                return `
                    <tr class="border-b border-white/5 hover:bg-white/5 transition">
                        <td class="px-6 py-4 text-white">${user.email}</td>
                        <td class="px-6 py-4"><span class="${tierColor} px-2 py-1 rounded text-xs font-bold uppercase">${user.tier}</span></td>
                        <td class="px-6 py-4 ${isActive ? 'text-green-400' : 'text-red-400'}">${user.end_date || '-' } <span class="text-[10px] text-gray-500">â€¢ ${totalUsage} iÅŸlem</span></td>
                        <td class="px-6 py-4 text-right"><button onclick="handleDeleteUser('${user.email}')" class="text-red-500 border border-red-500/30 px-2 py-1 rounded text-xs hover:bg-red-500/10">Sil</button></td>
                    </tr>`;
            }).join('');
        } catch(e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-red-400">Hata.</td></tr>';
        }
    }

    // 3. ARAÃ‡ DURUM YÃ–NETÄ°MÄ° (YENÄ°)
    async function fetchToolStatus() {
        try {
            const res = await fetch("/get_settings");
            const data = await res.json();
            const statuses = data.tool_status || {};
            const access = data.tool_access || {};
            
            const container = document.getElementById('tool-toggles-container');
            if (!container) {
                console.error("tool-toggles-container not found");
                return;
            }
            container.innerHTML = '';

            toolKeys.forEach(tool => {
                const isActive = statuses[tool.key]?.active !== false; // VarsayÄ±lan true
                const isMaint = statuses[tool.key]?.maintenance === true;
                const tiers = access[tool.key]?.tiers || null;
                const minTier = access[tool.key]?.min_tier || 'free';
                const tierDefaults = {
                    free: (minTier === 'free'),
                    starter: (minTier === 'starter' || minTier === 'free'),
                    pro: (minTier === 'pro' || minTier === 'starter' || minTier === 'free'),
                    unlimited: true
                };
                const tiersFinal = tiers ? {
                    free: tiers.free === true,
                    starter: tiers.starter === true,
                    pro: tiers.pro === true,
                    unlimited: tiers.unlimited === true
                } : tierDefaults;
                
                container.innerHTML += `
                <div class="flex items-center justify-between bg-[#02040a] p-3 rounded-lg border border-white/10">
                    <div class="flex flex-col gap-1">
                        <span class="text-sm text-gray-300 font-medium">${tool.name}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-gray-500">Paket EriÅŸimi:</span>
                            <label class="text-[10px] text-gray-300"><input type="checkbox" id="tier-${tool.key}-free" ${tiersFinal.free ? 'checked' : ''}> free</label>
                            <label class="text-[10px] text-gray-300"><input type="checkbox" id="tier-${tool.key}-starter" ${tiersFinal.starter ? 'checked' : ''}> starter</label>
                            <label class="text-[10px] text-gray-300"><input type="checkbox" id="tier-${tool.key}-pro" ${tiersFinal.pro ? 'checked' : ''}> pro</label>
                            <label class="text-[10px] text-gray-300"><input type="checkbox" id="tier-${tool.key}-unlimited" ${tiersFinal.unlimited ? 'checked' : ''}> unlimited</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-gray-500">BakÄ±m:</span>
                            <input type="checkbox" id="maint-${tool.key}" ${isMaint ? 'checked' : ''}>
                            <span class="text-[10px] text-gray-500">BakÄ±m modunda kart â€œBakÄ±mdaâ€ olur.</span>
                        </div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-${tool.key}" class="sr-only peer" ${isActive ? 'checked' : ''}>
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    </label>
                </div>`;
            });

            if (!container.innerHTML.trim()) {
                container.innerHTML = '<div class="text-gray-500 text-sm">AraÃ§ listesi oluÅŸturulamadÄ±.</div>';
            }
        } catch(e) { console.error(e); }
    }

    async function saveToolStatus() {
        let newStatuses = {};
        let newAccess = {};
        toolKeys.forEach(tool => {
            const isChecked = document.getElementById(`toggle-${tool.key}`).checked;
            const isMaint = document.getElementById(`maint-${tool.key}`)?.checked === true;
            newStatuses[tool.key] = { active: isChecked, maintenance: isMaint };
            newAccess[tool.key] = {
                tiers: {
                    free: document.getElementById(`tier-${tool.key}-free`)?.checked === true,
                    starter: document.getElementById(`tier-${tool.key}-starter`)?.checked === true,
                    pro: document.getElementById(`tier-${tool.key}-pro`)?.checked === true,
                    unlimited: document.getElementById(`tier-${tool.key}-unlimited`)?.checked === true
                }
            };
        });

        try {
            const res = await fetch("/api/admin/save_tool_status", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ tool_status: newStatuses, tool_access: newAccess })
            });
            const data = await res.json();
            if(data.status === 'ok') alert("Durumlar gÃ¼ncellendi!");
            else alert("Hata oluÅŸtu.");
        } catch(e) { alert("Sunucu hatasÄ±."); }
    }

    // 4. YENÄ° ÃœYE MODALI & LOGÄ°ÄÄ°
    async function openAddUserModalWithSettings() {
        openModal('addUserModal');
        try {
            const res = await fetch("/get_settings");
            globalSettings = await res.json();
            selectPkgUI('starter'); 
        } catch(e) { console.error("Ayarlar Ã§ekilemedi"); }
    }

    function selectPkgUI(tier) {
        document.getElementById('selected-tier-input').value = tier;
        ['starter', 'pro', 'unlimited'].forEach(t => {
            const btn = document.getElementById('btn-pkg-' + t);
            btn.className = 'pkg-btn py-3 rounded-lg text-sm font-bold flex flex-col items-center gap-1 border border-white/10 bg-white/5 text-gray-400'; 
            if (t === tier) {
                if(tier === 'starter') btn.classList.add('active-starter', 'text-yellow-500');
                if(tier === 'pro') btn.classList.add('active-pro', 'text-cyan-400');
                if(tier === 'unlimited') btn.classList.add('active-unlimited', 'text-purple-400');
            }
        });
        updateSummaryBox(tier);
    }

    function updateSummaryBox(tier) {
        const box = document.getElementById('pkg-summary-box');
        if (!globalSettings) return;

        const limits = globalSettings.limits || {};
        const packages = globalSettings.packages || {};
        const pkgInfo = packages[tier] || { name: tier, price: '?' };

        let colorClass = "text-gray-400";
        let borderColor = "border-gray-500/30";
        if(tier === 'starter') { colorClass = "text-yellow-500"; borderColor = "border-yellow-500/30"; }
        if(tier === 'pro') { colorClass = "text-cyan-400"; borderColor = "border-cyan-500/30"; }
        if(tier === 'unlimited') { colorClass = "text-purple-400"; borderColor = "border-purple-500/30"; }

        box.className = `bg-[#02040a] border ${borderColor} rounded-lg p-4 mb-6 transition-all`;

        const bgLimit = limits.image?.remove_bg?.[tier] || 0;
        const pdfMerge = limits.pdf?.merge?.[tier] || 0;
        const pdfSplit = limits.pdf?.split?.[tier] || 0;
        const pdfCompress = limits.pdf?.compress?.[tier] || 0;
        const vecLimit = limits.vector?.default?.[tier] || 0;
        const sizeLimit = limits.file_size?.[tier] || 0;
        const vecStatus = vecLimit > 0 ? `<span class="text-green-400 font-bold">AÃ§Ä±k (${vecLimit}/GÃ¼n)</span>` : `<span class="text-red-400 font-bold">KapalÄ± âŒ</span>`;
        const unlimitedText = (val) => val > 9000 ? "SÄ±nÄ±rsÄ±z" : val + " Adet/GÃ¼n";

        box.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div><h4 class="${colorClass} font-bold text-sm uppercase">${pkgInfo.name || tier}</h4><p class="text-gray-500 text-[10px]">TanÄ±mlanacak haklar (Otomatik)</p></div>
                <div class="text-right"><span class="block text-white font-bold text-lg">${pkgInfo.price || 0}â‚º</span></div>
            </div>
            <div class="grid grid-cols-2 gap-y-2 gap-x-4 text-xs">
                <div class="flex justify-between border-b border-white/5 pb-1"><span class="text-gray-400">BG Silme:</span><span class="text-white font-bold">${unlimitedText(bgLimit)}</span></div>
                <div class="flex justify-between border-b border-white/5 pb-1"><span class="text-gray-400">PDF Merge:</span><span class="text-white font-bold">${unlimitedText(pdfMerge)}</span></div>
                <div class="flex justify-between border-b border-white/5 pb-1"><span class="text-gray-400">PDF Split:</span><span class="text-white font-bold">${unlimitedText(pdfSplit)}</span></div>
                <div class="flex justify-between border-b border-white/5 pb-1"><span class="text-gray-400">PDF Compress:</span><span class="text-white font-bold">${unlimitedText(pdfCompress)}</span></div>
                <div class="flex justify-between border-b border-white/5 pb-1"><span class="text-gray-400">VektÃ¶r:</span>${vecStatus}</div>
                <div class="flex justify-between border-b border-white/5 pb-1"><span class="text-gray-400">Max Dosya:</span><span class="text-white font-bold">${sizeLimit} MB</span></div>
            </div>`;
    }

    async function handleAddUser() {
        const email = document.getElementById('new-user-email').value;
        const endDate = document.getElementById('new-user-end-date').value;
        const tier = document.getElementById('selected-tier-input').value;
        const msgEl = document.getElementById('addUserMessage');
        msgEl.classList.add('hidden');

        try {
            const res = await fetch("/api/admin/add_user", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, end_date: endDate, tier })
            });
            let data = {};
            try { data = await res.json(); } catch(e) { data = { message: await res.text() }; }

            if (res.ok) {
                msgEl.textContent = "KullanÄ±cÄ± baÅŸarÄ±yla eklendi!";
                msgEl.className = "text-sm text-green-400 mb-3 block";
                document.getElementById('addUserForm').reset();
                fetchUsers();
                setTimeout(() => closeModal('addUserModal'), 1500);
            } else {
                msgEl.textContent = data.message || "Hata.";
                msgEl.className = "text-sm text-red-400 mb-3 block";
            }
        } catch (e) { console.error(e); }
    }

    // 5. DÄ°ÄER FONKSÄ°YONLAR
    async function handleDeleteUser(email) {
        if(!confirm(email + " silinecek?")) return;
        await fetch(`/api/admin/delete_user/${email}`, { method: "DELETE" });
        fetchUsers();
    }

    async function fetchSettingsAndFillInputs() {
        try {
            const res = await fetch("/get_settings");
            const data = await res.json();
            const l = data.limits;
            const getVal = (obj, path, def) => path.split('.').reduce((o, p) => (o ? o[p] : def), obj) || def;
            
            document.getElementById('limit-size-free').value = getVal(l, 'file_size.free', 5);
            document.getElementById('limit-size-starter').value = getVal(l, 'file_size.starter', 10);
            document.getElementById('limit-size-pro').value = getVal(l, 'file_size.pro', 50);
            document.getElementById('limit-size-unlimited').value = getVal(l, 'file_size.unlimited', 100);
            document.getElementById('limit-bg-free').value = getVal(l, 'image.remove_bg.free', 2);
            document.getElementById('limit-bg-starter').value = getVal(l, 'image.remove_bg.starter', 20);
            document.getElementById('limit-bg-pro').value = getVal(l, 'image.remove_bg.pro', 200);
            document.getElementById('limit-bg-unlimited').value = getVal(l, 'image.remove_bg.unlimited', 9999);
            document.getElementById('limit-pdf-free').value = getVal(l, 'pdf.merge.free', 2);
            document.getElementById('limit-pdf-starter').value = getVal(l, 'pdf.merge.starter', 10);
            document.getElementById('limit-pdf-pro').value = getVal(l, 'pdf.merge.pro', 50);
            document.getElementById('limit-pdf-unlimited').value = getVal(l, 'pdf.merge.unlimited', 9999);

            document.getElementById('limit-pdf-split-free').value = getVal(l, 'pdf.split.free', 3);
            document.getElementById('limit-pdf-split-starter').value = getVal(l, 'pdf.split.starter', 5);
            document.getElementById('limit-pdf-split-pro').value = getVal(l, 'pdf.split.pro', 10);
            document.getElementById('limit-pdf-split-unlimited').value = getVal(l, 'pdf.split.unlimited', 99999);

            document.getElementById('limit-pdf-compress-free').value = getVal(l, 'pdf.compress.free', 3);
            document.getElementById('limit-pdf-compress-starter').value = getVal(l, 'pdf.compress.starter', 5);
            document.getElementById('limit-pdf-compress-pro').value = getVal(l, 'pdf.compress.pro', 10);
            document.getElementById('limit-pdf-compress-unlimited').value = getVal(l, 'pdf.compress.unlimited', 99999);

            document.getElementById('limit-img-compress-free').value = getVal(l, 'image.compress.free', 3);
            document.getElementById('limit-img-compress-starter').value = getVal(l, 'image.compress.starter', 5);
            document.getElementById('limit-img-compress-pro').value = getVal(l, 'image.compress.pro', 10);
            document.getElementById('limit-img-compress-unlimited').value = getVal(l, 'image.compress.unlimited', 99999);

            document.getElementById('limit-img-convert-free').value = getVal(l, 'image.convert.free', 5);
            document.getElementById('limit-img-convert-starter').value = getVal(l, 'image.convert.starter', 10);
            document.getElementById('limit-img-convert-pro').value = getVal(l, 'image.convert.pro', 20);
            document.getElementById('limit-img-convert-unlimited').value = getVal(l, 'image.convert.unlimited', 99999);

            document.getElementById('limit-vector-free').value = getVal(l, 'vector.default.free', 3);
            document.getElementById('limit-vector-starter').value = getVal(l, 'vector.default.starter', 5);
            document.getElementById('limit-vector-pro').value = getVal(l, 'vector.default.pro', 10);
            document.getElementById('limit-vector-unlimited').value = getVal(l, 'vector.default.unlimited', 99999);

            document.getElementById('limit-qr-free').value = getVal(l, 'generator.qr.free', 5);
            document.getElementById('limit-qr-starter').value = getVal(l, 'generator.qr.starter', 20);
            document.getElementById('limit-qr-pro').value = getVal(l, 'generator.qr.pro', 100);
            document.getElementById('limit-qr-unlimited').value = getVal(l, 'generator.qr.unlimited', 99999);

            document.getElementById('limit-logo-free').value = getVal(l, 'generator.logo.free', 2);
            document.getElementById('limit-logo-starter').value = getVal(l, 'generator.logo.starter', 5);
            document.getElementById('limit-logo-pro').value = getVal(l, 'generator.logo.pro', 20);
            document.getElementById('limit-logo-unlimited').value = getVal(l, 'generator.logo.unlimited', 99999);
        } catch(e) { console.error(e); }
    }
    
    async function saveLimits() {
        const limits = {
            file_size: {
                free: parseInt(document.getElementById('limit-size-free').value),
                starter: parseInt(document.getElementById('limit-size-starter').value),
                pro: parseInt(document.getElementById('limit-size-pro').value),
                unlimited: parseInt(document.getElementById('limit-size-unlimited').value)
            },
            image: {
                remove_bg: {
                    free: parseInt(document.getElementById('limit-bg-free').value),
                    starter: parseInt(document.getElementById('limit-bg-starter').value),
                    pro: parseInt(document.getElementById('limit-bg-pro').value),
                    unlimited: parseInt(document.getElementById('limit-bg-unlimited').value)
                }
            },
            pdf: {
                merge: {
                    free: parseInt(document.getElementById('limit-pdf-free').value),
                    starter: parseInt(document.getElementById('limit-pdf-starter').value),
                    pro: parseInt(document.getElementById('limit-pdf-pro').value),
                    unlimited: parseInt(document.getElementById('limit-pdf-unlimited').value)
                },
                split: {
                    free: parseInt(document.getElementById('limit-pdf-split-free').value),
                    starter: parseInt(document.getElementById('limit-pdf-split-starter').value),
                    pro: parseInt(document.getElementById('limit-pdf-split-pro').value),
                    unlimited: parseInt(document.getElementById('limit-pdf-split-unlimited').value)
                },
                compress: {
                    free: parseInt(document.getElementById('limit-pdf-compress-free').value),
                    starter: parseInt(document.getElementById('limit-pdf-compress-starter').value),
                    pro: parseInt(document.getElementById('limit-pdf-compress-pro').value),
                    unlimited: parseInt(document.getElementById('limit-pdf-compress-unlimited').value)
                }
            },
            vector: {
                default: {
                    free: parseInt(document.getElementById('limit-vector-free').value),
                    starter: parseInt(document.getElementById('limit-vector-starter').value),
                    pro: parseInt(document.getElementById('limit-vector-pro').value),
                    unlimited: parseInt(document.getElementById('limit-vector-unlimited').value)
                }
            },
            generator: {
                qr: {
                    free: parseInt(document.getElementById('limit-qr-free').value),
                    starter: parseInt(document.getElementById('limit-qr-starter').value),
                    pro: parseInt(document.getElementById('limit-qr-pro').value),
                    unlimited: parseInt(document.getElementById('limit-qr-unlimited').value)
                },
                logo: {
                    free: parseInt(document.getElementById('limit-logo-free').value),
                    starter: parseInt(document.getElementById('limit-logo-starter').value),
                    pro: parseInt(document.getElementById('limit-logo-pro').value),
                    unlimited: parseInt(document.getElementById('limit-logo-unlimited').value)
                }
            }
        };
        await fetch("/api/admin/save_limits", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({limits}) });
        alert("Limitler kaydedildi.");
    }

    async function fetchPackagesAndFill() {
        try {
            const res = await fetch("/get_settings");
            const data = await res.json();
            const p = data.packages || {};
            ['starter', 'pro', 'unlimited'].forEach(tier => {
                if(p[tier]) {
                    document.getElementById(`pkg-${tier}-name`).value = p[tier].name || '';
                    document.getElementById(`pkg-${tier}-price`).value = p[tier].price || '';
                    document.getElementById(`pkg-${tier}-desc`).value = p[tier].description || '';
                    const features = Array.isArray(p[tier].features) ? p[tier].features.join(', ') : (p[tier].features || '');
                    document.getElementById(`pkg-${tier}-features`).value = features;
                }
            });
        } catch(e){}
    }
    
    async function savePackages() {
        const tiers = ['starter', 'pro', 'unlimited'];
        let packagesData = {};
        tiers.forEach(tier => {
            const featStr = document.getElementById(`pkg-${tier}-features`).value;
            const featuresList = featStr.split(',').map(s => s.trim()).filter(s => s);
            packagesData[tier] = {
                name: document.getElementById(`pkg-${tier}-name`).value,
                price: document.getElementById(`pkg-${tier}-price`).value,
                description: document.getElementById(`pkg-${tier}-desc`).value,
                features: featuresList
            };
        });
        await fetch("/api/admin/save_packages", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({packages: packagesData}) });
        alert("Paketler kaydedildi.");
    }

    // TAB YÃ–NETÄ°MÄ°
    window.showTab = function(tabName) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
        
        const tabEl = document.getElementById('tab-' + tabName);
        if(tabEl) tabEl.classList.remove('hidden');
        const navEl = document.getElementById('nav-' + tabName);
        if(navEl) navEl.classList.add('active');

        if (tabName === 'dashboard') fetchDashboardData();
        if (tabName === 'users') fetchUsers();
        if (tabName === 'tools') { fetchSettingsAndFillInputs(); fetchToolStatus(); } // GÃœNCELLEME BURADA YAPILDI
        if (tabName === 'packages') fetchPackagesAndFill();
        if (tabName === 'tickets') fetchAdminTickets();
        
        if(navEl) updateAdminHeader(navEl.dataset.title, navEl.dataset.subtitle);
    }
    
    // VarsayÄ±lan Tab
    document.addEventListener('DOMContentLoaded', () => {
        showTab('dashboard');
    });

    // -------- TICKETS (ADMIN) --------
    let selectedTicketId = null;

    async function fetchAdminTickets() {
        const box = document.getElementById('admin-ticket-list');
        if (!box) return;
        box.innerHTML = '<div class="text-gray-500">YÃ¼kleniyor...</div>';
        try {
            const esc = (s) => String(s || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');

            const res = await fetch('/api/admin/tickets');
            const items = await res.json();
            if (!items.length) {
                box.innerHTML = '<div class="text-gray-500">Ticket yok.</div>';
                return;
            }
            box.innerHTML = items.map(t => `
                <button data-ticket-id="${t.id}" data-user-email="${esc(t.user_email)}" data-subject="${esc(t.subject)}"
                        onclick="openAdminTicketFromEl(this)"
                        class="w-full text-left p-3 rounded-lg border border-white/5 bg-[#02040a] hover:bg-white/5 transition">
                    <div class="text-white font-bold text-xs">${t.subject}</div>
                    <div class="text-[10px] text-gray-500">${t.user_email} â€¢ ${t.status}</div>
                </button>
            `).join('');
        } catch (e) {
            console.error(e);
            box.innerHTML = '<div class="text-red-400">YÃ¼klenemedi.</div>';
        }
    }

    function openAdminTicketFromEl(el) {
        const id = parseInt(el.dataset.ticketId || '0', 10);
        const email = el.dataset.userEmail || '';
        const subject = el.dataset.subject || '';
        openAdminTicket(id, email, subject);
    }

    async function openAdminTicket(id, userEmail, subject) {
        selectedTicketId = id;
        const panel = document.getElementById('admin-ticket-detail');
        panel.innerHTML = 'YÃ¼kleniyor...';
        const res = await fetch(`/api/admin/tickets/${id}/messages`);
        const msgs = await res.json();
        const history = msgs.map(m => `
            <div class="p-2 rounded-lg ${m.sender==='admin'?'bg-blue-500/10 border border-blue-500/20':'bg-white/5 border border-white/10'}">
                <div class="text-[10px] text-gray-500 mb-1">${m.sender==='admin'?'Admin':(userEmail || 'KullanÄ±cÄ±')}</div>
                <div class="text-sm text-gray-200 whitespace-pre-wrap">${m.message}</div>
            </div>
        `).join('');

        panel.innerHTML = `
            <div class="mb-4 p-3 rounded-lg bg-[#02040a] border border-white/10">
                <div class="text-[10px] text-gray-500">KullanÄ±cÄ±</div>
                <div class="text-sm text-white font-bold">${userEmail || '-'}</div>
                <div class="text-[10px] text-gray-500 mt-2">Konu</div>
                <div class="text-sm text-gray-200">${subject || '-'}</div>
            </div>
            <div class="space-y-2 mb-4 max-h-[360px] overflow-auto pr-2">${history || '<div class="text-gray-500">Mesaj yok</div>'}</div>
            <textarea id="adminReplyMsg" class="w-full bg-[#02040a] border border-white/10 rounded-lg px-4 py-3 text-white text-sm h-24" placeholder="Cevap yaz..."></textarea>
            <div class="flex justify-end mt-2">
                <button onclick="sendAdminReply()" class="bg-green-600 hover:bg-green-700 text-white font-bold px-4 py-2 rounded-lg text-xs">Cevapla</button>
            </div>
        `;
    }

    async function sendAdminReply() {
        if (!selectedTicketId) return;
        const msg = document.getElementById('adminReplyMsg').value;
        if (!msg) return alert('Mesaj yazÄ±n');
        const res = await fetch(`/api/admin/tickets/${selectedTicketId}/reply`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({message: msg})
        });
        const data = await res.json();
        if (res.ok && data.status === 'ok') {
            await openAdminTicket(selectedTicketId);
            await fetchDashboardData();
        } else {
            alert(data.message || 'Hata');
        }
    }
</script>

{% endblock admin_content %}
