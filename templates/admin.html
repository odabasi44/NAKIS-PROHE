{% extends "admin_layout.html" %}

{% block title %}Admin Dashboard{% endblock title %}

{% block admin_title %}Yönetim Paneli{% endblock admin_title %}
{% block admin_subtitle %}Sistem durumunu ve ayarlarını buradan yönetebilirsiniz.{% endblock admin_subtitle %}

{% block admin_content %}

<div id="tab-dashboard" class="space-y-6 animate-fade-in">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="card p-5 border-l-4 border-blue-500">
            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Toplam Kullanıcı</p>
            <h3 id="stat-total-users" class="text-2xl font-bold text-white">...</h3>
        </div>
        <div class="card p-5 border-l-4 border-green-500">
            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Aktif Premium</p>
            <h3 id="stat-active-premium" class="text-2xl font-bold text-white">...</h3>
        </div>
        <div class="card p-5 border-l-4 border-amber-500">
            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Toplam İşlem</p>
            <h3 id="stat-total-images" class="text-2xl font-bold text-white">...</h3>
        </div>
        <div class="card p-5 border-l-4 border-red-500">
            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Açık Talepler</p>
            <h3 class="text-2xl font-bold text-white">0</h3>
        </div>
    </div>
</div>

<div id="tab-users" class="hidden space-y-6 animate-fade-in">
    <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold text-white">Kullanıcı Yönetimi</h2>
        <button onclick="openAddUserModalWithSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition">
            + Yeni Üye Ekle
        </button>
    </div>
    <div class="card p-0 overflow-hidden">
        <table class="w-full text-sm text-left text-gray-400">
            <thead class="text-xs text-gray-200 uppercase bg-[#080b16] border-b border-white/5">
                <tr>
                    <th class="px-6 py-3">E-posta</th>
                    <th class="px-6 py-3">Paket</th>
                    <th class="px-6 py-3">Bitiş</th>
                    <th class="px-6 py-3 text-right">İşlem</th>
                </tr>
            </thead>
            <tbody id="user-table-body"></tbody>
        </table>
    </div>
</div>

<div id="tab-tools" class="hidden space-y-8 animate-fade-in">
    <div class="card p-6 border-t-4 border-indigo-500">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h3 class="text-lg font-bold text-white">Araç Durumları</h3>
                <p class="text-xs text-gray-400">Kapalı araçlar ana sayfada "Çok Yakında" moduna geçer.</p>
            </div>
            <button onclick="saveToolStatus()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-xs font-bold">Kaydet</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="tool-toggles-container">
            </div>
    </div>

    <div class="flex justify-between items-center mt-8">
        <h3 class="text-lg font-bold text-white">Limit Ayarları</h3>
        <button onclick="saveLimits()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg text-sm font-bold">Limitleri Kaydet</button>
    </div>
    
    <div class="card p-6">
        <h3 class="text-blue-400 font-bold mb-4">Arka Plan Silme (Günlük Limit)</h3>
        <div class="grid grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-500">Free</label><input type="number" id="limit-bg-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500">Starter</label><input type="number" id="limit-bg-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400">Pro</label><input type="number" id="limit-bg-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400">Unlimited</label><input type="number" id="limit-bg-unlimited" class="input-dark w-full"></div>
        </div>
    </div>
    <div class="card p-6">
        <h3 class="text-red-400 font-bold mb-4">PDF Birleştirme (Günlük Limit)</h3>
        <div class="grid grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-500">Free</label><input type="number" id="limit-pdf-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500">Starter</label><input type="number" id="limit-pdf-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400">Pro</label><input type="number" id="limit-pdf-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400">Unlimited</label><input type="number" id="limit-pdf-unlimited" class="input-dark w-full"></div>
        </div>
    </div>
    <div class="card p-6">
        <h3 class="text-purple-400 font-bold mb-4">Vektörleştirici (Günlük Limit)</h3>
        <div class="grid grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-500">Free</label><input type="number" id="limit-vec-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500">Starter</label><input type="number" id="limit-vec-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400">Pro</label><input type="number" id="limit-vec-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400">Unlimited</label><input type="number" id="limit-vec-unlimited" class="input-dark w-full"></div>
        </div>
    </div>
</div>

<div id="tab-packages" class="hidden space-y-8 animate-fade-in">
    <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold text-white">Paket Ayarları</h2>
        <button onclick="savePackages()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg text-sm font-bold">Paketleri Kaydet</button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="card p-6 border-t-4 border-yellow-500">
            <h3 class="text-white font-bold mb-4">Starter</h3>
            <input type="text" id="pkg-starter-name" class="input-dark w-full mb-2" placeholder="Görünen İsim">
            <input type="text" id="pkg-starter-price" class="input-dark w-full mb-2" placeholder="Fiyat">
            <textarea id="pkg-starter-features" class="input-dark w-full h-24 text-xs" placeholder="Özellikler"></textarea>
        </div>
        <div class="card p-6 border-t-4 border-cyan-400">
            <h3 class="text-white font-bold mb-4">Pro</h3>
            <input type="text" id="pkg-pro-name" class="input-dark w-full mb-2" placeholder="Görünen İsim">
            <input type="text" id="pkg-pro-price" class="input-dark w-full mb-2" placeholder="Fiyat">
            <textarea id="pkg-pro-features" class="input-dark w-full h-24 text-xs" placeholder="Özellikler"></textarea>
        </div>
        <div class="card p-6 border-t-4 border-purple-500">
            <h3 class="text-white font-bold mb-4">Unlimited</h3>
            <input type="text" id="pkg-unlimited-name" class="input-dark w-full mb-2" placeholder="Görünen İsim">
            <input type="text" id="pkg-unlimited-price" class="input-dark w-full mb-2" placeholder="Fiyat">
            <textarea id="pkg-unlimited-features" class="input-dark w-full h-24 text-xs" placeholder="Özellikler"></textarea>
        </div>
    </div>
</div>

<div id="tab-settings" class="hidden space-y-6 animate-fade-in">
    <h2 class="text-xl font-bold text-white mb-4">Site Genel Ayarları</h2>
    
    <div class="card p-8 max-w-2xl">
        <div class="mb-6">
            <label class="block text-sm text-gray-400 mb-2">Site Başlığı (Title)</label>
            <input type="text" id="site-title" class="input-dark w-full p-3" placeholder="Botlab Tools">
        </div>
        
        <div class="mb-6">
            <label class="block text-sm text-gray-400 mb-2">WhatsApp Numarası (Destek)</label>
            <input type="text" id="site-whatsapp" class="input-dark w-full p-3" placeholder="905xxxxxxxxx">
            <p class="text-xs text-gray-500 mt-2">Uluslararası formatta, başında + olmadan yazın.</p>
        </div>

        <button onclick="saveSiteSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold w-full transition">
            Ayarları Güncelle
        </button>
    </div>
</div>

<div id="addUserModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50">
    <div class="bg-[#0c1120] p-8 rounded-2xl w-full max-w-md border border-white/10 relative">
        <button onclick="closeModal('addUserModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white">✕</button>
        <h2 class="text-xl font-bold text-white mb-4">Kullanıcı Ekle</h2>
        <form onsubmit="event.preventDefault(); handleAddUser();">
            <input type="email" id="new-user-email" class="input-dark w-full mb-3" placeholder="E-posta" required>
            <input type="date" id="new-user-end-date" class="input-dark w-full mb-3" required>
            <select id="selected-tier-input" class="input-dark w-full mb-4">
                <option value="starter">Starter</option>
                <option value="pro">Pro</option>
                <option value="unlimited">Unlimited</option>
            </select>
            <button type="submit" class="w-full bg-green-600 py-3 rounded-lg text-white font-bold">Ekle</button>
        </form>
    </div>
</div>

<script>
    const toolKeys = [
        {key: 'remove_bg', name: 'Arka Plan Silici'},
        {key: 'vektor', name: 'Vektörleştirici'},
        {key: 'image_compress', name: 'Görsel Sıkıştır'},
        {key: 'image_convert', name: 'Format Çevirici'},
        {key: 'pdf_merge', name: 'PDF Birleştir'},
        {key: 'pdf_split', name: 'PDF Böl'},
        {key: 'pdf_compress', name: 'PDF Sıkıştır'},
        {key: 'word_to_pdf', name: 'Word to PDF'},
        {key: 'qr_generator', name: 'QR Kod'},
        {key: 'logo_generator', name: 'Logo Oluşturucu'}
    ];

    window.showTab = function(tabName) {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
        
        const tab = document.getElementById('tab-' + tabName);
        if(tab) tab.classList.remove('hidden');
        const nav = document.getElementById('nav-' + tabName);
        if(nav) nav.classList.add('active');

        if(tabName === 'dashboard') fetchDashboard();
        if(tabName === 'users') fetchUsers();
        if(tabName === 'tools') { fetchTools(); fetchLimits(); }
        if(tabName === 'packages') fetchPackages();
        if(tabName === 'settings') fetchSettings();
    }

    async function fetchDashboard() {
        try {
            const res = await fetch("/api/admin/users");
            const users = await res.json();
            document.getElementById('stat-total-users').innerText = users.length;
            document.getElementById('stat-active-premium').innerText = users.filter(u => new Date(u.end_date) > new Date()).length;
        } catch(e){}
    }

    async function fetchUsers() {
        try {
            const res = await fetch("/api/admin/users");
            const users = await res.json();
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = users.map(u => `
                <tr class="border-b border-white/5 hover:bg-white/5">
                    <td class="px-6 py-4 text-white">${u.email}</td>
                    <td class="px-6 py-4"><span class="bg-gray-700 px-2 py-1 rounded text-xs uppercase">${u.tier}</span></td>
                    <td class="px-6 py-4">${u.end_date}</td>
                    <td class="px-6 py-4 text-right"><button onclick="deleteUser('${u.email}')" class="text-red-500 text-xs border border-red-500/30 px-2 py-1 rounded">Sil</button></td>
                </tr>
            `).join('');
        } catch(e){}
    }

    async function fetchTools() {
        try {
            const res = await fetch("/get_settings");
            const data = await res.json();
            const status = data.tool_status || {};
            
            const div = document.getElementById('tool-toggles-container');
            div.innerHTML = toolKeys.map(t => {
                const checked = status[t.key]?.active !== false ? 'checked' : '';
                return `
                <div class="flex items-center justify-between bg-[#02040a] p-3 rounded-lg border border-white/10">
                    <span class="text-gray-300 text-sm">${t.name}</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-${t.key}" class="sr-only peer" ${checked}>
                        <div class="w-11 h-6 bg-gray-700 peer-focus:ring-2 peer-focus:ring-indigo-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    </label>
                </div>`;
            }).join('');
        } catch(e){}
    }

    async function fetchLimits() {
        try {
            const res = await fetch("/get_settings");
            const data = await res.json();
            const l = data.limits || {};
            // Güvenli erişim fonksiyonu
            const getL = (path) => path.split('.').reduce((acc, part) => acc && acc[part], l) || 0;

            document.getElementById('limit-bg-free').value = getL('image.remove_bg.free');
            document.getElementById('limit-bg-starter').value = getL('image.remove_bg.starter');
            document.getElementById('limit-bg-pro').value = getL('image.remove_bg.pro');
            document.getElementById('limit-bg-unlimited').value = getL('image.remove_bg.unlimited');
            
            document.getElementById('limit-pdf-free').value = getL('pdf.merge.free');
            document.getElementById('limit-pdf-starter').value = getL('pdf.merge.starter');
            document.getElementById('limit-pdf-pro').value = getL('pdf.merge.pro');
            document.getElementById('limit-pdf-unlimited').value = getL('pdf.merge.unlimited');

            document.getElementById('limit-vec-free').value = getL('vector.default.free');
            document.getElementById('limit-vec-starter').value = getL('vector.default.starter');
            document.getElementById('limit-vec-pro').value = getL('vector.default.pro');
            document.getElementById('limit-vec-unlimited').value = getL('vector.default.unlimited');
        } catch(e){}
    }

    async function fetchPackages() {
        try {
            const res = await fetch("/get_settings");
            const data = await res.json();
            const p = data.packages || {};
            ['starter', 'pro', 'unlimited'].forEach(t => {
                if(p[t]) {
                    document.getElementById(`pkg-${t}-name`).value = p[t].name || '';
                    document.getElementById(`pkg-${t}-price`).value = p[t].price || '';
                    document.getElementById(`pkg-${t}-features`).value = (p[t].features || []).join(', ');
                }
            });
        } catch(e){}
    }

    async function fetchSettings() {
        try {
            const res = await fetch("/get_settings");
            const data = await res.json();
            const s = data.site || {};
            document.getElementById('site-title').value = s.title || '';
            document.getElementById('site-whatsapp').value = s.whatsapp_number || '';
        } catch(e){}
    }

    async function saveToolStatus() {
        let statuses = {};
        toolKeys.forEach(t => {
            const el = document.getElementById(`toggle-${t.key}`);
            if(el) statuses[t.key] = { active: el.checked };
        });
        await postData("/api/admin/save_tool_status", { tool_status: statuses });
    }

    async function saveLimits() {
        const limits = {
            image: { remove_bg: {
                free: parseInt(document.getElementById('limit-bg-free').value),
                starter: parseInt(document.getElementById('limit-bg-starter').value),
                pro: parseInt(document.getElementById('limit-bg-pro').value),
                unlimited: parseInt(document.getElementById('limit-bg-unlimited').value)
            }},
            pdf: { merge: {
                free: parseInt(document.getElementById('limit-pdf-free').value),
                starter: parseInt(document.getElementById('limit-pdf-starter').value),
                pro: parseInt(document.getElementById('limit-pdf-pro').value),
                unlimited: parseInt(document.getElementById('limit-pdf-unlimited').value)
            }},
            vector: { default: {
                free: parseInt(document.getElementById('limit-vec-free').value),
                starter: parseInt(document.getElementById('limit-vec-starter').value),
                pro: parseInt(document.getElementById('limit-vec-pro').value),
                unlimited: parseInt(document.getElementById('limit-vec-unlimited').value)
            }}
        };
        await postData("/api/admin/save_limits", { limits });
    }

    async function saveSiteSettings() {
        const data = {
            title: document.getElementById('site-title').value,
            whatsapp: document.getElementById('site-whatsapp').value
        };
        await postData("/api/admin/save_site_settings", data);
    }
    
    async function savePackages() {
        let packages = {};
        ['starter', 'pro', 'unlimited'].forEach(t => {
            packages[t] = {
                name: document.getElementById(`pkg-${t}-name`).value,
                price: document.getElementById(`pkg-${t}-price`).value,
                features: document.getElementById(`pkg-${t}-features`).value.split(',').map(s=>s.trim())
            };
        });
        await postData("/api/admin/save_packages", { packages });
    }

    async function postData(url, data) {
        try {
            const res = await fetch(url, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(data)
            });
            const json = await res.json();
            if(json.status === 'ok') alert("✅ Kaydedildi!");
            else alert("❌ Hata oluştu.");
        } catch(e) { alert("Sunucu hatası."); }
    }

    async function handleAddUser() {
        const email = document.getElementById('new-user-email').value;
        const end_date = document.getElementById('new-user-end-date').value;
        const tier = document.getElementById('selected-tier-input').value;
        await postData("/api/admin/add_user", {email, end_date, tier});
        closeModal('addUserModal'); fetchUsers();
    }

    async function deleteUser(email) {
        if(confirm("Silmek istediğinize emin misiniz?")) {
            await fetch(`/api/admin/delete_user/${email}`, {method: "DELETE"});
            fetchUsers();
        }
    }

    function openAddUserModalWithSettings() { openModal('addUserModal'); }

    document.addEventListener('DOMContentLoaded', () => showTab('dashboard'));
</script>

{% endblock admin_content %}
