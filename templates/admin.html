{% extends "admin_layout.html" %}

{% block title %}Admin Dashboard{% endblock title %}

{% block admin_title %}Genel Bakış{% endblock admin_title %}
{% block admin_subtitle %}Sistem İstatistikleri ve Özet Durum.{% endblock admin_subtitle %}

{% block admin_content %}

<!-- ========================================================= -->
<!-- 1. DASHBOARD SEKMESİ -->
<!-- ========================================================= -->
<div id="tab-dashboard" class="space-y-6">
    <!-- İstatistik Kartları -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="card p-5 border-l-4 border-blue-500">
            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Toplam Kullanıcı</p>
            <h3 id="stat-total-users" class="text-2xl font-bold text-white">0</h3>
        </div>
        <div class="card p-5 border-l-4 border-green-500">
            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Aktif Premium</p>
            <h3 id="stat-active-premium" class="text-2xl font-bold text-white">0</h3>
        </div>
        <div class="card p-5 border-l-4 border-amber-500">
            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Toplam Görsel İşlem</p>
            <h3 id="stat-total-images" class="text-2xl font-bold text-white">0</h3>
        </div>
        <div class="card p-5 border-l-4 border-red-500">
            <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Açık Destek Talebi</p>
            <h3 id="stat-open-tickets" class="text-2xl font-bold text-white">0</h3>
        </div>
    </div>
    
    <div class="card p-5">
        <h3 class="text-lg font-bold text-white mb-4">Son Aktiviteler</h3>
        <p class="text-gray-400 text-sm">Sistem logları ve son kullanıcı hareketleri burada listelenecektir.</p>
    </div>
</div>

<!-- ========================================================= -->
<!-- 2. KULLANICILAR & ÜYELİK SEKMESİ -->
<!-- ========================================================= -->
<div id="tab-users" class="hidden space-y-6">
    <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold text-white">Kullanıcı Yönetimi</h2>
        <button onclick="openModal('addUserModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
            + Yeni Üye Ekle
        </button>
    </div>

    <div class="card p-0 overflow-hidden">
        <table class="w-full text-sm text-left text-gray-400">
            <thead class="text-xs text-gray-200 uppercase bg-[#080b16] border-b border-white/5">
                <tr>
                    <th scope="col" class="px-6 py-3">E-posta</th>
                    <th scope="col" class="px-6 py-3">Paket</th>
                    <th scope="col" class="px-6 py-3">Bitiş Tarihi</th>
                    <th scope="col" class="px-6 py-3 text-right">İşlem</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
                <!-- JavaScript ile doldurulacak -->
                <tr><td colspan="4" class="px-6 py-4 text-center">Yükleniyor...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ========================================================= -->
<!-- 3. ARAÇ YÖNETİMİ (LİMİT AYARLARI) -->
<!-- ========================================================= -->
<!-- TOOLS & LIMITS CONTENT -->
<div id="tab-tools" class="hidden space-y-8">
    <div class="flex justify-between items-center">
        <h2 class="text-xl font-bold text-white">Paket ve Limit Ayarları</h2>
        <div class="flex gap-2">
             <button onclick="savePackagesDisplay()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold transition">Paket Görünümünü Kaydet</button>
             <button onclick="saveLimits()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg text-sm font-bold transition">Limitleri Kaydet</button>
        </div>
    </div>
    
    <!-- 1. PAKET GÖRÜNÜM AYARLARI (VİTRİN) -->
    <h3 class="text-lg font-bold text-gray-400 border-b border-white/5 pb-2">Paket Vitrin Ayarları (Fiyat & Metin)</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- STARTER EDITOR -->
        <div class="card p-4 border border-yellow-500/20 bg-yellow-500/5">
            <h3 class="text-yellow-500 font-bold mb-2 text-sm">Başlangıç Paketi</h3>
            <div class="space-y-2">
                <input type="text" id="pkg-starter-title" placeholder="Paket Adı" class="input-dark text-sm w-full">
                <div class="relative">
                    <span class="absolute left-3 top-2 text-gray-500">₺</span>
                    <input type="text" id="pkg-starter-price" placeholder="Fiyat" class="input-dark text-sm w-full pl-6">
                </div>
                <textarea id="pkg-starter-features" rows="5" class="input-dark w-full text-xs" placeholder="Özellikler (Her satıra bir tane)"></textarea>
            </div>
        </div>

        <!-- PRO EDITOR -->
        <div class="card p-4 border border-cyan-500/20 bg-cyan-500/5">
            <h3 class="text-cyan-400 font-bold mb-2 text-sm">Pro Paket</h3>
            <div class="space-y-2">
                <input type="text" id="pkg-pro-title" placeholder="Paket Adı" class="input-dark text-sm w-full">
                <div class="relative">
                    <span class="absolute left-3 top-2 text-gray-500">₺</span>
                    <input type="text" id="pkg-pro-price" placeholder="Fiyat" class="input-dark text-sm w-full pl-6">
                </div>
                <textarea id="pkg-pro-features" rows="5" class="input-dark w-full text-xs" placeholder="Özellikler"></textarea>
            </div>
        </div>

        <!-- UNLIMITED EDITOR -->
        <div class="card p-4 border border-purple-500/20 bg-purple-500/5">
            <h3 class="text-purple-400 font-bold mb-2 text-sm">Sınırsız Paket</h3>
            <div class="space-y-2">
                <input type="text" id="pkg-unlimited-title" placeholder="Paket Adı" class="input-dark text-sm w-full">
                <div class="relative">
                    <span class="absolute left-3 top-2 text-gray-500">₺</span>
                    <input type="text" id="pkg-unlimited-price" placeholder="Fiyat" class="input-dark text-sm w-full pl-6">
                </div>
                <textarea id="pkg-unlimited-features" rows="5" class="input-dark w-full text-xs" placeholder="Özellikler"></textarea>
            </div>
        </div>
    </div>

    <!-- 2. TEKNİK LİMİT AYARLARI -->
    <h3 class="text-lg font-bold text-gray-400 border-b border-white/5 pb-2 mt-8">Teknik Limit Ayarları</h3>
    
    <div class="grid grid-cols-1 gap-6">
        <!-- Dosya Boyutu -->
    <!-- Dosya Boyutu Limitleri -->
    <div class="card p-6 border border-blue-500/20 bg-blue-500/5">
        <h3 class="text-lg font-bold text-blue-400 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
            Maksimum Dosya Boyutu (MB)
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-400 block mb-1">Ücretsiz</label><input type="number" id="limit-size-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500 block mb-1">Başlangıç</label><input type="number" id="limit-size-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400 block mb-1">Pro</label><input type="number" id="limit-size-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400 block mb-1">Sınırsız</label><input type="number" id="limit-size-unlimited" class="input-dark w-full"></div>
        </div>
    </div>

    <!-- Arka Plan Silici Limitleri -->
    <div class="card p-6">
        <h3 class="text-lg font-bold text-white mb-4">Arka Plan Silici (Günlük İşlem Limiti)</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-400 block mb-1">Ücretsiz</label><input type="number" id="limit-bg-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500 block mb-1">Başlangıç</label><input type="number" id="limit-bg-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400 block mb-1">Pro</label><input type="number" id="limit-bg-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400 block mb-1">Sınırsız</label><input type="number" id="limit-bg-unlimited" class="input-dark w-full"></div>
        </div>
    </div>

    <!-- PDF Birleştirme Limitleri -->
    <div class="card p-6">
        <h3 class="text-lg font-bold text-white mb-4">PDF Birleştirme (Günlük İşlem Limiti)</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div><label class="text-xs text-gray-400 block mb-1">Ücretsiz</label><input type="number" id="limit-pdf-free" class="input-dark w-full"></div>
            <div><label class="text-xs text-yellow-500 block mb-1">Başlangıç</label><input type="number" id="limit-pdf-starter" class="input-dark w-full"></div>
            <div><label class="text-xs text-cyan-400 block mb-1">Pro</label><input type="number" id="limit-pdf-pro" class="input-dark w-full"></div>
            <div><label class="text-xs text-purple-400 block mb-1">Sınırsız</label><input type="number" id="limit-pdf-unlimited" class="input-dark w-full"></div>
        </div>
    </div>
</div>

<!-- ========================================================= -->
<!-- 4. DİĞER SEKMELER (Şimdilik Boş) -->
<!-- ========================================================= -->
<div id="tab-tickets" class="hidden space-y-6">
    <h2 class="text-xl font-bold text-white">Destek Talepleri</h2>
    <p class="text-gray-400">Henüz aktif destek talebi bulunmuyor.</p>
</div>

<div id="tab-reports" class="hidden space-y-6">
    <h2 class="text-xl font-bold text-white">Raporlar</h2>
    <p class="text-gray-400">Detaylı analizler yakında eklenecek.</p>
</div>

<div id="tab-settings" class="hidden space-y-6">
    <h2 class="text-xl font-bold text-white">Site Ayarları</h2>
    <p class="text-gray-400">Genel site yapılandırması.</p>
</div>


<!-- ========================================================= -->
<!-- MODALLER -->
<!-- ========================================================= -->

<!-- MODAL: YENİ ÜYE EKLE -->
<div id="addUserModal" class="modal-overlay hidden items-center justify-center fixed inset-0 bg-black/80 z-50">
    <div class="modal-content p-8 w-full max-w-md relative animate-fade-in shadow-2xl bg-[#0c1120] rounded-2xl border border-white/10">
        <button onclick="closeModal('addUserModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">✕</button>
        <h2 class="text-xl font-bold text-white mb-6">Yeni Premium Üye Ekle</h2>
        
        <form id="addUserForm" onsubmit="event.preventDefault(); handleAddUser();">
            <label class="block text-sm text-gray-400 mb-1">E-posta</label>
            <input type="email" id="new-user-email" placeholder="kullanici@mail.com" class="input-dark w-full text-sm mb-4" required>

            <label class="block text-sm text-gray-400 mb-1">Paket Seçimi</label>
            <select id="new-user-tier" class="input-dark w-full text-sm mb-4 bg-[#02040a] text-white border border-white/10 rounded px-3 py-2">
                <option value="starter">Başlangıç Paket</option>
                <option value="pro">Pro Paket</option>
                <option value="unlimited">Sınırsız Paket</option>
            </select>

            <label class="block text-sm text-gray-400 mb-1">Bitiş Tarihi (YYYY-MM-DD)</label>
            <input type="date" id="new-user-end-date" class="input-dark w-full text-sm mb-6" required>
            
            <p id="addUserMessage" class="text-sm text-green-400 mb-3 hidden"></p>

            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-sm transition">
                Üye Ekle
            </button>
        </form>
    </div>
</div>


<!-- ========================================================= -->
<!-- JAVASCRIPT (Veri İşlemleri) -->
<!-- ========================================================= -->
<script>
    // DASHBOARD VERİLERİNİ ÇEK
    async function fetchDashboardData() {
        try {
            const res = await fetch("/api/admin/users");
            const users = await res.json();
            
            const totalUsers = users.length;
            const activePremium = users.filter(u => new Date(u.end_date) >= new Date()).length;
            
            document.getElementById('stat-total-users').textContent = totalUsers;
            document.getElementById('stat-active-premium').textContent = activePremium;
            
            const totalImages = users.reduce((acc, user) => {
                const stats = user.usage_stats || {};
                return acc + (stats.remove_bg || 0);
            }, 0);
            
            document.getElementById('stat-total-images').textContent = totalImages;

        } catch(e) { console.error("Dashboard verileri çekilemedi:", e); }
    }

    // KULLANICI LİSTESİNİ ÇEK VE TABLOYA YAZ
    async function fetchUsers() {
        const tbody = document.getElementById('user-table-body');
        tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center">Yükleniyor...</td></tr>';
        
        try {
            const res = await fetch("/api/admin/users");
            const users = await res.json();
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">Kayıtlı premium üye bulunmamaktadır.</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const endDate = new Date(user.end_date);
                const isActive = endDate >= new Date();
                const statusClass = isActive ? 'text-green-400' : 'text-red-400';
                const statusText = isActive ? 'Aktif' : 'Süresi Dolmuş';
                
                // Tier renkleri
                let tierColor = 'bg-gray-700 text-gray-300';
                if (user.tier === 'starter') tierColor = 'bg-yellow-500/20 text-yellow-500';
                if (user.tier === 'pro') tierColor = 'bg-cyan-500/20 text-cyan-400';
                if (user.tier === 'unlimited') tierColor = 'bg-purple-500/20 text-purple-400';

                return `
                    <tr class="border-b border-white/5 hover:bg-white/5 transition">
                        <th scope="row" class="px-6 py-4 font-medium text-white whitespace-nowrap">
                            ${user.email}
                        </th>
                        <td class="px-6 py-4">
                             <span class="${tierColor} px-2 py-1 rounded text-xs font-bold uppercase">${user.tier || 'starter'}</span>
                        </td>
                        <td class="px-6 py-4 ${statusClass}">
                            ${user.end_date} <span class="text-xs">(${statusText})</span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="handleDeleteUser('${user.email}')" class="text-red-500 hover:text-red-400 font-medium ml-2 text-xs border border-red-500/30 px-2 py-1 rounded">Sil</button>
                        </td>
                    </tr>
                `;
            }).join('');
        } catch(e) {
            tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-400">Sunucu bağlantı hatası.</td></tr>';
        }
    }

    // YENİ ÜYE EKLE
    async function handleAddUser() {
        const email = document.getElementById('new-user-email').value;
        const endDate = document.getElementById('new-user-end-date').value;
        const tier = document.getElementById('new-user-tier').value;
        const msgEl = document.getElementById('addUserMessage');
        
        msgEl.classList.add('hidden');
        msgEl.classList.remove('text-red-400', 'text-green-400');

        try {
            const res = await fetch("/api/admin/add_user", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: email, end_date: endDate, tier: tier })
            });

            const data = await res.json();

            if (res.ok) {
                msgEl.textContent = data.message;
                msgEl.classList.add('text-green-400');
                document.getElementById('addUserForm').reset();
                fetchUsers(); 
                setTimeout(() => closeModal('addUserModal'), 1500);
            } else {
                msgEl.textContent = data.message || "Hata oluştu.";
                msgEl.classList.add('text-red-400');
            }
        } catch (e) {
            msgEl.textContent = "Sunucu hatası.";
            msgEl.classList.add('text-red-400');
        }
        msgEl.classList.remove('hidden');
    }

    // ÜYE SİL
    async function handleDeleteUser(email) {
        if (!confirm(`${email} kullanıcısını silmek istediğinize emin misiniz?`)) return;

        try {
            const res = await fetch(`/api/admin/delete_user/${email}`, { method: "DELETE" });
            if (res.ok) {
                fetchUsers(); 
            } else {
                alert("Silme başarısız.");
            }
        } catch (e) {
            alert("Sunucu hatası.");
        }
    }

    // LİMİT AYARLARINI ÇEK VE DOLDUR (TAB AÇILINCA)
    async function fetchSettingsAndFillInputs() {
        try {
            const res = await fetch("/get_settings");
            const data = await res.json();
            const l = data.limits;

            // Güvenli erişim için yardımcı fonksiyon
            const getVal = (obj, path, def) => path.split('.').reduce((o, p) => (o ? o[p] : def), obj) || def;

            // Dosya Boyutu
            document.getElementById('limit-size-free').value = getVal(l, 'file_size.free', 5);
            document.getElementById('limit-size-starter').value = getVal(l, 'file_size.starter', 10);
            document.getElementById('limit-size-pro').value = getVal(l, 'file_size.pro', 50);
            document.getElementById('limit-size-unlimited').value = getVal(l, 'file_size.unlimited', 100);

            // BG Remove
            document.getElementById('limit-bg-free').value = getVal(l, 'image.remove_bg.free', 2);
            document.getElementById('limit-bg-starter').value = getVal(l, 'image.remove_bg.starter', 20);
            document.getElementById('limit-bg-pro').value = getVal(l, 'image.remove_bg.pro', 200);
            document.getElementById('limit-bg-unlimited').value = getVal(l, 'image.remove_bg.unlimited', 9999);

            // PDF Merge
            document.getElementById('limit-pdf-free').value = getVal(l, 'pdf.merge.free', 2);
            document.getElementById('limit-pdf-starter').value = getVal(l, 'pdf.merge.starter', 10);
            document.getElementById('limit-pdf-pro').value = getVal(l, 'pdf.merge.pro', 50);
            document.getElementById('limit-pdf-unlimited').value = getVal(l, 'pdf.merge.unlimited', 9999);

        } catch(e) { console.error(e); }
    }

    // LİMİTLERİ KAYDET
    async function saveLimits() {
        const limits = {
            file_size: {
                free: parseInt(document.getElementById('limit-size-free').value),
                starter: parseInt(document.getElementById('limit-size-starter').value),
                pro: parseInt(document.getElementById('limit-size-pro').value),
                unlimited: parseInt(document.getElementById('limit-size-unlimited').value)
            },
            image: {
                remove_bg: {
                    free: parseInt(document.getElementById('limit-bg-free').value),
                    starter: parseInt(document.getElementById('limit-bg-starter').value),
                    pro: parseInt(document.getElementById('limit-bg-pro').value),
                    unlimited: parseInt(document.getElementById('limit-bg-unlimited').value)
                }
            },
            pdf: {
                merge: {
                    free: parseInt(document.getElementById('limit-pdf-free').value),
                    starter: parseInt(document.getElementById('limit-pdf-starter').value),
                    pro: parseInt(document.getElementById('limit-pdf-pro').value),
                    unlimited: parseInt(document.getElementById('limit-pdf-unlimited').value)
                }
            },
            vector: { default: {free: 0, starter: 0, pro: 10, unlimited: 9999} }
        };

        const res = await fetch("/api/admin/save_limits", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ limits: limits })
        });
        
        if(res.ok) alert("Ayarlar başarıyla kaydedildi!");
        else alert("Hata oluştu.");
    }

    // LAYOUT'TAN ÇAĞRILACAK FONKSİYONLAR (Global Scope'a ekle)
    window.fetchUsers = fetchUsers;
    window.fetchDashboardData = fetchDashboardData;
    window.handleAddUser = handleAddUser;
    window.handleDeleteUser = handleDeleteUser;
    window.saveLimits = saveLimits;

    // Tools sekmesine tıklandığında verileri çek (Event Listener mantığı)
    // Bu kısım admin_layout.html'deki showTab içinde halledilmeli
    // Ancak burada da manuel bir hook ekleyebiliriz.
    const originalShowTab = window.showTab; 
    window.showTab = function(tabName) {
        // Layout'taki fonksiyonu çağır (eğer varsa, yoksa layout güncellenmeli)
        // Basit çözüm: Eğer tab 'tools' ise fetchSettings çağır
        if (tabName === 'tools') fetchSettingsAndFillInputs();
        
        // Layout'taki dom manipülasyonu (Layout'u güncellemediysek buraya ekleyelim)
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
        const tabElement = document.getElementById('tab-' + tabName);
        if(tabElement) tabElement.classList.remove('hidden');
        const navElement = document.getElementById('nav-' + tabName);
        if(navElement) navElement.classList.add('active');
        
        if(tabName === 'dashboard') fetchDashboardData();
        if(tabName === 'users') fetchUsers();
    }

</script>

{% endblock admin_content %}
