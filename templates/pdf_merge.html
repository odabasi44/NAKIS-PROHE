{% extends "base.html" %}

{% block title %}PDF BirleÅŸtirici{% endblock title %}

{% block head_extra %}
<style>
    .upload-area:hover, .upload-area.dragover { border-color:#ef4444; background: rgba(239,68,68,.06); }
</style>
{% endblock head_extra %}

{% block content %}
<main class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8 py-10">
    <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-white">PDF BirleÅŸtir</h1>
        <p class="mt-2 text-gray-400">Dosya seÃ§ â†’ listele â†’ birleÅŸtir â†’ indir.</p>
    </div>

    <div id="status-bar" class="glass rounded-2xl p-4 mb-6 flex items-center justify-between border border-white/5">
        <div class="flex items-center gap-3">
            <span id="status-icon" class="h-2 w-2 rounded-full bg-gray-500 animate-pulse"></span>
            <div id="limit-info" class="text-sm text-gray-300">Limit kontrol ediliyor...</div>
        </div>
        <div class="text-xs text-gray-500">PDF (multi)</div>
    </div>

    <div class="glass rounded-2xl p-6 relative overflow-hidden">
        <div id="dropZone" class="upload-area rounded-xl p-10 text-center cursor-pointer">
            <input type="file" id="fileInput" accept=".pdf" multiple class="hidden" />
            <div class="mx-auto mb-3 h-14 w-14 rounded-2xl bg-red-500/10 text-red-300 flex items-center justify-center">
                <svg class="h-7 w-7" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <div class="text-white font-bold text-lg">PDF dosyalarÄ±nÄ± ekle</div>
            <div class="mt-1 text-sm text-gray-400">tÄ±kla seÃ§ / sÃ¼rÃ¼kle</div>
            <button id="select-btn" type="button" class="mt-5 inline-flex items-center justify-center rounded-xl bg-red-600 hover:bg-red-700 transition px-6 py-2.5 font-bold text-white">
                Dosya SeÃ§
            </button>
        </div>

        <div id="loading" class="hidden absolute inset-0 bg-[#0c1120]/90 z-20 flex flex-col items-center justify-center backdrop-blur-sm">
            <div class="w-14 h-14 border-4 border-red-500/30 border-t-red-500 rounded-full animate-spin mb-3"></div>
            <div class="text-white font-semibold">BirleÅŸtiriliyor...</div>
        </div>

        <div class="mt-6">
            <div class="flex items-center justify-between">
                <div class="text-sm font-bold text-white">SÄ±ralama</div>
                <div class="text-xs text-gray-500">En az 2 PDF</div>
            </div>
            <div id="fileList" class="mt-3 space-y-2 text-sm text-gray-300">
                <div class="text-gray-500">HenÃ¼z dosya yok.</div>
            </div>
        </div>

        <button id="mergeBtn" type="button" class="mt-6 w-full rounded-xl bg-white text-black font-bold py-3 hover:bg-gray-200 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            PDF'leri BirleÅŸtir
        </button>

        <div id="result-area" class="hidden mt-6 rounded-xl border border-green-500/20 bg-green-500/10 p-4 text-center">
            <div class="text-green-200 font-bold">âœ… HazÄ±r</div>
            <div class="mt-1 text-xs text-gray-300">BirleÅŸtirilmiÅŸ PDF indirilebilir.</div>
            <a id="downloadBtn" class="mt-4 inline-flex items-center justify-center rounded-xl bg-green-600 hover:bg-green-700 transition px-6 py-2.5 font-bold text-white" href="#" download="birlestirilmis.pdf">
                PDF'i Ä°ndir
            </a>
        </div>
    </div>
</main>

<script>
    let files = [];
    let userStatus = { allowed: false };

    // 1. Limit Kontrol
    async function checkLimit() {
        const infoEl = document.getElementById('limit-info');
        const iconEl = document.getElementById('status-icon');
        
        try {
            const res = await fetch('/api/check_tool_status/pdf/merge');
            const data = await res.json();
            userStatus = data;

            if (data.allowed) {
                iconEl.className = "h-2 w-2 rounded-full bg-green-500";
                if (data.premium) {
                    infoEl.innerHTML = `ðŸ’Ž Premium Aktif`;
                } else {
                    infoEl.innerHTML = `âœ… Kalan Hak: <span class="text-green-400">${data.left}</span>`;
                }
            } else {
                iconEl.className = "h-2 w-2 rounded-full bg-red-500";
                infoEl.innerHTML = `â›” Limit Doldu. <a onclick="openModal('premiumModal')" class="text-blue-400 cursor-pointer">Premium Al</a>`;
            }
        } catch (e) { console.error(e); }
    }

    // 2. Dosya SeÃ§imi
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const loadingEl = document.getElementById('loading');
    const mergeBtn = document.getElementById('mergeBtn');

    document.getElementById('select-btn').addEventListener('click', () => {
        if(userStatus.allowed) fileInput.click();
        else openModal('premiumModal');
    });

    dropZone.addEventListener('click', () => {
        if (userStatus.allowed) fileInput.click();
        else openModal('premiumModal');
    });
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (!userStatus.allowed) return openModal('premiumModal');
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleFiles(fileList) {
        const arr = Array.from(fileList || []).filter(f => String(f.name || '').toLowerCase().endsWith('.pdf'));
        if (!arr.length) return;
        files = arr;
        document.getElementById('result-area').classList.add('hidden');
        renderFileList();
    }

    function renderFileList() {
        const list = document.getElementById('fileList');
        if (!files.length) {
            list.innerHTML = '<div class="text-gray-500">HenÃ¼z dosya yok.</div>';
            mergeBtn.disabled = true;
            return;
        }
        list.innerHTML = files.map((f, i) => `
            <div class="rounded-xl border border-white/10 bg-white/5 p-3 flex items-center justify-between">
                <div class="truncate"><span class="text-gray-400 mr-2">${i+1}.</span> ${f.name}</div>
                <div class="text-[10px] text-gray-500">${(f.size/1024).toFixed(0)} KB</div>
            </div>
        `).join('');
        mergeBtn.disabled = files.length < 2 || !userStatus.allowed;
    }

    // 3. BirleÅŸtirme Ä°ÅŸlemi
    async function mergePDFs() {
        if (files.length < 2) return;
        if (!userStatus.allowed) return openModal('premiumModal');

        mergeBtn.innerText = "BirleÅŸtiriliyor...";
        mergeBtn.disabled = true;
        loadingEl.classList.remove('hidden');

        const formData = new FormData();
        files.forEach(file => formData.append('pdf_files', file));

        try {
            const res = await fetch('/api/pdf/merge', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            loadingEl.classList.add('hidden');
            mergeBtn.innerText = "PDF'leri BirleÅŸtir";
            mergeBtn.disabled = false;

            if (data.success) {
                document.getElementById('result-area').classList.remove('hidden');
                const link = document.getElementById('downloadBtn');
                link.href = "data:application/pdf;base64," + data.file;
                link.download = "birlestirilmis_botlab.pdf";
                
                checkLimit(); // Limiti gÃ¼ncelle
            } else {
                alert("Hata: " + (data.message || data.reason));
                if (data.reason === 'limit') openModal('premiumModal');
            }

        } catch (e) {
            alert("Sunucu hatasÄ±.");
            loadingEl.classList.add('hidden');
            mergeBtn.innerText = "Tekrar Dene";
            mergeBtn.disabled = false;
        }
    }

    document.addEventListener('DOMContentLoaded', checkLimit);
    mergeBtn.addEventListener('click', mergePDFs);
</script>
{% endblock content %}
