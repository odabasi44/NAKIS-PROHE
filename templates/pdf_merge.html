{% extends "base.html" %}

{% block title %}PDF BirleÅŸtirici{% endblock title %}

{% block head_extra %}
<style>
    .upload-area {
        background: rgba(17, 24, 39, 0.6);
        border: 2px dashed rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }
    .upload-area:hover {
        border-color: #ef4444; /* PDF iÃ§in kÄ±rmÄ±zÄ± tema */
        background: rgba(239, 68, 68, 0.05);
    }
    .file-item {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
    }
</style>
{% endblock head_extra %}

{% block content %}
<div class="max-w-3xl mx-auto py-10">

    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-white mb-4">PDF BirleÅŸtirici</h1>
        <p class="text-gray-400">Birden fazla PDF dosyasÄ±nÄ± tek bir belgede hÄ±zlÄ±ca birleÅŸtirin.</p>
    </div>

    <!-- Limit Durum Ã‡ubuÄŸu -->
    <div id="status-bar" class="bg-[#0c1120] border border-white/5 rounded-xl p-4 mb-8 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div id="status-icon" class="w-2 h-2 rounded-full bg-gray-500 animate-pulse"></div>
            <span id="limit-info" class="text-sm font-medium text-gray-300">Limit kontrol ediliyor...</span>
        </div>
    </div>

    <!-- YÃ¼kleme AlanÄ± -->
    <div class="bg-[#0c1120] border border-white/5 rounded-2xl p-8">
        
        <div id="dropZone" class="upload-area rounded-xl p-10 text-center cursor-pointer">
            <input type="file" id="fileInput" accept=".pdf" multiple class="hidden">
            
            <div class="mb-4 mx-auto w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center text-red-500">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            </div>
            
            <h3 class="text-xl font-bold text-white mb-2">PDF DosyalarÄ±nÄ± SeÃ§in</h3>
            <button id="select-btn" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition mt-2">
                DosyalarÄ± GÃ¶zat
            </button>
        </div>

        <!-- SeÃ§ilen Dosyalar Listesi -->
        <div id="fileList" class="mt-6 space-y-2 hidden">
            <h4 class="text-sm text-gray-400 mb-2">BirleÅŸtirilecek Dosyalar:</h4>
            <!-- JS ile doldurulacak -->
        </div>

        <button id="mergeBtn" onclick="mergePDFs()" class="hidden w-full mt-6 py-3 bg-white text-black font-bold rounded-lg hover:bg-gray-200 transition">
            PDF'leri BirleÅŸtir
        </button>

        <!-- SonuÃ§ -->
        <div id="result-area" class="hidden mt-6 text-center p-4 bg-green-500/10 border border-green-500/20 rounded-xl">
            <p class="text-green-400 font-bold mb-2">âœ… BaÅŸarÄ±yla BirleÅŸtirildi!</p>
            <a id="downloadLink" class="inline-block px-6 py-2 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition">
                BirleÅŸmiÅŸ PDF'i Ä°ndir
            </a>
        </div>
    </div>

</div>

<script>
    let selectedFiles = [];
    let userStatus = { allowed: false };

    // 1. Limit Kontrol
    async function checkLimit() {
        const infoEl = document.getElementById('limit-info');
        const iconEl = document.getElementById('status-icon');
        
        try {
            const res = await fetch('/api/check_tool_status/pdf/merge');
            const data = await res.json();
            userStatus = data;

            if (data.allowed) {
                iconEl.className = "w-2 h-2 rounded-full bg-green-500";
                if (data.premium) {
                    infoEl.innerHTML = `ðŸ’Ž Premium Aktif`;
                } else {
                    infoEl.innerHTML = `âœ… Kalan Hak: <span class="text-green-400">${data.left}</span>`;
                }
            } else {
                iconEl.className = "w-2 h-2 rounded-full bg-red-500";
                infoEl.innerHTML = `â›” Limit Doldu. <a onclick="openPremium()" class="text-blue-400 cursor-pointer">Premium Al</a>`;
            }
        } catch (e) { console.error(e); }
    }

    // 2. Dosya SeÃ§imi
    const fileInput = document.getElementById('fileInput');
    document.getElementById('select-btn').addEventListener('click', () => {
        if(userStatus.allowed) fileInput.click();
        else openPremium();
    });

    fileInput.addEventListener('change', (e) => {
        selectedFiles = Array.from(e.target.files);
        renderFileList();
    });

    function renderFileList() {
        const list = document.getElementById('fileList');
        const btn = document.getElementById('mergeBtn');
        
        list.innerHTML = '<h4 class="text-sm text-gray-400 mb-2">SÄ±ralama:</h4>';
        
        if (selectedFiles.length > 0) {
            list.classList.remove('hidden');
            selectedFiles.forEach((file, index) => {
                list.innerHTML += `
                    <div class="file-item p-3 rounded flex justify-between items-center text-sm text-gray-300">
                        <span>ðŸ“„ ${file.name}</span>
                        <span class="text-xs text-gray-500">${(file.size/1024).toFixed(1)} KB</span>
                    </div>
                `;
            });
        }
        
        if (selectedFiles.length >= 2) btn.classList.remove('hidden');
        else btn.classList.add('hidden');
    }

    // 3. BirleÅŸtirme Ä°ÅŸlemi
    async function mergePDFs() {
        const btn = document.getElementById('mergeBtn');
        btn.innerText = "Ä°ÅŸleniyor...";
        btn.disabled = true;

        const formData = new FormData();
        selectedFiles.forEach(file => formData.append('pdf_files', file));

        try {
            const res = await fetch('/api/pdf/merge', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            btn.innerText = "PDF'leri BirleÅŸtir";
            btn.disabled = false;

            if (data.success) {
                document.getElementById('result-area').classList.remove('hidden');
                const link = document.getElementById('downloadLink');
                link.href = "data:application/pdf;base64," + data.file;
                link.download = "birlestirilmis_botlab.pdf";
                
                checkLimit(); // Limiti gÃ¼ncelle
            } else {
                alert("Hata: " + data.message || data.reason);
            }

        } catch (e) {
            alert("Sunucu hatasÄ±.");
            btn.innerText = "Tekrar Dene";
            btn.disabled = false;
        }
    }

    document.addEventListener('DOMContentLoaded', checkLimit);
</script>
{% endblock content %}
