{% extends "base.html" %}

{% block title %}Word to PDF{% endblock title %}

{% block head_extra %}
<style>
    .upload-area:hover, .upload-area.dragover { border-color:#3b82f6; background: rgba(59,130,246,.06); }
</style>
{% endblock head_extra %}

{% block content %}
<main class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8 py-10">
    <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-white">Word → PDF</h1>
        <p class="mt-2 text-gray-400">DOC/DOCX seç → dönüştür → indir.</p>
    </div>

    <div id="status-bar" class="glass rounded-2xl p-4 mb-6 flex items-center justify-between border border-white/5">
        <div class="flex items-center gap-3">
            <span id="status-icon" class="h-2 w-2 rounded-full bg-gray-500 animate-pulse"></span>
            <div id="limit-info" class="text-sm text-gray-300">Limitler kontrol ediliyor...</div>
        </div>
        <div class="text-xs text-gray-500">LibreOffice gerekir</div>
    </div>

    <div class="glass rounded-2xl p-6 relative overflow-hidden">
        <div id="dropZone" class="upload-area rounded-xl p-10 text-center cursor-pointer">
            <input type="file" id="fileInput" accept=".doc,.docx" class="hidden" />
            <div class="mx-auto mb-3 h-14 w-14 rounded-2xl bg-blue-500/10 text-blue-300 flex items-center justify-center">
                <svg class="h-7 w-7" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <div class="text-white font-bold text-lg">Word dosyası seç</div>
            <div id="fileName" class="mt-2 text-xs text-gray-500">.doc / .docx</div>
            <button type="button" class="mt-5 inline-flex items-center justify-center rounded-xl bg-blue-600 hover:bg-blue-700 transition px-6 py-2.5 font-bold text-white">
                Dosya Seç
            </button>
        </div>

        <button id="convertBtn" type="button" class="mt-6 w-full rounded-xl bg-white text-black font-bold py-3 hover:bg-gray-200 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            PDF'e Çevir
        </button>

        <div id="loading" class="hidden absolute inset-0 bg-[#0c1120]/90 z-20 flex flex-col items-center justify-center backdrop-blur-sm">
            <div class="w-14 h-14 border-4 border-blue-500/30 border-t-blue-500 rounded-full animate-spin mb-3"></div>
            <div class="text-white font-semibold">Dönüştürülüyor...</div>
        </div>
    </div>
</main>

<script>
    let userAllowed = false;
    let file = null;

    const el = {
        drop: document.getElementById('dropZone'),
        input: document.getElementById('fileInput'),
        name: document.getElementById('fileName'),
        btn: document.getElementById('convertBtn'),
        loading: document.getElementById('loading'),
        statusIcon: document.getElementById('status-icon'),
        limitInfo: document.getElementById('limit-info'),
    };

    async function checkLimit() {
        try {
            const res = await fetch('/api/check_tool_status/pdf/word_to_pdf');
            const data = await res.json();
            userAllowed = !!data.allowed;
            if (data.allowed) {
                el.statusIcon.className = "h-2 w-2 rounded-full bg-green-500";
                el.limitInfo.innerHTML = `Kalan Hakkınız: <span class="text-green-400 font-bold">${data.premium ? 'Sınırsız' : data.left}</span>`;
                el.btn.disabled = !file;
            } else {
                el.statusIcon.className = "h-2 w-2 rounded-full bg-red-500";
                el.limitInfo.innerHTML = `⛔ Limit Doldu. <a onclick="openModal('premiumModal')" class="text-blue-400 cursor-pointer">Premium Al</a>`;
                el.btn.disabled = true;
            }
        } catch (e) {
            console.error(e);
        }
    }

    function handleFile(f) {
        if (!f) return;
        const lower = String(f.name || '').toLowerCase();
        if (!lower.endsWith('.doc') && !lower.endsWith('.docx')) return;
        file = f;
        el.name.textContent = f.name;
        el.btn.disabled = !userAllowed;
    }

    function setBusy(b) {
        el.loading.classList.toggle('hidden', !b);
        el.btn.disabled = b || !file || !userAllowed;
        el.btn.textContent = b ? 'Dönüştürülüyor...' : "PDF'e Çevir";
    }

    async function convert() {
        if (!file) return alert('Lütfen Word dosyası seçin.');
        if (!userAllowed) return openModal('premiumModal');

        setBusy(true);
        const formData = new FormData();
        formData.append('word_file', file);
        try {
            const res = await fetch('/api/word_to_pdf', { method: 'POST', body: formData });
            const data = await res.json();
            setBusy(false);
            if (data.success) {
                // Şu an backend pasif; ileride burası PDF indirmeye döner.
                alert('PDF hazır.');
            } else {
                alert(data.message || 'Dönüştürme yapılamadı.');
            }
        } catch (e) {
            setBusy(false);
            alert('Sunucu hatası.');
        }
    }

    el.drop.addEventListener('click', () => userAllowed ? el.input.click() : openModal('premiumModal'));
    el.input.addEventListener('change', (e) => handleFile(e.target.files?.[0]));
    el.drop.addEventListener('dragover', (e) => { e.preventDefault(); el.drop.classList.add('dragover'); });
    el.drop.addEventListener('dragleave', () => el.drop.classList.remove('dragover'));
    el.drop.addEventListener('drop', (e) => { e.preventDefault(); el.drop.classList.remove('dragover'); if (userAllowed) handleFile(e.dataTransfer.files?.[0]); else openModal('premiumModal'); });
    el.btn.addEventListener('click', convert);

    document.addEventListener('DOMContentLoaded', checkLimit);
</script>
{% endblock content %}
